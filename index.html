
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mischa Taylor's Coding Blog</title>
  <meta name="author" content="Mischa Taylor">

  
  <meta name="description" content="Iteration #13 - Install Test Kitchen Testing Iteration #13 - Show the Test Kitchen version Iteration #14 - Create a Kitchen YAML file Testing &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://misheska.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mischa Taylor's Coding Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38545837-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mischa Taylor's Coding Blog</a></h1>
  
    <h2>On the edge of time and reason</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:misheska.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/contact">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/06/getting-started-writing-chef-cookbooks-the-berkshelf-way-part3/">Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-06T12:46:00-07:00" pubdate data-updated="true">Aug 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#iteration-13---install-test-kitchen">Iteration #13 - Install Test Kitchen</a>    <ul>
      <li><a href="#testing-iteration-13---show-the-test-kitchen-version">Testing Iteration #13 - Show the Test Kitchen version</a></li>
    </ul>
  </li>
  <li><a href="#iteration-14---create-a-kitchen-yaml-file">Iteration #14 - Create a Kitchen YAML file</a>    <ul>
      <li><a href="#testing-iteration-14---provision-with-test-kitchen">Testing Iteration #14 - Provision with Test Kitchen</a></li>
    </ul>
  </li>
</ul>

<p>NOTE: Preview for beta testers to review…</p>

<p>This is the third article in a series on writing Opscode Chef cookbooks the
Berkshelf Way.  Here’s a link to <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a> and
<a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>.  The source code examples covered in this
article can be found on Github: <a href="https://github.com/misheska/myface">https://github.com/misheska/myface</a></p>

<p>In this installment, we’re going to learn how to use Test Kitchen to 
automate all the verification steps we did by hand for each iteration in
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a> and
<a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>.  If not anything else, it’s worth learning
Test Kitchen because OpsCode, the company that makes Chef, has encouraged the
use of Test Kitchen to verify community cookbooks.</p>

<p>Test Kitchen is built on top of vagrant and supplements the <code>Vagrantfile</code> file
you have been using so far in this series to do local automated testing.  The
main benefit to Test Kitchen is that it makes it easy to run tests on multiple
platforms in parallel, which is more difficult to do with just a <code>Vagrantfile</code>.
We’ll be showcasing this aspect of Test Kitchen by ensuring that Myface works
on both the CentOS 6.4 and Ubuntu 12.04 Linux distributions.</p>

<h1 id="iteration-13---install-test-kitchen">Iteration #13 - Install Test Kitchen</h1>
<p>Edit <code>myface/Gemfile</code> and add the following line to load the
Test Kitchen gem:</p>

<pre><code>gem 'test-kitchen', '~&gt; 1.0.0.beta.2'
</code></pre>

<p>Your <code>myface/Gemfile</code> should look like the following after editing:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/Gemfile  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;berkshelf&#39;</span>
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;test-kitchen&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.0.0.beta.2&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Test Kitchen is in beta release and is still evolving rapidly.  The
1.0.0.beta.2 version constraint will ensure that you are using the latest
stable prerelease version.</p>

<p>After you have updated the <code>Gemfile</code> run <code>bundle install</code> to download the
test-kitchen gem and all its dependencies:</p>

<pre><code>$ bundle install
Fetching gem metadata from https://rubygems.org/........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using i18n (0.6.4)
Using multi_json (1.7.8)
Using activesupport (3.2.14)
...
Installing test-kitchen (1.0.0.beta.2)
Using bundler (1.3.5)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<h2 id="testing-iteration-13---show-the-test-kitchen-version">Testing Iteration #13 - Show the Test Kitchen version</h2>

<p>If everything worked properly you should be able to run the <code>kitchen --version</code>
command to see your installed Test Kitchen’s version information</p>

<pre><code>$ kitchen --version
Test Kitchen version 1.0.0.beta.2
</code></pre>

<h1 id="iteration-14---create-a-kitchen-yaml-file">Iteration #14 - Create a Kitchen YAML file</h1>
<p>In order to use Test Kitchen on a cookbook, first you need to add a few more
dependencies and create a template Kitchen YAML file.  Test Kitchen makes this
easy by providing the <code>kitchen init</code> command to perform all these
initialization steps automatically </p>

<pre><code>$ kitchen init
      create  .kitchen.yml
      append  Thorfile
      create  test/integration/default
      append  .gitignore
      append  .gitignore
      append  Gemfile
You must run 'bundle install' to fetch any new gems.
</code></pre>

<p>Since <code>kitchen init</code> modified your Gemfile, you need to re-run <code>bundle install</code>
(as suggested above) to pick up the new gem dependencies:</p>

<pre><code>$ bundle install
Fetching gem metadata from https://rubygems.org/........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using i18n (0.6.4)
Using multi_json (1.7.8)
Using activesupport (3.2.14)
...
Using safe_yaml (0.9.5)
Using test-kitchen (1.0.0.beta.2)
Installing kitchen-vagrant (0.11.0)
Using bundler (1.3.5)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<p>Most importantly, this new <code>bundle install</code> pass installed the
<code>kitchen-vagrant</code> vagrant driver for Test Kitchen.</p>

<p>Now that you have created a <code>.kitchen.yml</code> Kitchen YAML file and loaded all
the necessary gems, let’s customize the file so that we’ll use 
to verify that the Myface cookbook works on CentOS 6.4, like we were doing in
the previous installments with the <code>Vagrantfile</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/.kitchen.yml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="nn">---</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">require_chef_omnibus</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">platforms</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">centos-6.4</span>
</span><span class="line">  <span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">box</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">misheska-centos64</span>
</span><span class="line">    <span class="l-Scalar-Plain">box_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-centos64.box</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">suites</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class="line">  <span class="l-Scalar-Plain">run_list</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;recipe[myface]&quot;</span><span class="p-Indicator">]</span>
</span><span class="line">  <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">mysql</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">server_root_password</span><span class="p-Indicator">:</span> <span class="s">&quot;rootpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_debian_password</span><span class="p-Indicator">:</span> <span class="s">&quot;debpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_repl_password</span><span class="p-Indicator">:</span> <span class="s">&quot;replpass&quot;</span> <span class="p-Indicator">}</span> <span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Everything in the YAML file should be straightforward to understand, except
perhaps the <code>attributes</code> item in the <code>suites</code> stanza.  These values 
came from the <code>Vagrantfile</code> we used in the previous installments of this
series.  Here’s an excerpt from the <code>Vagrantfile</code> - at the end are some
values that Berkshelf initialzed (which we used in
<a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>).</p>

<pre><code>...
  config.vm.provision :chef_solo do |chef|
    chef.json = {
      :mysql =&gt; {
        :server_root_password =&gt; 'rootpass',
        :server_debian_password =&gt; 'debpass',
        :server_repl_password =&gt; 'replpass'
      }
    }

   chef.run_list = [
        "recipe[myface::default]"
    ]
  end
end
</code></pre>

<p>Those <code>Vagrantfile</code> attributes were just converted into a format that the
Test Kitchen YAML file format finds acceptable.</p>

<h2 id="testing-iteration-14---provision-with-test-kitchen">Testing Iteration #14 - Provision with Test Kitchen</h2>

<p>You can do nearly everything that you were doing with vagrant just using Test
Kitchen.  The Test Kitchen equivalent of the <code>vagrant up</code> command is 
<code>kitchen setup</code>.  Try running the <code>kitchen setup</code> command now to verify that
your <code>.kitchen.yml</code> file is valid.  When you run <code>kitchen setup</code> it will
spin up a CentOS 6.4 vagrant test node instance and use Chef Solo to provision
the MyFace cookbook on the test node:</p>

<pre><code>$ kitchen setup
-----&gt; Starting Kitchen (v1.0.0.beta.2)
-----&gt; Creating &lt;default-centos-64&gt;
       [kitchen::driver::vagrant command] BEGIN (vagrant up --no-provision)
       Bringing machine 'default' up with 'virtualbox' provider...
       [default] Importing base box 'misheska-centos64'...
       [default] Matching MAC address for NAT networking...
       [default] Setting the name of the VM...
       [default] Clearing any previously set forwarded ports...
       [Berkshelf] Skipping Berkshelf with --no-provision
       [default] Fixed port collision for 22 =&gt; 2222. Now on port 2200.
       [default] Creating shared folders metadata...
       [default] Clearing any previously set network interfaces...
       [default] Preparing network interfaces based on configuration...
       [default] Forwarding ports...
       [default] -- 22 =&gt; 2200 (adapter 1)
       [default] Running 'pre-boot' VM customizations...
       [default] Booting VM...
       [default] Waiting for VM to boot. This can take a few minutes.
       [default] VM booted and ready for use!
       [default] Setting hostname...
       [default] Mounting shared folders...
       [default] -- /vagrant
       [kitchen::driver::vagrant command] END (0m39.38s)
       [kitchen::driver::vagrant command] BEGIN (vagrant ssh-config)
       [kitchen::driver::vagrant command] END (0m2.85s)
       Vagrant instance &lt;default-centos-64&gt; created.
       Finished creating &lt;default-centos-64&gt; (0m46.19s).
-----&gt; Converging &lt;default-centos-64&gt;
-----&gt; Installing Chef Omnibus (true)
       --2013-08-07 07:25:35--  https://www.opscode.com/chef/install.sh
Resolving www.opscode.com...        184.106.28.82
       Connecting to www.opscode.com|184.106.28.82|:443...
       connected.
HTTP request sent, awaiting response...        200 OK
       Length: 6790 (6.6K) [application/x-sh]
       Saving to: “STDOUT”

 0% [                                       ] 0           --.-K/s
100%[======================================&gt;] 6,790       --.-K/s   in 0s
 
       2013-08-07 07:25:40 (461 MB/s) - written to stdout [6790/6790]

       Downloading Chef  for el...
       Installing Chef
       warning: /tmp/tmp.wAJrUjYo/chef-.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY
Preparing...                #####  ########################################### [100%]
   1:chef                          ########################################### [100%]
       Thank you for installing Chef!
       Resolving cookbook dependencies with Berkshelf
Using myface (2.0.0)
...
       Recipe: apache2::default
         * service[apache2] action restart[2013-08-07T07:28:54+00:00] INFO: Processing service[apache2] action restart (apache2::default line 221)
       [2013-08-07T07:28:55+00:00] INFO: service[apache2] restarted

           - restart service service[apache2]

       [2013-08-07T07:28:55+00:00] INFO: Chef Run complete in 162.083058446 seconds
       [2013-08-07T07:28:55+00:00] INFO: Running report handlers
       [2013-08-07T07:28:55+00:00] INFO: Report handlers complete
       Chef Client finished, 97 resources updated
       Finished converging &lt;default-centos-64&gt; (3m20.62s).
-----&gt; Setting up &lt;default-centos-64&gt;
       Finished setting up &lt;default-centos-64&gt; (0m0.00s).
-----&gt; Kitchen is finished. (4m11.93s)
</code></pre>

<p>To display the results of the Chef Run, type in the <code>kitchen list</code> command:</p>

<pre><code>$ kitchen list
Instance           Driver   Provisioner  Last Action
default-centos-64  Vagrant  Chef Solo    Set Up
</code></pre>

<p>If the run succeeded, it should display <code>Set Up</code> in the <code>Last Action</code> field.</p>

<p>The Test Kitchen equivalent of the <code>vagrant ssh</code> command is <code>kitchen login</code>.
Since Test Kitchen supports multiple instances, you will need to pass in
the instance name for which you wish to login as a parameter (which you can
get from the <code>kitchen list</code> output).  We want to login to the CentOS 6.4
instance (the only instance for now), so type in the command
<code>kitchen login default-centos-64</code> to login:</p>

<pre><code>$ kitchen login default-centos-64
Last login: Wed Aug  7 07:39:31 2013 from 10.0.2.2
[vagrant@default-centos-64 ~]$
</code></pre>

<p>Now you can poke around in the image the same way you did with <code>vagrant ssh</code>,
for example, verifying that the httpd server is running:</p>

<pre><code>[vagrant@default-centos-64 ~]$ sudo /sbin/service httpd status
httpd (pid  3737) is running...
</code></pre>

<p>After you are done working in the test instance, make sure to run the
<code>exit</code> command to log out so that you return back to your host prompt:</p>

<pre><code>[vagrant@default-centos-64 ~]$ exit
logout
Connection to 127.0.0.1 closed.
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/28/windows-server-2012-automated-install-settings/">Windows Server 2012 Automated Install Settings</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-28T20:20:00-07:00" pubdate data-updated="true">Jul 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#disabling-the-language-settings-dialog">Disabling the language settings dialog</a></li>
  <li><a href="#disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</a></li>
  <li><a href="#disabling-the-eula-dialog">Disabling the EULA dialog</a></li>
  <li><a href="#disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</a></li>
  <li><a href="#disabling-the-administrator-password-prompt">Disabling the Administrator password prompt</a></li>
  <li><a href="#set-up-vagrant-autologin">Set up vagrant autologin</a></li>
  <li><a href="#do-not-show-server-manager-at-logon">Do not show Server Manager at logon</a></li>
  <li><a href="#disable-user-account-control-uac">Disable User Account Control (UAC)</a></li>
  <li><a href="#disable-internet-explorer-enhanced-security-configuration">Disable Internet Explorer Enhanced Security Configuration</a></li>
  <li><a href="#disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</a></li>
  <li><a href="#replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</a></li>
  <li><a href="#enable-remote-desktop">Enable Remote Desktop</a></li>
  <li><a href="#turn-off-computer-password">Turn off computer password</a></li>
  <li><a href="#turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</a></li>
</ul>

<p>I just recently revised all my automated install XML files for the Windows
System Preparation Tool (Sysprep) that I use for my Windows development
testbed.  For this go around, I’m documenting the XML answer file settings
for each version of Microsoft Windows.  This article covers the XML answer
files settings needed to automate a Windows Server 2012 (64-bit) base
OS install.</p>

<p>You’ll need to use the Windows System Image Manager tool to edit Sysprep
XML answer files.  The Windows System Image Manager is packaged with the
<a href="http://www.microsoft.com/en-us/download/details.aspx?id=30652">Windows Assessment and Deployment Kit</a>
tool suite.  Download and install the Windows Assessment and Deployment Kit
to install the Windows System Image Manager (WSIM).</p>

<p>Link to <a href="https://raw.github.com/misheska/basebox-packer/master/template/misheska-win2012x64/floppy/Autounattend.xml">Autounattend.xml</a>
with all the settings in this article.</p>

<h1 id="disabling-the-language-settings-dialog">Disabling the language settings dialog</h1>

<p><img src="/images/sysprep/win2012x64/language.png" /></p>

<p><img src="/images/sysprep/win2012x64/languagecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component 
<em>amd64_Microsoft-Windows-International-Core-WinPE_6.2.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 1 windowsPE</em>.  Using the
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/languagesettings.png" /></p>

<ul>
  <li>InputLocale = <strong>en-US</strong></li>
  <li>SystemLocale = <strong>en-US</strong></li>
  <li>UILanguage = <strong>en-US</strong></li>
  <li>UserLocale = <strong>en-US</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/productkeycomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component 
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserData/ProductKey</em> and choose <em>Add Setting to Pass 1 windowsPE</em>.  Using the
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/productkeysettings.png" /></p>

<ul>
  <li>Key = **<_your_product_key_>**</_your_product_key_></li>
  <li>WillShowUI = <strong>OnError</strong></li>
</ul>

<h1 id="disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</h1>

<p><img src="/images/sysprep/win2012x64/operatingsystem.png" /></p>

<p><img src="/images/sysprep/win2012x64/operatingsystemcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallFrom/Metadata</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/operatingsystemsettings.png" /></p>

<ul>
  <li>Key = <strong>/IMAGE/NAME</strong></li>
  <li>Value = <strong>Windows Server 2012 SERVERDATACENTER</strong></li>
</ul>

<p>NOTE: Make sure the <code>/IMAGE/NAME</code> value matches the Windows Server 2012
Image flavor you selected.  Possible values are:</p>

<ul>
  <li>Windows Server 2012 SERVERDATACENTER</li>
  <li>Windows Server 2012 SERVERDATACENTERCORE</li>
  <li>Windows Server 2012 SERVERSTANDARD</li>
  <li>Windows Server 2012 SERVERSTANDARDCORE</li>
</ul>

<h1 id="disabling-the-eula-dialog">Disabling the EULA dialog</h1>

<p><img src="/images/sysprep/win2012x64/eula.png" /></p>

<p><img src="/images/sysprep/win2012x64/eulacomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserData</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2012x64/eulasettings.png" /></p>

<ul>
  <li>AcceptEula = <strong>true</strong></li>
</ul>

<h1 id="disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</h1>

<p><img src="/images/sysprep/win2012x64/diskallocation.png" /></p>

<p><img src="/images/sysprep/win2012x64/diskconfigurationcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/diskconfigurationsettings.png" /></p>

<ul>
  <li>WillShowUI = <strong>OnError</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/diskcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration/Disk</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/disksettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>WillWipDisk = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/createpartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration/Disk/CreatePartitions/CreatePartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/createpartitionsettings.png" /></p>

<ul>
  <li>Extend = <strong>false</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>Size = <strong>10000</strong></li>
  <li>Type = <strong>Primary</strong></li>
</ul>

<p>NOTE: Don’t worry about getting the size exact - just set it to a
reasonable minimum.  In the next setting, we will extend the partition
to fill all remaining disk space on the drive.</p>

<p><img src="/images/sysprep/win2012x64/modifypartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration/Disk/ModifyPartitions/ModifyPartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/modifypartitionsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Extend = <strong>true</strong></li>
  <li>Format = <strong>NTFS</strong></li>
  <li>Letter = <strong>C</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/installtocomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallTo</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/installtosettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<h1 id="disabling-the-administrator-password-prompt">Disabling the Administrator password prompt</h1>

<p><img src="/images/sysprep/win2012x64/setadministratorpassword.png" /></p>

<p><img src="/images/sysprep/win2012x64/setadministratorpasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserAccounts/AdministratorPassword</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/setadministratorpasswordsettings.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<h1 id="set-up-vagrant-autologin">Set up vagrant autologin</h1>

<p><img src="/images/sysprep/win2012x64/ctrlaltdel.png" /></p>

<p><img src="/images/sysprep/win2012x64/vagrantaccountcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/vagrantaccount.png" /></p>

<ul>
  <li>Description = <strong>Vagrant User</strong></li>
  <li>DisplayName = <strong>vagrant</strong></li>
  <li>Group = <strong>Administrators</strong></li>
  <li>Name = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/vagrantpasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/vagrantautologoncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.9200.16384_neutral</em>,
right-click on <em>AutoLogon</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/vagrantautologon.png" /></p>

<ul>
  <li>Enabled = <strong>true</strong></li>
  <li>Username = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/vagrantimagepasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>AutoLogon/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<h1 id="do-not-show-server-manager-at-logon">Do not show Server Manager at logon</h1>

<p><img src="/images/sysprep/win2012x64/servermanager.png" /></p>

<p><img src="/images/sysprep/win2012x64/disableservermanageratlogoncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-ServerManager-SvrMgrNc_6.2.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2012x64/disableservermanageratlogonsettings.png" /></p>

<ul>
  <li>DoNotOpenServerManagerAtLogon = <strong>true</strong></li>
</ul>

<h1 id="disable-user-account-control-uac">Disable User Account Control (UAC)</h1>

<p><img src="/images/sysprep/win2012x64/uac.png" /></p>

<p><img src="/images/sysprep/win2012x64/uaccomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-LUA-Settings_6.2.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 2 offlineServicing</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/uacsettings.png" /></p>

<ul>
  <li>EnableLUA = <strong>false</strong></li>
</ul>

<h1 id="disable-internet-explorer-enhanced-security-configuration">Disable Internet Explorer Enhanced Security Configuration</h1>

<p><img src="/images/sysprep/win2012x64/ieesc.png" /></p>

<p><img src="/images/sysprep/win2012x64/ieesccomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-ESC_10.0.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/ieescsettings.png" /></p>

<ul>
  <li>IEHardenAdmin = <strong>false</strong></li>
  <li>IEHardenUser = <strong>false</strong></li>
</ul>

<h1 id="disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</h1>

<p><img src="/images/sysprep/win2012x64/iefirstrun.png" /></p>

<p><img src="/images/sysprep/win2012x64/iefirstruncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2012x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/iefirstrunwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2012x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<h1 id="replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</h1>

<p><img src="/images/sysprep/win2012x64/googlesearchcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/googlesearchwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = **true</li>
</ul>

<h1 id="enable-remote-desktop">Enable Remote Desktop</h1>

<p><img src="/images/sysprep/win2012x64/tsconnectioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-LocalSessionManager_6.2.9200.16384_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/tsconnectionsettings.png" /></p>

<ul>
  <li>fDenyTSConnections = <strong>false</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/firewallgroupcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Networking-MPSSVC-Svc_6.2.9200.16384_neutral</em>,
right-click on <em>FirewallGroups/FirewallGroup</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2012x64/firewallgroupsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Group = <strong>Remote Desktop</strong></li>
  <li>Key = <strong>RemoteDesktop</strong></li>
  <li>Profile = <strong>all</strong></li>
</ul>

<p><img src="/images/sysprep/win2012x64/rdpsecuritycomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-RDP-WinStationExtensions_6.2.9200.16384_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2012x64/rdpsecuritysettings.png" /></p>

<ul>
  <li>SecurityLayer = <strong>1</strong></li>
  <li>UserAuthentication = <strong>0</strong></li>
</ul>

<h1 id="turn-off-computer-password">Turn off computer password</h1>

<p>Prevent the image from changing its computer account password,
so you can restore old snapshots without being dropped from a domain</p>

<pre><code>REG ADD "HKLM\System\CurrentControlSet\Services\Netlogon\Parameters" /v DisablePasswordChange /t REG_DWORD /d 1 /f
</code></pre>

<p><img src="/images/sysprep/win2012x64/disablepasswordchangecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2012x64/disablepasswordchangesettings.png" /></p>

<ul>
  <li>CommandLine = <strong>REG ADD “HKLM\System\CurrentControlSet\Services\Netlogon\Parameters” /v DisablePasswordChange /t REG_DWORD /d 2 /f</strong></li>
  <li>Description = <strong>Disable computer password change</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>RequiresUserInput <strong>true</strong></li>
</ul>

<h1 id="turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</h1>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>set-power-config.bat </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="c">REM Set power configuration to High Performance</span>
</span><span class="line">powercfg -setactive <span class="m">8</span>c<span class="m">5</span>e<span class="m">7</span>fda-e<span class="m">8</span>bf<span class="m">-4</span>a<span class="m">96-9</span>a<span class="m">85</span>-a<span class="m">6</span>e<span class="m">23</span>a<span class="m">8</span>c<span class="m">635</span>c
</span><span class="line"><span class="c">REM Monitor timeout</span>
</span><span class="line">powercfg -Change -monitor-timeout-ac <span class="m">0</span>
</span><span class="line">powercfg -Change -monitor-timeout-dc <span class="m">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/images/sysprep/win2012x64/powerconfigcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2012x64/powerconfigsettings.png" /></p>

<ul>
  <li>CommandLine = <strong>cmd.exe /c a:set-power-config.bat</strong></li>
  <li>Description = <strong>Turn off all power saving and timeouts</strong></li>
  <li>Order = <strong>2</strong></li>
  <li>RequiresUserInput = <strong>true</strong></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/27/windows-8-automated-install-settings/">Windows 8 Automated Install Settings</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-27T19:04:00-07:00" pubdate data-updated="true">Jul 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#disabling-the-language-settings-dialog">Disabling the language settings dialog</a></li>
  <li><a href="#disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</a></li>
  <li><a href="#disabling-the-eula-dialog">Disabling the EULA dialog</a></li>
  <li><a href="#disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</a></li>
  <li><a href="#disable-pc-name-dialog">Disable PC name dialog</a></li>
  <li><a href="#disable-settings-dialog">Disable Settings dialog</a></li>
  <li><a href="#disabling-the-sign-in-to-your-pc-dialog">Disabling the Sign in to your PC dialog</a></li>
  <li><a href="#disable-user-account-control-uac">Disable User Account Control (UAC)</a></li>
  <li><a href="#disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</a></li>
  <li><a href="#replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</a></li>
  <li><a href="#enable-remote-desktop">Enable Remote Desktop</a></li>
  <li><a href="#turn-off-computer-password">Turn off computer password</a></li>
  <li><a href="#turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</a></li>
</ul>

<p>I just recently revised all my automated install XML files for the Windows
System Preparation Tool (Sysprep) that I use for my Windows development
testbed.  For this go around, I’m documenting the XML answer file settings
for each version of Microsoft Windows.  This article covers the XML answer
files settings needed to automate a Windows 8 (64-bit) base
OS install.</p>

<p>You’ll need to use the Windows System Image Manager tool to edit Sysprep
XML answer files.  The Windows System Image Manager is packaged with the
<a href="http://www.microsoft.com/en-us/download/details.aspx?id=30652">Windows Assessment and Deployment Kit</a>
tool suite.  Download and install the Windows Assessment and Deployment Kit
to install the Windows System Image Manager (WSIM).</p>

<p>Link to <a href="https://raw.github.com/misheska/basebox-packer/master/template/misheska-win8x64/floppy/Autounattend.xml">Autounattend.xml</a>
with all the settings in this article.</p>

<h1 id="disabling-the-language-settings-dialog">Disabling the language settings dialog</h1>

<p><img src="/images/sysprep/win8x64/language.png" /></p>

<p><img src="/images/sysprep/win8x64/languagecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component 
<em>amd64_Microsoft-Windows-International-Core-WinPE_6.2.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 1 windowsPE</em>.  Using the
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/languagesettings.png" /></p>

<ul>
  <li>InputLocale = <strong>en-US</strong></li>
  <li>SystemLocale = <strong>en-US</strong></li>
  <li>UILanguage = <strong>en-US</strong></li>
  <li>UserLocale = <strong>en-US</strong></li>
</ul>

<h1 id="disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</h1>

<p><img src="/images/sysprep/win8x64/operatingsystem.png" /></p>

<p><img src="/images/sysprep/win8x64/operatingsystemcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallFrom/Metadata</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/operatingsystemsettings.png" /></p>

<ul>
  <li>Key = <strong>/IMAGE/NAME</strong></li>
  <li>Value = <strong>Windows 8 Enterprise</strong></li>
</ul>

<h1 id="disabling-the-eula-dialog">Disabling the EULA dialog</h1>

<p><img src="/images/sysprep/win8x64/eula.png" /></p>

<p><img src="/images/sysprep/win8x64/eulacomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserData</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win8x64/eulasettings.png" /></p>

<ul>
  <li>AcceptEula = <strong>true</strong></li>
</ul>

<h1 id="disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</h1>

<p><img src="/images/sysprep/win8x64/diskallocation.png" /></p>

<p><img src="/images/sysprep/win8x64/diskconfigurationcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/diskconfigurationsettings.png" /></p>

<ul>
  <li>WillShowUI = <strong>OnError</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/diskcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration/Disk</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/disksettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>WillWipDisk = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/createpartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration/Disk/CreatePartitions/CreatePartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/createpartitionsettings.png" /></p>

<ul>
  <li>Extend = <strong>false</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>Size = <strong>10000</strong></li>
  <li>Type = <strong>Primary</strong></li>
</ul>

<p>NOTE: Don’t worry about getting the size exact - just set it to a
reasonable minimum.  In the next setting, we will extend the partition
to fill all remaining disk space on the drive.</p>

<p><img src="/images/sysprep/win8x64/modifypartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>DiskConfiguration/Disk/ModifyPartitions/ModifyPartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/modifypartitionsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Extend = <strong>true</strong></li>
  <li>Format = <strong>NTFS</strong></li>
  <li>Letter = <strong>C</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/installtocomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallTo</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/installtosettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<h1 id="disable-pc-name-dialog">Disable PC name dialog</h1>

<p><img src="/images/sysprep/win8x64/pcname.png" /></p>

<p><img src="/images/sysprep/win8x64/pcnamecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win8x64/pcnamesettings.png" /></p>

<ul>
  <li>Value - <strong>vagrant-win7</strong></li>
  <li>TimeZone = <strong>Pacific Standard Time</strong></li>
</ul>

<h1 id="disable-settings-dialog">Disable Settings dialog</h1>

<p><img src="/images/sysprep/win8x64/settings.png" /></p>

<p><img src="/images/sysprep/win8x64/settingscomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>OOBE</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win8x64/settingssettings.png" /></p>

<ul>
  <li>NetworkLocation = <strong>Work</strong></li>
  <li>ProtectYourPC = <strong>3</strong></li>
</ul>

<h1 id="disabling-the-sign-in-to-your-pc-dialog">Disabling the Sign in to your PC dialog</h1>

<p><img src="/images/sysprep/win8x64/signin.png" /></p>

<p><img src="/images/sysprep/win8x64/vagrantaccountcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/vagrantaccount.png" /></p>

<ul>
  <li>Description = <strong>Vagrant User</strong></li>
  <li>DisplayName = <strong>vagrant</strong></li>
  <li>Group = <strong>Administrators</strong></li>
  <li>Name = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/vagrantpasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/vagrantautologoncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click on <em>AutoLogon</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/vagrantautologon.png" /></p>

<ul>
  <li>Enabled = <strong>true</strong></li>
  <li>Username = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/vagrantimagepasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>AutoLogon/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<h1 id="disable-user-account-control-uac">Disable User Account Control (UAC)</h1>

<p><img src="/images/sysprep/win8x64/uaccomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-LUA-Settings_6.2.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 2 offlineServicing</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/uacsettings.png" /></p>

<ul>
  <li>EnableLUA = <strong>false</strong></li>
</ul>

<h1 id="disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</h1>

<p><img src="/images/sysprep/win8x64/iefirstruncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win8x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/iefirstrunwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win8x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<h1 id="replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</h1>

<p><img src="/images/sysprep/win8x64/iefirstrun.png" /></p>

<p><img src="/images/sysprep/win8x64/googlesearchcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/googlesearchwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_10.0.9200.16384_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = **true</li>
</ul>

<h1 id="enable-remote-desktop">Enable Remote Desktop</h1>

<p><img src="/images/sysprep/win8x64/rdp.png" /></p>

<p><img src="/images/sysprep/win8x64/tsconnectioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-LocalSessionManager_6.2.9200.16384_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/tsconnectionsettings.png" /></p>

<ul>
  <li>fDenyTSConnections = <strong>false</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/firewallgroupcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Networking-MPSSVC-Svc_6.2.9200.16384_neutral</em>,
right-click on <em>FirewallGroups/FirewallGroup</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win8x64/firewallgroupsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Group = <strong>Remote Desktop</strong></li>
  <li>Key = <strong>RemoteDesktop</strong></li>
  <li>Profile = <strong>all</strong></li>
</ul>

<p><img src="/images/sysprep/win8x64/rdpsecuritycomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-RDP-WinStationExtensions_6.1.7601.17514_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win8x64/rdpsecuritysettings.png" /></p>

<ul>
  <li>SecurityLayer = <strong>1</strong></li>
  <li>UserAuthentication = <strong>0</strong></li>
</ul>

<h1 id="turn-off-computer-password">Turn off computer password</h1>

<p>Prevent the image from changing its computer account password,
so you can restore old snapshots without being dropped from a domain</p>

<pre><code>REG ADD "HKLM\System\CurrentControlSet\Services\Netlogon\Parameters" /v DisablePasswordChange /t REG_DWORD /d 1 /f
</code></pre>

<p><img src="/images/sysprep/win8x64/disablepasswordchangecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win8x64/disablepasswordchangesettings.png" /></p>

<ul>
  <li>CommandLine = <strong>REG ADD “HKLM\System\CurrentControlSet\Services\Netlogon\Parameters” /v DisablePasswordChange /t REG_DWORD /d 2 /f</strong></li>
  <li>Description = <strong>Disable computer password change</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>RequiresUserInput <strong>true</strong></li>
</ul>

<h1 id="turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</h1>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>set-power-config.bat </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="c">REM Set power configuration to High Performance</span>
</span><span class="line">powercfg -setactive <span class="m">8</span>c<span class="m">5</span>e<span class="m">7</span>fda-e<span class="m">8</span>bf<span class="m">-4</span>a<span class="m">96-9</span>a<span class="m">85</span>-a<span class="m">6</span>e<span class="m">23</span>a<span class="m">8</span>c<span class="m">635</span>c
</span><span class="line"><span class="c">REM Monitor timeout</span>
</span><span class="line">powercfg -Change -monitor-timeout-ac <span class="m">0</span>
</span><span class="line">powercfg -Change -monitor-timeout-dc <span class="m">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/images/sysprep/win7x64/powerconfigcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.2.9200.16384_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/powerconfigsettings.png" /></p>

<ul>
  <li>CommandLine = <strong>cmd.exe /c a:set-power-config.bat</strong></li>
  <li>Description = <strong>Turn off all power saving and timeouts</strong></li>
  <li>Order = <strong>2</strong></li>
  <li>RequiresUserInput = <strong>true</strong></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/26/windows-7-automated-install-settings/">Windows 7 Automated Install Settings</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-26T10:48:00-07:00" pubdate data-updated="true">Jul 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#disabling-the-language-settings-dialog">Disabling the language settings dialog</a></li>
  <li><a href="#disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</a></li>
  <li><a href="#disabling-the-eula-dialog">Disabling the EULA dialog</a></li>
  <li><a href="#disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</a></li>
  <li><a href="#disabling-the-account-and-computer-name-dialog">Disabling the account and computer name dialog</a></li>
  <li><a href="#disable-computer-name-dialog">Disable Computer Name dialog</a></li>
  <li><a href="#disable-protect-computer-dialog">Disable Protect Computer dialog</a></li>
  <li><a href="#disable-user-account-control-uac">Disable User Account Control (UAC)</a></li>
  <li><a href="#disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</a></li>
  <li><a href="#replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</a></li>
  <li><a href="#enable-remote-desktop">Enable Remote Desktop</a></li>
  <li><a href="#really-disable-set-network-location-prompt">(Really) Disable Set Network Location Prompt</a></li>
  <li><a href="#turn-off-computer-password">Turn off computer password</a></li>
  <li><a href="#turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</a></li>
</ul>

<p>I just recently revised all my automated install XML files for the Windows
System Preparation Tool (Sysprep) that I use for my Windows development
testbed.  For this go around, I’m documenting the XML answer file settings
for each version of Microsoft Windows.  This article covers the XML answer
files settings needed to automate a Windows 7 (64-bit) base
OS install.</p>

<p>You’ll need to use the Windows System Image Manager tool to edit Sysprep
XML answer files.  The Windows System Image Manager is packaged with the
<a href="http://www.microsoft.com/en-us/download/details.aspx?id=30652">Windows Assessment and Deployment Kit</a>
tool suite.  Download and install the Windows Assessment and Deployment Kit
to install the Windows System Image Manager (WSIM).</p>

<p><a href="http://technet.microsoft.com/en-us/library/dd744272(v=ws.10).aspx">Settings to Use for an Unattended Installation</a></p>

<p><a href="http://technet.microsoft.com/en-us/library/dd744547(WS.10).aspx">Automate Windows Welcome</a></p>

<p>Link to <a href="https://raw.github.com/misheska/basebox-packer/master/template/misheska-win7x64/floppy/Autounattend.xml">Autounattend.xml</a>
with all the settings in this article.</p>

<h1 id="disabling-the-language-settings-dialog">Disabling the language settings dialog</h1>

<p><img src="/images/sysprep/win7x64/language.png" /></p>

<p><img src="/images/sysprep/win7x64/languagecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component 
<em>amd64_Microsoft-Windows-International-Core-WinPE_6.1.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 1 windowsPE</em>.  Using the
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/languagesettings.png" /></p>

<ul>
  <li>InputLocale = <strong>en-US</strong></li>
  <li>SystemLocale = <strong>en-US</strong></li>
  <li>UILanguage = <strong>en-US</strong></li>
  <li>UserLocale = <strong>en-US</strong></li>
</ul>

<h1 id="disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</h1>

<p><img src="/images/sysprep/win7x64/operatingsystem.png" /></p>

<p><img src="/images/sysprep/win7x64/operatingsystemcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallFrom/Metadata</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/operatingsystemsettings.png" /></p>

<ul>
  <li>Key = <strong>/IMAGE/NAME</strong></li>
  <li>Value = <strong>Windows 7 ENTERPRISE</strong></li>
</ul>

<h1 id="disabling-the-eula-dialog">Disabling the EULA dialog</h1>

<p><img src="/images/sysprep/win7x64/eula.png" /></p>

<p><img src="/images/sysprep/win7x64/eulacomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>UserData</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/eulasettings.png" /></p>

<ul>
  <li>AcceptEula = <strong>true</strong></li>
</ul>

<h1 id="disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</h1>

<p><img src="/images/sysprep/win7x64/diskallocation.png" /></p>

<p><img src="/images/sysprep/win7x64/diskconfigurationcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/diskconfigurationsettings.png" /></p>

<ul>
  <li>WillShowUI = <strong>OnError</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/diskcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration/Disk</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/disksettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>WillWipDisk = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/createpartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration/Disk/CreatePartitions/CreatePartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/createpartitionsettings.png" /></p>

<ul>
  <li>Extend = <strong>false</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>Size = <strong>10000</strong></li>
  <li>Type = <strong>Primary</strong></li>
</ul>

<p>NOTE: Don’t worry about getting the size exact - just set it to a
reasonable minimum.  In the next setting, we will extend the partition
to fill all remaining disk space on the drive.</p>

<p><img src="/images/sysprep/win7x64/modifypartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration/Disk/ModifyPartitions/ModifyPartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/modifypartitionsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Extend = <strong>true</strong></li>
  <li>Format = <strong>NTFS</strong></li>
  <li>Letter = <strong>C</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/installtocomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallTo</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/installtosettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<h1 id="disabling-the-account-and-computer-name-dialog">Disabling the account and computer name dialog</h1>

<p><img src="/images/sysprep/win7x64/account.png" /></p>

<p><img src="/images/sysprep/win7x64/vagrantaccountcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/vagrantaccount.png" /></p>

<ul>
  <li>Description = <strong>Vagrant User</strong></li>
  <li>DisplayName = <strong>vagrant</strong></li>
  <li>Group = <strong>Administrators</strong></li>
  <li>Name = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/vagrantpasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/vagrantautologoncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>AutoLogon</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/vagrantautologon.png" /></p>

<ul>
  <li>Enabled = <strong>true</strong></li>
  <li>Username = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/vagrantimagepasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>AutoLogon/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<h1 id="disable-computer-name-dialog">Disable Computer Name dialog</h1>

<p><img src="/images/sysprep/win7x64/computername.png" /></p>

<p><img src="/images/sysprep/win7x64/computernamecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/computernamesettings.png" /></p>

<ul>
  <li>Value - <strong>vagrant-win7</strong></li>
  <li>TimeZone = <strong>Pacific Standard Time</strong></li>
</ul>

<h1 id="disable-protect-computer-dialog">Disable Protect Computer dialog</h1>

<p><img src="/images/sysprep/win7x64/protect.png" /></p>

<p><img src="/images/sysprep/win7x64/protectcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>OOBE</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/protectsettings.png" /></p>

<ul>
  <li>NetworkLocation = <strong>Work</strong></li>
  <li>ProtectYourPC = <strong>3</strong></li>
</ul>

<h1 id="disable-user-account-control-uac">Disable User Account Control (UAC)</h1>

<p><img src="/images/sysprep/win7x64/uaccomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-LUA-Settings_6.1.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 2 offlineServicing</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/uacsettings.png" /></p>

<ul>
  <li>EnableLUA = <strong>false</strong></li>
</ul>

<h1 id="disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</h1>

<p><img src="/images/sysprep/win7x64/iefirstruncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_8.0.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win7x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/iefirstrunwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_8.0.7601.17514_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win7x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<h1 id="replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</h1>

<p><img src="/images/sysprep/win7x64/googlesearchcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_8.0.7600.16385_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/googlesearchwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_8.0.7601.17514_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = <strong>true</strong></li>
</ul>

<h1 id="enable-remote-desktop">Enable Remote Desktop</h1>

<p><img src="/images/sysprep/win7x64/tsconnectioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-LocalSessionManager_6.1.7601.17514_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/tsconnectionsettings.png" /></p>

<ul>
  <li>fDenyTSConnections = <strong>false</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/firewallgroupcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Networking-MPSSVC-Svc_6.1.7601.175414_neutral</em>,
right-click on <em>FirewallGroups/FirewallGroup</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/firewallgroupsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Group = <strong>Remote Desktop</strong></li>
  <li>Key = <strong>RemoteDesktop</strong></li>
  <li>Profile = <strong>all</strong></li>
</ul>

<p><img src="/images/sysprep/win7x64/rdpsecuritycomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-RDP-WinStationExtensions_6.1.7601.17514_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win7x64/rdpsecuritysettings.png" /></p>

<ul>
  <li>SecurityLayer = <strong>1</strong></li>
  <li>UserAuthentication = <strong>0</strong></li>
</ul>

<h1 id="really-disable-set-network-location-prompt">(Really) Disable Set Network Location Prompt</h1>

<p><img src="/images/sysprep/win7x64/networklocation.png" /></p>

<pre><code>REG ADD "HKLM\System\CurrentControlSet\Control\Network\NewNetworkWindowOff"
</code></pre>

<p><img src="/images/sysprep/win7x64/networklocationcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/networklocationsettings.png" /></p>

<ul>
  <li>CommandLine = <strong>REG ADD “HKLM\System\CurrentControlSet\Control\Network\NewNetworkWindowOff”</strong></li>
  <li>Description = <strong>Disable Set Network Location Prompt</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>RequiresUserInput <strong>true</strong></li>
</ul>

<h1 id="turn-off-computer-password">Turn off computer password</h1>

<p>Prevent the image from changing its computer account password,
so you can restore old snapshots without being dropped from a domain</p>

<pre><code>REG ADD "HKLM\System\CurrentControlSet\Services\Netlogon\Parameters" /v DisablePasswordChange /t REG_DWORD /d 1 /f
</code></pre>

<p><img src="/images/sysprep/win7x64/disablepasswordchangecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/disablepasswordchangesettings.png" /></p>

<ul>
  <li>CommandLine = <strong>REG ADD “HKLM\System\CurrentControlSet\Services\Netlogon\Parameters” /v DisablePasswordChange /t REG_DWORD /d 2 /f</strong></li>
  <li>Description = <strong>Disable computer password change</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>RequiresUserInput <strong>true</strong></li>
</ul>

<h1 id="turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</h1>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>set-power-config.bat </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="c">REM Set power configuration to High Performance</span>
</span><span class="line">powercfg -setactive <span class="m">8</span>c<span class="m">5</span>e<span class="m">7</span>fda-e<span class="m">8</span>bf<span class="m">-4</span>a<span class="m">96-9</span>a<span class="m">85</span>-a<span class="m">6</span>e<span class="m">23</span>a<span class="m">8</span>c<span class="m">635</span>c
</span><span class="line"><span class="c">REM Monitor timeout</span>
</span><span class="line">powercfg -Change -monitor-timeout-ac <span class="m">0</span>
</span><span class="line">powercfg -Change -monitor-timeout-dc <span class="m">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/images/sysprep/win7x64/powerconfigcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win7x64/powerconfigsettings.png" /></p>

<ul>
  <li>CommandLine = <strong>cmd.exe /c a:set-power-config.bat</strong></li>
  <li>Description = <strong>Turn off all power saving and timeouts</strong></li>
  <li>Order = <strong>3</strong></li>
  <li>RequiresUserInput = <strong>true</strong></li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/25/windows-server-2008-r2-automated-install-settings/">Windows Server 2008 R2 Automated Install Settings</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-25T23:20:00-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#disabling-the-language-settings-dialog">Disabling the language settings dialog</a></li>
  <li><a href="#disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</a></li>
  <li><a href="#disabling-the-eula-dialog">Disabling the EULA dialog</a></li>
  <li><a href="#disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</a></li>
  <li><a href="#disabling-the-administrator-password-prompt">Disabling the Administrator password prompt</a></li>
  <li><a href="#set-up-vagrant-autologin">Set up vagrant autologin</a></li>
  <li><a href="#disable-initial-configuration-dialog">Disable Initial Configuration Dialog</a></li>
  <li><a href="#do-not-show-server-manager-at-logon">Do not show Server Manager at logon</a></li>
  <li><a href="#disable-user-account-control-uac">Disable User Account Control (UAC)</a></li>
  <li><a href="#disable-internet-explorer-enhanced-security-configuration">Disable Internet Explorer Enhanced Security Configuration</a></li>
  <li><a href="#disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</a></li>
  <li><a href="#replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</a></li>
  <li><a href="#enable-remote-desktop">Enable Remote Desktop</a></li>
  <li><a href="#turn-off-computer-password">Turn off computer password</a></li>
  <li><a href="#turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</a></li>
</ul>

<p>I just recently revised all my automated install XML files for the Windows
System Preparation Tool (Sysprep) that I use for my Windows development
testbed.  For this go around, I’m documenting the XML answer file settings
for each version of Microsoft Windows.  This article covers the XML answer
files settings needed to automate a Windows Server 2008 R2 (64-bit) base
OS install.</p>

<p>You’ll need to use the Windows System Image Manager tool to edit Sysprep
XML answer files.  The Windows System Image Manager is packaged with the
<a href="http://www.microsoft.com/en-us/download/details.aspx?id=30652">Windows Assessment and Deployment Kit</a>
tool suite.  Download and install the Windows Assessment and Deployment Kit
to install the Windows System Image Manager (WSIM).</p>

<p>Link to <a href="https://raw.github.com/misheska/basebox-packer/master/template/misheska-win2008R2x64/floppy/Autounattend.xml">Autounattend.xml</a>
with all the settings in this article.</p>

<h1 id="disabling-the-language-settings-dialog">Disabling the language settings dialog</h1>

<p><img src="/images/sysprep/win2008R2x64/language.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/languagecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component 
<em>amd64_Microsoft-Windows-International-Core-WinPE_6.1.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 1 windowsPE</em>.  Using the
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/languagesettings.png" /></p>

<ul>
  <li>InputLocale = <strong>en-US</strong></li>
  <li>SystemLocale = <strong>en-US</strong></li>
  <li>UILanguage = <strong>en-US</strong></li>
  <li>UserLocale = <strong>en-US</strong></li>
</ul>

<h1 id="disabling-the-select-operating-system-dialog">Disabling the Select Operating System dialog</h1>

<p><img src="/images/sysprep/win2008R2x64/operatingsystem.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/operatingsystemcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallFrom/Metadata</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2008R2x64/operatingsystemsettings.png" /></p>

<ul>
  <li>Key = <strong>/IMAGE/NAME</strong></li>
  <li>Value = <strong>Windows Server 2008 R2 SERVERDATACENTER</strong></li>
</ul>

<p>NOTE: Make sure the <code>/IMAGE/NAME</code> value matches the Windows 2008R2
Image flavor you selected.  Possible values are:</p>

<ul>
  <li>Windows Server 2008 R2 SERVERDATACENTER</li>
  <li>Windows Server 2008 R2 SERVERDATACENTERCORE</li>
  <li>Windows Server 2008 R2 SERVERENTERPRISE</li>
  <li>Windows Server 2008 R2 SERVERENTERPRISECORE</li>
  <li>Windows Server 2008 R2 SERVERSTANDARD</li>
  <li>Windows Server 2008 R2 SERVERSTANDARDCORE</li>
  <li>Windows Server 2008 R2 SERVERWEB</li>
  <li>Windows Server 2008 R2 SERVERWEBCORE</li>
</ul>

<h1 id="disabling-the-eula-dialog">Disabling the EULA dialog</h1>

<p><img src="/images/sysprep/win2008R2x64/eula.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/eulacomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>UserData</em> and choose
<em>Add Setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2008R2x64/eulasettings.png" /></p>

<ul>
  <li>AcceptEula = <strong>true</strong></li>
</ul>

<h1 id="disabling-the-disk-allocation-dialog">Disabling the Disk Allocation dialog</h1>

<p><img src="/images/sysprep/win2008R2x64/diskallocation.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/diskconfigurationcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/diskconfigurationsettings.png" /></p>

<ul>
  <li>WillShowUI = <strong>OnError</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/diskcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration/Disk</em> and choose
<em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/disksettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>WillWipDisk = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/createpartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration/Disk/CreatePartitions/CreatePartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/createpartitionsettings.png" /></p>

<ul>
  <li>Extend = <strong>false</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>Size = <strong>10000</strong></li>
  <li>Type = <strong>Primary</strong></li>
</ul>

<p>NOTE: Don’t worry about getting the size exact - just set it to a
reasonable minimum.  In the next setting, we will extend the partition
to fill all remaining disk space on the drive.</p>

<p><img src="/images/sysprep/win2008R2x64/modifypartitioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>DiskConfiguration/Disk/ModifyPartitions/ModifyPartition</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/modifypartitionsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Extend = <strong>true</strong></li>
  <li>Format = <strong>NTFS</strong></li>
  <li>Letter = <strong>C</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/installtocomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Setup_6.1.7600.16385_neutral</em>,
right-click on <em>ImageInstall/OSImage/InstallTo</em> and 
choose <em>Add setting to Pass 1 windowsPE</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/installtosettings.png" /></p>

<ul>
  <li>DiskID = <strong>0</strong></li>
  <li>PartitionID = <strong>1</strong></li>
</ul>

<h1 id="disabling-the-administrator-password-prompt">Disabling the Administrator password prompt</h1>

<p><img src="/images/sysprep/win2008R2x64/setadministratorpassword.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/setadministratorpasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>UserAccounts/AdministratorPassword</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/setadministratorpasswordsettings.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<h1 id="set-up-vagrant-autologin">Set up vagrant autologin</h1>

<p><img src="/images/sysprep/win2008R2x64/ctrlaltdel.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/vagrantaccountcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/vagrantaccount.png" /></p>

<ul>
  <li>Description = <strong>Vagrant User</strong></li>
  <li>DisplayName = <strong>vagrant</strong></li>
  <li>Group = <strong>Administrators</strong></li>
  <li>Name = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/vagrantpasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>UserAccounts/LocalAccounts/LocalAccount/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/vagrantautologoncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>AutoLogon</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/vagrantautologon.png" /></p>

<ul>
  <li>Enabled = <strong>true</strong></li>
  <li>Username = <strong>vagrant</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/vagrantimagepasswordcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click on <em>AutoLogon/Password</em> and choose
<em>Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em> and
<em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/vagrantpassword.png" /></p>

<ul>
  <li>Value = <strong>vagrant</strong></li>
</ul>

<h1 id="disable-initial-configuration-dialog">Disable Initial Configuration Dialog</h1>

<p><img src="/images/sysprep/win2008R2x64/initialconfiguration.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/initialconfigurationcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-OutOfBoxExperience_6.1.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2008R2x64/initialconfigurationsettings.png" /></p>

<ul>
  <li>DoNotOpenInitialConfigurationTasksAtLogon = <strong>true</strong></li>
</ul>

<h1 id="do-not-show-server-manager-at-logon">Do not show Server Manager at logon</h1>

<p><img src="/images/sysprep/win2008R2x64/disableservermanageratlogon.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/disableservermanageratlogoncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-ServerManager-SvrMgrNc_6.1.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2008R2x64/disableservermanageratlogonsettings.png" /></p>

<ul>
  <li>DoNotOpenServerManagerAtLogon = <strong>true</strong></li>
</ul>

<h1 id="disable-user-account-control-uac">Disable User Account Control (UAC)</h1>

<p><img src="/images/sysprep/win2008R2x64/uaccomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-LUA-Settings_6.1.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 2 offlineServicing</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2008R2x64/uacsettings.png" /></p>

<ul>
  <li>EnableLUA = <strong>false</strong></li>
</ul>

<h1 id="disable-internet-explorer-enhanced-security-configuration">Disable Internet Explorer Enhanced Security Configuration</h1>

<p><img src="/images/sysprep/win2008R2x64/ieesccomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-ESC_8.0.7601.17514_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/ieescsettings.png" /></p>

<ul>
  <li>IEHardenAdmin = <strong>false</strong></li>
  <li>IEHardenUser = <strong>false</strong></li>
</ul>

<h1 id="disable-internet-explorer-first-run-wizard">Disable Internet Explorer First Run Wizard</h1>

<p><img src="/images/sysprep/win2008R2x64/iefirstruncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_8.0.7600.16385_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2008R2x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/iefirstrunwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_8.0.7601.17514_neutral</em>,
right-click and choose <em>Add Setting to Pass 4 specialize</em>.  Using the 
Answer File <em>Properties</em> and <em>Settings</em> panes, configure the following
settings:</p>

<p><img src="/images/sysprep/win2008R2x64/iefirstrunsettings.png" /></p>

<ul>
  <li>DisableAccelerators = <strong>true</strong></li>
  <li>DisableFirstRunWizard = <strong>true</strong></li>
  <li>Home_Page = <strong>about:blank</strong></li>
</ul>

<h1 id="replace-internet-explorer-bing-search-with-google">Replace Internet Explorer Bing search with Google</h1>

<p><img src="/images/sysprep/win2008R2x64/googlesearchcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-IE-InternetExplorer_8.0.7600.16385_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2008R2x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = <strong>true</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/googlesearchwowcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>wow64_Microsoft-Windows-IE-InternetExplorer_8.0.7601.17514_neutral</em>,
right-click on <em>SearchScopes/Scope</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2008R2x64/googlesearchsettings.png" /></p>

<ul>
  <li>ScopeDefault = <strong>true</strong></li>
  <li>ScopeDisplayName = <strong>Google</strong></li>
  <li>ScopeKey = <strong>Google</strong></li>
  <li>ScopeUrl = <strong>http://www.google.com/search?q={searchTerms}</strong></li>
  <li>ShowSearchSuggestions = <strong>true</strong></li>
</ul>

<h1 id="enable-remote-desktop">Enable Remote Desktop</h1>

<p><img src="/images/sysprep/win2008R2x64/remotedesktopenabled.png" /></p>

<p><img src="/images/sysprep/win2008R2x64/tsconnectioncomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-LocalSessionManager_6.1.7601.17514_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/tsconnectionsettings.png" /></p>

<ul>
  <li>fDenyTSConnections = <strong>false</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/firewallgroupcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Networking-MPSSVC-Svc_6.1.7601.175414_neutral</em>,
right-click on <em>FirewallGroups/FirewallGroup</em> and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/firewallgroupsettings.png" /></p>

<ul>
  <li>Active = <strong>true</strong></li>
  <li>Group = <strong>Remote Desktop</strong></li>
  <li>Key = <strong>RemoteDesktop</strong></li>
  <li>Profile = <strong>all</strong></li>
</ul>

<p><img src="/images/sysprep/win2008R2x64/rdpsecuritycomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-TerminalServices-RDP-WinStationExtensions_6.1.7601.17514_neutral</em>,
right-click and choose
<em>Add Setting to Pass 4 specialize</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img class="right" src="/images/sysprep/win2008R2x64/rdpsecuritysettings.png" /></p>

<ul>
  <li>SecurityLayer = <strong>1</strong></li>
  <li>UserAuthentication = <strong>0</strong></li>
</ul>

<h1 id="turn-off-computer-password">Turn off computer password</h1>

<p>Prevent the image from changing its computer account password,
so you can restore old VM snapshots without being dropped from a domain</p>

<pre><code>REG ADD "HKLM\System\CurrentControlSet\Services\Netlogon\Parameters" /v DisablePasswordChange /t REG_DWORD /d 1 /f
</code></pre>

<p><img src="/images/sysprep/win2008R2x64/disablepassworchangecomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2008R2x64/disablepassworchangesettings.png" /></p>

<ul>
  <li>CommandLine = <strong>REG ADD “HKLM\System\CurrentControlSet\Services\Netlogon\Parameters” /v DisablePasswordChange /t REG_DWORD /d 1 /f</strong></li>
  <li>Description = <strong>Disable computer password change</strong></li>
  <li>Order = <strong>1</strong></li>
  <li>RequiresUserInput <strong>true</strong></li>
</ul>

<h1 id="turn-off-all-power-saving-and-timeouts">Turn off all power saving and timeouts</h1>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>set-power-config.bat </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="c">REM Set power configuration to High Performance</span>
</span><span class="line">powercfg -setactive <span class="m">8</span>c<span class="m">5</span>e<span class="m">7</span>fda-e<span class="m">8</span>bf<span class="m">-4</span>a<span class="m">96-9</span>a<span class="m">85</span>-a<span class="m">6</span>e<span class="m">23</span>a<span class="m">8</span>c<span class="m">635</span>c
</span><span class="line"><span class="c">REM Monitor timeout</span>
</span><span class="line">powercfg -Change -monitor-timeout-ac <span class="m">0</span>
</span><span class="line">powercfg -Change -monitor-timeout-dc <span class="m">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/images/sysprep/win2008R2x64/powerconfigcomponents.png" /></p>

<p>In the <em>Windows Image</em> pane, select the component
<em>amd64_Microsoft-Windows-Shell-Setup_6.1.7601.17514_neutral</em>,
right-click <em>FirstLogonCommands/SynchronousCommand” and choose
_Add Setting to Pass 7 oobeSystem</em>.  Using the Answer File <em>Properties</em>
and <em>Settings</em> panes, configure the following settings:</p>

<p><img src="/images/sysprep/win2008R2x64/powerconfigsettings.png" /></p>

<ul>
  <li>CommandLine = <strong>cmd.exe /c a:set-power-config.bat</strong></li>
  <li>Description = <strong>Turn off all power saving and timeouts</strong></li>
  <li>Order = <strong>2</strong></li>
  <li>RequiresUserInput = <strong>true</strong></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-23T11:37:00-07:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#iteration-7---install-mysql">Iteration #7 - Install MySQL</a>    <ul>
      <li><a href="#testing-iteration-7">Testing Iteration #7</a></li>
    </ul>
  </li>
  <li><a href="#iteration-8---create-the-myface-database">Iteration #8 - Create the MyFace Database</a>    <ul>
      <li><a href="#testing-iteration-8">Testing Iteration #8</a></li>
    </ul>
  </li>
  <li><a href="#iteration-9---create-a-mysql-user">Iteration #9 - Create a MySQL user</a>    <ul>
      <li><a href="#testing-iteration-9">Testing Iteration #9</a></li>
    </ul>
  </li>
  <li><a href="#iteration-10---create-a-table-for-users">Iteration #10 - Create a table for users</a>    <ul>
      <li><a href="#testing-iteration-10">Testing Iteration #10</a></li>
    </ul>
  </li>
  <li><a href="#iteration-11---install-php">Iteration #11 - Install PHP</a>    <ul>
      <li><a href="#test-iteration-11">Test Iteration #11</a></li>
    </ul>
  </li>
  <li><a href="#iteration-12---add-php-sizzle">Iteration #12 - Add PHP Sizzle</a>    <ul>
      <li><a href="#testing-iteration-12">Testing Iteration #12</a></li>
    </ul>
  </li>
  <li><a href="#more-to-come">More to Come!</a></li>
</ul>

<p><em>Updated July 23rd, 2013</em></p>

<ul>
  <li><em>Referenced Sean OMeara’s &amp; Charles Johnson’s latest myface example app</em></li>
</ul>

<p>This is a second article in a series on writing Opscode Chef cookbooks the
Berkshelf Way.  Here’s a link to <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a>.  The source code
examples covered in this article can be found on Github:
<a href="https://github.com/misheska/myface">https://github.com/misheska/myface</a></p>

<p>In this installment, <a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>,
 we’re going to create a new <code>database</code> recipe.  In <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part1</a>
MyFace is just a web application serving up a static page.  Now we’re going to
enhance MyFace so that it stores account information in a persistent 
MySQL database.</p>

<p>Thanks go out to the Opscode Advanced Chef Cookbook Authoring class and specifically 
<a href="https://github.com/someara/myface-cookbook">Sean OMeara and Charles Johnson</a> for the database and PHP code used in this article.</p>

<h1 id="iteration-7---install-mysql">Iteration #7 - Install MySQL</h1>

<p>Edit <code>metadata.rb</code> and add a reference to the <code>mysql</code> cookbook.  Also
bump the version to 2.0.0 because we know that there will be incompatible API
changes, moving to MySQL, per <a href="http://semver.org/">Semantic Versioning</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/metadata.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">name</span>             <span class="s1">&#39;myface&#39;</span>
</span><span class="line"><span class="n">maintainer</span>       <span class="s1">&#39;YOUR_NAME&#39;</span>
</span><span class="line"><span class="n">maintainer_email</span> <span class="s1">&#39;YOUR_EMAIL&#39;</span>
</span><span class="line"><span class="n">license</span>          <span class="s1">&#39;All rights reserved&#39;</span>
</span><span class="line"><span class="n">description</span>      <span class="s1">&#39;Installs/Configures myface&#39;</span>
</span><span class="line"><span class="n">long_description</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;README.md&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">version</span>          <span class="s1">&#39;2.0.0&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;apache2&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.6.0&quot;</span>
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 3.0.0&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a new recipe called <code>recipes/database.rb</code> which includes the MySQL
cookbook’s server recipe (this is a similar abstraction to what you created in
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a>
with <code>recipes/webserver.rb</code>):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/database.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: database</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2012 YOUR_NAME</span>
</span><span class="line"><span class="c1"># </span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;mysql::server&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Wire the <code>database</code> recipe into the MyFace cookbook by adding an
<code>include_recipe</code> reference to <code>recipes/default.rb</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: default</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;myface::database&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;myface::webserver&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Run <code>vagrant provision</code> to converge your changes.</p>

<pre><code>$ vagrant provision
[Berkshelf] Updating Vagrant's berkshelf: '/Users/misheska/.berkshelf/default/vagrant/berkshelf-20130722-92068-1y18eun-default'
[Berkshelf] Using myface (2.0.0)
[Berkshelf] Using apache2 (1.6.6)
[Berkshelf] Using mysql (3.0.2)
[Berkshelf] Using openssl (1.0.2)
[Berkshelf] Using build-essential (1.4.0)
[default] Chef 11.4.4 Omnibus package is already installed.
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-07-22T23:20:39-07:00] INFO: *** Chef 11.4.4 ***
[2013-07-22T23:20:39-07:00] INFO: Setting the run_list to ["recipe[myface::default]"] from JSON
...
[2013-07-22T23:22:15-07:00] INFO: Processing directory[/srv/apache/myface] action create (myface::webserver line 32)
[2013-07-22T23:22:15-07:00] INFO: Processing template[/srv/apache/myface/index.html] action create (myface::webserver line 38)
[2013-07-22T23:22:15-07:00] INFO: Processing execute[a2ensite myface.conf] action run (myface::webserver line 24)
[2013-07-22T23:22:15-07:00] INFO: Chef Run complete in 95.633444455 seconds
[2013-07-22T23:22:15-07:00] INFO: Running report handlers
[2013-07-22T23:22:15-07:00] INFO: Report handlers complete
</code></pre>

<h2 id="testing-iteration-7">Testing Iteration #7</h2>
<p>Verify that the <code>mysqld</code> service is running on your vagrant guest by
running the following command:</p>

<pre><code>$ vagrant ssh -c "sudo /sbin/service mysqld status"
mysqld (pid  7702) is running...
</code></pre>

<p>Also check that MySQL is enabled to start on boot:</p>

<pre><code>$ vagrant ssh -c "sudo /sbin/chkconfig --list | grep mysqld"
mysqld         	0:off	1:off	2:on	3:on	4:on	5:on	6:off
</code></pre>

<p>If the service is set to be activated at runlevels 3 and 5, then MySQL is
enabled to run under full multi-user text mode and full multi-user graphical
mode, which is exactly the desired behavior.</p>

<h1 id="iteration-8---create-the-myface-database">Iteration #8 - Create the MyFace Database</h1>

<p>We’ve installed MySQL, but we don’t have a database yet.  Now we’re going
to create a database to store information about our users with another
cookbook, the <code>database</code> cookbook.</p>

<p>Add the <code>database</code> cookbook as a dependency in the <code>metadata.rb</code> file:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/metadata.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">name</span>             <span class="s1">&#39;myface&#39;</span>
</span><span class="line"><span class="n">maintainer</span>       <span class="s1">&#39;YOUR_NAME&#39;</span>
</span><span class="line"><span class="n">maintainer_email</span> <span class="s1">&#39;YOUR_EMAIL&#39;</span>
</span><span class="line"><span class="n">license</span>          <span class="s1">&#39;All rights reserved&#39;</span>
</span><span class="line"><span class="n">description</span>      <span class="s1">&#39;Installs/Configures myface&#39;</span>
</span><span class="line"><span class="n">long_description</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;README.md&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">version</span>          <span class="s1">&#39;2.0.0&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;apache2&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.6.0&quot;</span>
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 3.0.0&quot;</span>
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.3.0&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Berkshelf automatically populates MySQL passwords for you.  They were
configured in the <code>Vagrantfile</code> when you ran <code>berks cookbook</code> in
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/#create-the-myface-application-cookbook">Part 1</a>:</p>

<pre><code>...
config.vm.provision :chef_solo do |chef|
  chef.json = {
    :mysql =&gt; {
      :server_root_password =&gt; 'rootpass',
      :server_debian_password =&gt; 'debpass',
      :server_repl_password =&gt; "replpass'
    }
  }
  ...
end
...
</code></pre>

<p>You can reference these passwords as variables in your Chef recipes, which we
will do when we add some data attributes.  Add the following attributes to
<code>attributes/default.rb</code> so it looks like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface.conf&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/srv/apache/myface&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:mysql</span><span class="o">][</span><span class="ss">:server_root_password</span><span class="o">]</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myface&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Describe the database to be created for MyFace in <code>recipes/database.rb</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/database.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: database</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2012 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;mysql::server&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;database::mysql&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">mysql_database</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">connection</span><span class="p">(</span>
</span><span class="line">    <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="p">)</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Converge the changes with <code>vagrant provision</code>:</p>

<pre><code>$ vagrant provision
[Berkshelf] Updating Vagrant's berkshelf: '/Users/misheska/.berkshelf/default/vagrant/berkshelf-20130722-92068-1y18eun-default'
[Berkshelf] Using myface (2.0.0)
[Berkshelf] Using apache2 (1.6.6)
[Berkshelf] Using mysql (3.0.2)
[Berkshelf] Using openssl (1.0.2)
[Berkshelf] Using build-essential (1.4.0)
[Berkshelf] Using database (1.3.12)
[Berkshelf] Using postgresql (3.0.2)
[Berkshelf] Using apt (2.0.0)
[Berkshelf] Using aws (0.101.2)
[Berkshelf] Using xfs (1.1.0)
[default] Chef 11.4.4 Omnibus package is already installed.
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-06-25T00:56:36-07:00] INFO: *** Chef 11.4.4 ***
[2013-06-25T00:56:36-07:00] INFO: Setting the run_list to ["recipe[myface::default]"] from JSON
...
[2013-06-25T00:57:43-07:00] INFO: Processing execute[a2ensite myface.conf] action run (myface::webserver line 24)
[2013-06-25T00:57:43-07:00] INFO: Chef Run complete in 66.405200417 seconds
[2013-06-25T00:57:43-07:00] INFO: Running report handlers
[2013-06-25T00:57:43-07:00] INFO: Report handlers complete
</code></pre>

<h2 id="testing-iteration-8">Testing Iteration #8</h2>
<p>Run <code>mysqlshow</code> on your vagrant guest to display database information, verifying
that the <code>myface</code> database was created:</p>

<pre><code>$ vagrant ssh -c "mysqlshow -uroot -prootpass"
+--------------------+
|     Databases      |
+--------------------+
| information_schema |
| myface             |
| mysql              |
| test               |
+--------------------+
</code></pre>

<p>Note that <code>myface</code> is listed as a database name - success!</p>

<h1 id="iteration-9---create-a-mysql-user">Iteration #9 - Create a MySQL user</h1>

<p>It’s a good idea to create a user in MySQL for each one of your applications
that has the ability to only manipulate the application’s database and has 
no MySQL administrative privileges.</p>

<p>Add some attributes to <code>attributes/default.rb</code> for your app user:</p>

<pre><code>default[:myface][:database][:app][:username] = 'myface_app'
default[:myface][:database][:app][:password] = 'supersecret'
</code></pre>

<p><code>attributes/default.rb</code> should look like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface.conf&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/srv/apache/myface&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:mysql</span><span class="o">][</span><span class="ss">:server_root_password</span><span class="o">]</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myface&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myface_app&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;supersecret&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Edit <code>recipes/database.rb</code> and describe the MySQL database user:</p>

<pre><code>...
  )
  action :create
end

mysql_database_user node[:myface][:database][:app][:username] do
  connection(
    :host =&gt; node[:myface][:database][:host],
    :username =&gt; node[:myface][:database][:username],
    :password =&gt; node[:myface][:database][:password]
  )
  password node[:myface][:database][:app][:password]
  database_name node[:myface][:database][:dbname]
  host default[:myface][:database][:host]
  action [:create, :grant]
end
</code></pre>

<p>After editing <code>recipes/database.rb</code> should look like the following:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/database.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: database</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2012 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;mysql::server&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;database::mysql&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">mysql_database</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">connection</span><span class="p">(</span>
</span><span class="line">    <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="p">)</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">mysql_database_user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">connection</span><span class="p">(</span>
</span><span class="line">    <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="p">)</span>
</span><span class="line">  <span class="n">password</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="n">database_name</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span>
</span><span class="line">  <span class="n">host</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span>
</span><span class="line">  <span class="n">action</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:grant</span><span class="o">]</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Converge the node to apply the changes:</p>

<pre><code>$ vagrant provision
</code></pre>

<h2 id="testing-iteration-9">Testing Iteration #9</h2>

<p>Check to see if the <code>myface-app</code> user is enabled as a local user by running the
following mysql command:</p>

<pre><code>$ vagrant ssh -c 'mysql -uroot -prootpass -e "select user,host from mysql.user;"'
user	  host
repl	  %
root	  127.0.0.1
     	  localhost
myface	  localhost
myface_app    localhost
root	  localhost
    	   myface-berkshelf
</code></pre>

<p>As you can see above, the <code>myface_app@localhost</code> user exists, so our cookbook
did what was expected.</p>

<p>Also check to see that the <code>myface_app</code> user only has rights on the myface databse:</p>

<pre><code>$ vagrant ssh -c 'mysql -uroot -prootpass -e "show grants for 'myface_app'@'localhost';"'
Grants for myface_app@localhost
GRANT USAGE ON *.* TO 'myface_app'@'localhost' IDENTIFIED BY PASSWORD '*90BA3AC0BFDE07AE334CA523CB27167AE33825B9'
GRANT ALL PRIVILEGES ON `myface`.* TO 'myface_app'@'localhost'
</code></pre>

<h1 id="iteration-10---create-a-table-for-users">Iteration #10 - Create a table for users</h1>

<p>Let’s create a SQL script to create a table modeling MyFace users and
populate it with some initial data.  Create a file 
<code>files/default/myface-create.sql</code> with the following content:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/files/default/myface-create.sql  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="cm">/* A table for myface users */</span>
</span><span class="line">
</span><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span><span class="p">(</span>
</span><span class="line"> <span class="n">id</span> <span class="nb">CHAR</span> <span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line"> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span class="line"> <span class="n">user_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
</span><span class="line"> <span class="n">url</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span class="line"> <span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
</span><span class="line"> <span class="n">neck_beard</span> <span class="nb">INTEGER</span>
</span><span class="line"><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="cm">/* Initial records */</span>
</span><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">neck_beard</span> <span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="n">uuid</span><span class="p">(),</span> <span class="s1">&#39;jtimberman&#39;</span><span class="p">,</span> <span class="s1">&#39;http://jtimberman.housepub.org&#39;</span><span class="p">,</span> <span class="s1">&#39;joshua@opscode.com&#39;</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>
</span><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">neck_beard</span> <span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="n">uuid</span><span class="p">(),</span> <span class="s1">&#39;someara&#39;</span><span class="p">,</span> <span class="s1">&#39;http://blog.afistfulofservers.net/&#39;</span><span class="p">,</span> <span class="s1">&#39;someara@opscode.com&#39;</span><span class="p">,</span> <span class="mi">5</span> <span class="p">);</span>
</span><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">neck_beard</span> <span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="n">uuid</span><span class="p">(),</span> <span class="s1">&#39;jwinsor&#39;</span><span class="p">,</span> <span class="s1">&#39;http://vialstudios.com&#39;</span><span class="p">,</span> <span class="s1">&#39;jamie@vialstudios.com&#39;</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>
</span><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">neck_beard</span> <span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="n">uuid</span><span class="p">(),</span> <span class="s1">&#39;cjohnson&#39;</span><span class="p">,</span> <span class="s1">&#39;http://www.chipadeedoodah.com/&#39;</span><span class="p">,</span> <span class="s1">&#39;charles@opscode.com&#39;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
</span><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">neck_beard</span> <span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="n">uuid</span><span class="p">(),</span> <span class="s1">&#39;mbower&#39;</span><span class="p">,</span> <span class="s1">&#39;http://www.webbower.com/&#39;</span><span class="p">,</span> <span class="s1">&#39;matt@webbower.com&#39;</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Add an attribute for the temporary location used for the SQL script we just
created:</p>

<pre><code>default[:myface][:database][:seed_file] = '/tmp/myface-create.sql'
</code></pre>

<p>The resultant <code>attributes/default.rb</code> should resemble the following:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface.conf&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/srv/apache/myface&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:mysql</span><span class="o">][</span><span class="ss">:server_root_password</span><span class="o">]</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myface&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myface_app&#39;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;supersecret&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:seed_file</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;/tmp/myface-create.sql&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Modify <code>recipes/database.rb</code> so that the cookbook transfers the SQL script
to the guest node and so that the SQL script executes.  As you learned in
Part 1, <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/#testing-iteration-1">recipes should be idempotent</a>,
so you will need to add a <code>not_if</code> statement which ensures that the command
is only executed when necessary.</p>

<pre><code>...
  host "localhost"
  action [:create, :grant]
end

# Write schema seed file to filesystem
cookbook_file node[:myface][:database][:seed_file] do
  source "myface-init.sql"
  owner "root"
  group "root"
  mode "0600"
end

# Seed database with test data
execute "initialize myface database" do
  command "mysql -h #{node[:myface][:database][:host]} -u #{node[:myface][:database][:app][:username]} -p#{node[:myface][:database][:app][:password]} -D #{node[:myface][:database][:dbname]} &lt; #{node[:myface][:database][:seed_file]}"
  not_if  "mysql -h #{node[:myface][:database][:host]} -u #{node[:myface][:database][:app][:username]} -p#{node[:myface][:database][:app][:password]} -D #{node[:myface][:database][:dbname]} -e 'describe users;'"
end
</code></pre>

<p>Once you have made these changes, <code>recipes/database.rb</code> should look like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/database.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: database</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2012 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;mysql::server&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;database::mysql&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">mysql_database</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">connection</span><span class="p">(</span>
</span><span class="line">    <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="p">)</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">mysql_database_user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">connection</span><span class="p">(</span>
</span><span class="line">    <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="p">)</span>
</span><span class="line">  <span class="n">password</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</span><span class="line">  <span class="n">database_name</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span>
</span><span class="line">  <span class="n">host</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span>
</span><span class="line">  <span class="n">action</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:grant</span><span class="o">]</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># Write schema seed file to filesystem</span>
</span><span class="line"><span class="n">cookbook_file</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:seed_file</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;myface-create.sql&quot;</span>
</span><span class="line">  <span class="n">owner</span> <span class="s2">&quot;root&quot;</span>
</span><span class="line">  <span class="n">group</span> <span class="s2">&quot;root&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0600&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># Seed database with test data</span>
</span><span class="line"><span class="n">execute</span> <span class="s2">&quot;initialize myface database&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">command</span> <span class="s2">&quot;mysql -h </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="si">}</span><span class="s2"> -u </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span><span class="s2"> -p</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="si">}</span><span class="s2"> -D </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:seed_file</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">  <span class="n">not_if</span>  <span class="s2">&quot;mysql -h </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:host</span><span class="o">]</span><span class="si">}</span><span class="s2"> -u </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span><span class="s2"> -p</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:app</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="si">}</span><span class="s2"> -D </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:database</span><span class="o">][</span><span class="ss">:dbname</span><span class="o">]</span><span class="si">}</span><span class="s2"> -e &#39;describe users;&#39;&quot;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Run <code>vagrant provision</code> to converge your changes:</p>

<pre><code>$ vagrant provision
</code></pre>

<h2 id="testing-iteration-10">Testing Iteration #10</h2>

<p>Run the following mysql command to dump the contents of the <code>users</code> table:</p>

<pre><code>$ vagrant ssh -c 'mysql -hlocalhost -umyface -psupersecret -Dmyface -e "select id,user_name from users;"'
id	user_name
53971762-f36e-11e2-b889-080027cf	jtimberman
539720d6-f36e-11e2-b889-080027cf	someara
53972464-f36e-11e2-b889-080027cf	jwinsor
539727a2-f36e-11e2-b889-080027cf	cjohnson
53972ad6-f36e-11e2-b889-080027cf	mbower
</code></pre>

<p>The output should look similar to what you see above - the data from the
<code>INSERT INTO</code> statemens in the SQL script.</p>

<h1 id="iteration-11---install-php">Iteration #11 - Install PHP</h1>

<p>Let’s add some PHP scripting sizzle to sell the steak of the database we
just created.  We’re going to install Apache 2 <code>mod_php5</code> module and the
<code>php-mysql</code> package to support our PHP script.</p>

<p>Edit <code>recipes/webserver.rb</code> and add the following:</p>

<pre><code>...
include_recipe "apache2"
include_recipe "apache2::mod_php5"

package "php-mysql" do
  action :install
  notifies :restart, "service[apache2]"
end
</code></pre>

<p>This will use the apache2 cookbook’s <code>mod_php5</code> module to install PHP5
and install the <code>php-mysql</code> support package.  After editing,
<code>recipes/webserver.rb</code> should look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/webserver.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: webserver</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2::mod_php5&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">package</span> <span class="s2">&quot;php-mysql&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:install</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[apache2]&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># disable default site</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;000-default&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">false</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create apache config</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;apache2.conf.erb&quot;</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[apache2]&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create document root</span>
</span><span class="line"><span class="n">directory</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line">  <span class="n">recursive</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># write site</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">/index.html&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;index.html.erb&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># enable myface</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Run <code>vagrant provision</code> to converge your changes:</p>

<pre><code>$ vagrant provision
</code></pre>

<h2 id="test-iteration-11">Test Iteration #11</h2>

<p>Run the following command to verify that the php5_module was successfully
installed:</p>

<pre><code>$ vagrant ssh -c "sudo /usr/sbin/httpd -M | grep php5"
httpd: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for ServerName
[Sun Jun 30 09:58:35 2013] [warn] NameVirtualHost *:80 has no VirtualHosts
Syntax OK
 php5_module (shared)
</code></pre>

<h1 id="iteration-12---add-php-sizzle">Iteration #12 - Add PHP Sizzle</h1>

<p>It’s the last iteration, get ready to see the PHP sizzle!  First modify
<code>templates/default/apache2.conf.erb</code> as follows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/templates/default/apache2.conf.erb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># Managed by Chef for &lt;%= node[&#39;hostname&#39;] %&gt;</span>
</span><span class="line"><span class="o">&lt;</span><span class="no">VirtualHost</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span><span class="o">&gt;</span>
</span><span class="line">        <span class="no">ServerAdmin</span> <span class="o">&lt;</span><span class="sx">%= node[&#39;apache&#39;][&#39;contact&#39;] %&gt;</span>
</span><span class="line">
</span><span class="line"><span class="sx">        DocumentRoot /srv/apache/myface</span>
</span><span class="line"><span class="sx">        &lt;Directory /&gt;</span>
</span><span class="line"><span class="sx">                Options FollowSymLinks</span>
</span><span class="line"><span class="sx">                AllowOverride None</span>
</span><span class="line"><span class="sx">        &lt;/Directory&gt;</span>
</span><span class="line"><span class="sx">        &lt;Directory /srv/apache/myface&gt;</span>
</span><span class="line"><span class="sx">                Options Indexes FollowSymLinks MultiViews</span>
</span><span class="line"><span class="sx">                AllowOverride None</span>
</span><span class="line"><span class="sx">                Order allow,deny</span>
</span><span class="line"><span class="sx">                allow from all</span>
</span><span class="line"><span class="sx">        &lt;/Directory&gt;</span>
</span><span class="line">
</span><span class="line"><span class="sx">        ErrorLog &lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;apache&#39;</span><span class="o">][</span><span class="s1">&#39;log_dir&#39;</span><span class="o">]</span> <span class="sx">%&gt;/error.log</span>
</span><span class="line">
</span><span class="line"><span class="sx">        LogLevel warn</span>
</span><span class="line">
</span><span class="line"><span class="sx">        CustomLog &lt;%= node[&#39;apache&#39;][&#39;log_dir&#39;] %&gt;</span><span class="sr">/access.log combined</span>
</span><span class="line"><span class="sr">        ServerSignature Off</span>
</span><span class="line"><span class="sr">&lt;/</span><span class="no">VirtualHost</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Next delete <code>templates/default/index.html.erb</code> with the following command:</p>

<pre><code>$ rm templates/default/index.html.erb`
</code></pre>

<p>You’ll be replacing it with the following parametized PHP script as
<code>templates/default/index.php.erb</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/templates/default/index.php.erb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
<span class="line-number">134</span>
<span class="line-number">135</span>
<span class="line-number">136</span>
<span class="line-number">137</span>
<span class="line-number">138</span>
<span class="line-number">139</span>
<span class="line-number">140</span>
<span class="line-number">141</span>
<span class="line-number">142</span>
<span class="line-number">143</span>
<span class="line-number">144</span>
<span class="line-number">145</span>
<span class="line-number">146</span>
<span class="line-number">147</span>
<span class="line-number">148</span>
<span class="line-number">149</span>
<span class="line-number">150</span>
<span class="line-number">151</span>
<span class="line-number">152</span>
<span class="line-number">153</span>
<span class="line-number">154</span>
<span class="line-number">155</span>
<span class="line-number">156</span>
<span class="line-number">157</span>
<span class="line-number">158</span>
<span class="line-number">159</span>
<span class="line-number">160</span>
<span class="line-number">161</span>
<span class="line-number">162</span>
<span class="line-number">163</span>
<span class="line-number">164</span>
<span class="line-number">165</span>
<span class="line-number">166</span>
<span class="line-number">167</span>
<span class="line-number">168</span>
<span class="line-number">169</span>
<span class="line-number">170</span>
<span class="line-number">171</span>
<span class="line-number">172</span>
<span class="line-number">173</span>
<span class="line-number">174</span>
<span class="line-number">175</span>
<span class="line-number">176</span>
<span class="line-number">177</span>
<span class="line-number">178</span>
<span class="line-number">179</span>
<span class="line-number">180</span>
<span class="line-number">181</span>
<span class="line-number">182</span>
<span class="line-number">183</span>
<span class="line-number">184</span>
<span class="line-number">185</span>
<span class="line-number">186</span>
<span class="line-number">187</span>
<span class="line-number">188</span>
<span class="line-number">189</span>
<span class="line-number">190</span>
<span class="line-number">191</span>
<span class="line-number">192</span>
<span class="line-number">193</span>
<span class="line-number">194</span>
<span class="line-number">195</span>
<span class="line-number">196</span>
<span class="line-number">197</span>
<span class="line-number">198</span>
<span class="line-number">199</span>
<span class="line-number">200</span>
<span class="line-number">201</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">&lt;!--</span>
</span><span class="line"><span class="no">Copyright</span> <span class="mi">2013</span><span class="p">,</span> <span class="no">Opscode</span><span class="p">,</span> <span class="no">Inc</span><span class="o">.</span>
</span><span class="line">
</span><span class="line"><span class="no">Licensed</span> <span class="n">under</span> <span class="n">the</span> <span class="no">Apache</span> <span class="no">License</span><span class="p">,</span> <span class="no">Version</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">the</span> <span class="s2">&quot;License&quot;</span><span class="p">);</span>
</span><span class="line"><span class="n">you</span> <span class="n">may</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">this</span> <span class="n">file</span> <span class="n">except</span> <span class="k">in</span> <span class="n">compliance</span> <span class="n">with</span> <span class="n">the</span> <span class="no">License</span><span class="o">.</span>
</span><span class="line"><span class="no">You</span> <span class="n">may</span> <span class="n">obtain</span> <span class="n">a</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="no">License</span> <span class="n">at</span>
</span><span class="line">
</span><span class="line">    <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">www</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">licenses</span><span class="o">/</span><span class="no">LICENSE</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span>
</span><span class="line"><span class="no">Unless</span> <span class="n">required</span> <span class="n">by</span> <span class="n">applicable</span> <span class="n">law</span> <span class="ow">or</span> <span class="n">agreed</span> <span class="n">to</span> <span class="k">in</span> <span class="n">writing</span><span class="p">,</span> <span class="n">software</span>
</span><span class="line"><span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="no">License</span> <span class="n">is</span> <span class="n">distributed</span> <span class="n">on</span> <span class="n">an</span> <span class="s2">&quot;AS IS&quot;</span> <span class="no">BASIS</span><span class="p">,</span>
</span><span class="line"><span class="no">WITHOUT</span> <span class="no">WARRANTIES</span> <span class="no">OR</span> <span class="no">CONDITIONS</span> <span class="no">OF</span> <span class="no">ANY</span> <span class="no">KIND</span><span class="p">,</span> <span class="n">either</span> <span class="n">express</span> <span class="ow">or</span> <span class="n">implied</span><span class="o">.</span>
</span><span class="line"><span class="no">See</span> <span class="n">the</span> <span class="no">License</span> <span class="k">for</span> <span class="n">the</span> <span class="n">specific</span> <span class="n">language</span> <span class="n">governing</span> <span class="n">permissions</span> <span class="ow">and</span>
</span><span class="line"><span class="n">limitations</span> <span class="n">under</span> <span class="n">the</span> <span class="no">License</span><span class="o">.</span>
</span><span class="line">
</span><span class="line"><span class="o">--&gt;</span>
</span><span class="line">
</span><span class="line"><span class="o">&lt;</span><span class="p">?</span><span class="n">php</span>
</span><span class="line"><span class="vg">$db_host</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
</span><span class="line"><span class="vg">$db_user</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">;</span>
</span><span class="line"><span class="vg">$db_pwd</span> <span class="o">=</span> <span class="s1">&#39;&lt;%= node[&#39;</span><span class="n">mysql</span><span class="s1">&#39;][&#39;</span><span class="n">server_root_password</span><span class="s1">&#39;] %&gt;&#39;</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="vg">$database</span> <span class="o">=</span> <span class="s1">&#39;myface&#39;</span><span class="p">;</span>
</span><span class="line"><span class="vg">$table</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="sr">//</span> <span class="no">UTILITY</span> <span class="no">FUNCTIONS</span>
</span><span class="line"><span class="n">function</span> <span class="n">create_gravatar_hash</span><span class="p">(</span><span class="vg">$email</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="n">md5</span><span class="p">(</span> <span class="n">strtolower</span><span class="p">(</span> <span class="n">trim</span><span class="p">(</span> <span class="vg">$email</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">function</span> <span class="n">gravatar_img</span><span class="p">(</span><span class="vg">$email</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="vg">$name</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="vg">$size</span><span class="o">=</span><span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="vg">$email</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">		<span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	
</span><span class="line">	<span class="vg">$url</span> <span class="o">=</span>  <span class="s1">&#39;http://www.gravatar.com/avatar/&#39;</span><span class="p">;</span>
</span><span class="line">	<span class="vg">$url</span> <span class="o">.</span><span class="n">=</span> <span class="n">create_gravatar_hash</span><span class="p">(</span><span class="vg">$email</span><span class="p">);</span>
</span><span class="line">	<span class="k">if</span><span class="p">(</span><span class="vg">$size</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">		<span class="vg">$url</span> <span class="o">.</span><span class="n">=</span> <span class="s2">&quot;?s={$size}&quot;</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	
</span><span class="line">	<span class="k">return</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&quot;%s&quot; alt=&quot;%s&quot; /&gt;&#39;</span><span class="p">,</span> <span class="vg">$url</span><span class="p">,</span> <span class="vg">$name</span> <span class="p">?</span> <span class="vg">$name</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">function</span> <span class="n">neckbeard</span><span class="p">(</span><span class="vg">$rating</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="vg">$ratings</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span>
</span><span class="line">		<span class="s1">&#39;Puberty awaits!&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="s1">&#39;Peach fuzz&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="s1">&#39;Solid week&amp;#39;s growth&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="s1">&#39;Lumberjacks would be proud&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="s1">&#39;Makes dwarves weep&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="p">);</span>
</span><span class="line">	
</span><span class="line">	<span class="k">return</span> <span class="vg">$ratings</span><span class="o">[</span><span class="p">(</span><span class="n">int</span><span class="p">)</span> <span class="vg">$rating</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="sr">//</span> <span class="no">Fire</span> <span class="n">up</span> <span class="n">the</span> <span class="n">database</span>
</span><span class="line"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mysql_connect</span><span class="p">(</span><span class="vg">$db_host</span><span class="p">,</span> <span class="vg">$db_user</span><span class="p">,</span> <span class="vg">$db_pwd</span><span class="p">))</span>
</span><span class="line">    <span class="n">die</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect to database&quot;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mysql_select_db</span><span class="p">(</span><span class="vg">$database</span><span class="p">))</span>
</span><span class="line">    <span class="n">die</span><span class="p">(</span><span class="s2">&quot;Can&#39;t select database&quot;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="sr">//</span> <span class="n">sending</span> <span class="n">query</span>
</span><span class="line"><span class="vg">$result</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM {$table}&quot;</span><span class="p">);</span>
</span><span class="line"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="vg">$result</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="n">die</span><span class="p">(</span><span class="s2">&quot;Query to show fields from table failed&quot;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="vg">$fields_num</span> <span class="o">=</span> <span class="n">mysql_num_fields</span><span class="p">(</span><span class="vg">$result</span><span class="p">);</span>
</span><span class="line"><span class="sc">?&gt;</span>
</span><span class="line"><span class="o">&lt;!</span><span class="no">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="no">MyFace</span> <span class="no">Users</span><span class="o">&lt;</span><span class="sr">/title&gt;</span>
</span><span class="line"><span class="sr">	&lt;style&gt;</span>
</span><span class="line"><span class="sr">	* {</span>
</span><span class="line"><span class="sr">		-webkit-box-sizing: border-box;</span>
</span><span class="line"><span class="sr">		-moz-box-sizing: border-box;</span>
</span><span class="line"><span class="sr">		box-sizing: border-box;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	html, body {</span>
</span><span class="line"><span class="sr">		margin: 0;</span>
</span><span class="line"><span class="sr">		padding: 0;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	html {</span>
</span><span class="line"><span class="sr">		background: #999;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	body {</span>
</span><span class="line"><span class="sr">		max-width: 480px;</span>
</span><span class="line"><span class="sr">		margin: 0 auto;</span>
</span><span class="line"><span class="sr">		font-family: Arial, Helvetica, sans-serif;</span>
</span><span class="line"><span class="sr">		color: #222;</span>
</span><span class="line"><span class="sr">		padding: 20px;</span>
</span><span class="line"><span class="sr">		border: 1px solid #666;</span>
</span><span class="line"><span class="sr">		-webkit-box-shadow: 0 0 5px rgba(0,0,0,0.3);</span>
</span><span class="line"><span class="sr">		-moz-box-shadow: 0 0 5px rgba(0,0,0,0.3);</span>
</span><span class="line"><span class="sr">		box-shadow: 0 0 5px rgba(0,0,0,0.3);</span>
</span><span class="line"><span class="sr">		background: #FFF;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">		</span>
</span><span class="line"><span class="sr">	a:link {</span>
</span><span class="line"><span class="sr">		text-decoration: none;</span>
</span><span class="line"><span class="sr">		color: #777;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	a:hover,</span>
</span><span class="line"><span class="sr">	a:focus {</span>
</span><span class="line"><span class="sr">		text-decoration: underline;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	h1 {</span>
</span><span class="line"><span class="sr">		text-align: center;</span>
</span><span class="line"><span class="sr">		margin-top: 0;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">		</span>
</span><span class="line"><span class="sr">	h1 span {</span>
</span><span class="line"><span class="sr">		color: #00C;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	h2 {</span>
</span><span class="line"><span class="sr">		font-size: 24px;</span>
</span><span class="line"><span class="sr">		line-height: 1.0;</span>
</span><span class="line"><span class="sr">		margin: 0 0 10px;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	p {</span>
</span><span class="line"><span class="sr">		font-size: 14px;</span>
</span><span class="line"><span class="sr">		line-height: 18px;</span>
</span><span class="line"><span class="sr">		margin: 10px 0;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	p:last-child {</span>
</span><span class="line"><span class="sr">		margin-bottom: 0;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	.email {</span>
</span><span class="line"><span class="sr">		display: block;</span>
</span><span class="line"><span class="sr">		overflow: hidden;</span>
</span><span class="line"><span class="sr">		text-overflow: ellipsis;</span>
</span><span class="line"><span class="sr">		white-space: nowrap;</span>
</span><span class="line"><span class="sr">	}</span>
</span><span class="line"><span class="sr">	</span>
</span><span class="line"><span class="sr">	/</span><span class="o">*</span> <span class="no">Adapted</span> <span class="n">from</span> <span class="no">OOCSS</span>
</span><span class="line">		<span class="o">*</span> <span class="n">mod</span> <span class="n">object</span> <span class="p">(</span><span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">stubbornella</span><span class="o">/</span><span class="n">oocss</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">module</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">css</span><span class="p">)</span>
</span><span class="line">		<span class="o">*</span> <span class="n">media</span> <span class="n">object</span> <span class="p">(</span><span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">stubbornella</span><span class="o">/</span><span class="n">oocss</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">media</span><span class="o">.</span><span class="n">css</span><span class="p">)</span>
</span><span class="line">	<span class="o">*/</span>
</span><span class="line">	<span class="n">article</span> <span class="p">{</span>
</span><span class="line">		<span class="nb">display</span><span class="p">:</span> <span class="n">block</span><span class="p">;</span>
</span><span class="line">		<span class="ss">overflow</span><span class="p">:</span> <span class="n">hidden</span><span class="p">;</span>
</span><span class="line">		<span class="n">margin</span><span class="o">-</span><span class="ss">bottom</span><span class="p">:</span> <span class="mi">20</span><span class="n">px</span><span class="p">;</span>
</span><span class="line">		<span class="ss">border</span><span class="p">:</span> <span class="mi">1</span><span class="n">px</span> <span class="n">solid</span> <span class="c1">#CCC;</span>
</span><span class="line">		<span class="ss">background</span><span class="p">:</span> <span class="c1">#EEE;</span>
</span><span class="line">		<span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">border</span><span class="o">-</span><span class="ss">radius</span><span class="p">:</span> <span class="mi">4</span><span class="n">px</span><span class="p">;</span>
</span><span class="line">		<span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">border</span><span class="o">-</span><span class="ss">radius</span><span class="p">:</span> <span class="mi">4</span><span class="n">px</span><span class="p">;</span>
</span><span class="line">		<span class="n">border</span><span class="o">-</span><span class="ss">radius</span><span class="p">:</span> <span class="mi">4</span><span class="n">px</span><span class="p">;</span>
</span><span class="line">		<span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">box</span><span class="o">-</span><span class="ss">shadow</span><span class="p">:</span> <span class="mi">1</span><span class="n">px</span> <span class="mi">1</span><span class="n">px</span> <span class="mi">1</span><span class="n">px</span> <span class="n">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="n">inset</span><span class="p">;</span>
</span><span class="line">		<span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">box</span><span class="o">-</span><span class="ss">shadow</span><span class="p">:</span> <span class="mi">1</span><span class="n">px</span> <span class="mi">1</span><span class="n">px</span> <span class="mi">1</span><span class="n">px</span> <span class="n">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="n">inset</span><span class="p">;</span>
</span><span class="line">		<span class="n">box</span><span class="o">-</span><span class="ss">shadow</span><span class="p">:</span> <span class="mi">1</span><span class="n">px</span> <span class="mi">1</span><span class="n">px</span> <span class="mi">1</span><span class="n">px</span> <span class="n">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="n">inset</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">
</span><span class="line">	<span class="n">article</span> <span class="o">.</span><span class="n">img</span> <span class="p">{</span>
</span><span class="line">		<span class="ss">float</span><span class="p">:</span> <span class="n">left</span><span class="p">;</span>
</span><span class="line">		<span class="n">margin</span><span class="o">-</span><span class="ss">right</span><span class="p">:</span> <span class="mi">10</span><span class="n">px</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	
</span><span class="line">	<span class="n">article</span> <span class="o">.</span><span class="n">img</span> <span class="n">img</span> <span class="p">{</span>
</span><span class="line">		<span class="nb">display</span><span class="p">:</span> <span class="n">block</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	
</span><span class="line">	<span class="n">article</span> <span class="o">.</span><span class="n">imgExt</span> <span class="p">{</span>
</span><span class="line">		<span class="ss">float</span><span class="p">:</span> <span class="n">right</span><span class="p">;</span>
</span><span class="line">		<span class="n">margin</span><span class="o">-</span><span class="ss">left</span><span class="p">:</span> <span class="mi">10</span><span class="n">px</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">
</span><span class="line">	<span class="n">article</span> <span class="o">.</span><span class="n">bd</span> <span class="p">{</span>
</span><span class="line">		<span class="ss">overflow</span><span class="p">:</span> <span class="n">hidden</span><span class="p">;</span>
</span><span class="line">		<span class="ss">padding</span><span class="p">:</span> <span class="mi">10</span><span class="n">px</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="o">&lt;</span><span class="sr">/style&gt;</span>
</span><span class="line"><span class="sr">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Welcome</span> <span class="n">to</span> <span class="no">My</span><span class="o">&lt;</span><span class="n">span</span><span class="o">&gt;</span><span class="no">Face</span><span class="o">&lt;</span><span class="sr">/span&gt;!&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line">	<span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="k">while</span><span class="p">(</span><span class="vg">$row</span> <span class="o">=</span> <span class="n">mysql_fetch_object</span><span class="p">(</span><span class="vg">$result</span><span class="p">)):</span> <span class="sc">?&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="n">article</span><span class="o">&gt;</span>
</span><span class="line">		<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;&lt;?php echo $row-&gt;url ?&gt;&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;img&quot;</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;_blank&quot;</span><span class="o">&gt;</span>
</span><span class="line">			<span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="n">echo</span> <span class="n">gravatar_img</span><span class="p">(</span><span class="vg">$row</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">,</span> <span class="vg">$row</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span> <span class="sc">?&gt;</span>
</span><span class="line">		<span class="o">&lt;</span><span class="sr">/a&gt;</span>
</span><span class="line"><span class="sr">		&lt;div class=&quot;bd&quot;&gt;</span>
</span><span class="line"><span class="sr">			&lt;h2&gt;&lt;?php echo $row-&gt;user_name ?&gt;&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
</span><span class="line">			<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;&lt;?php echo $row-&gt;url ?&gt;&quot;</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;_blank&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="o">&gt;&lt;</span><span class="p">?</span><span class="n">php</span> <span class="n">echo</span> <span class="vg">$row</span><span class="o">-&gt;</span><span class="n">url</span> <span class="sc">?&gt;</span><span class="o">&lt;</span><span class="sr">/a&gt;&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class="line">			<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">Neckbeard</span> <span class="ss">rating</span><span class="p">:</span> <span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="n">echo</span> <span class="n">neckbeard</span><span class="p">(</span><span class="vg">$row</span><span class="o">-&gt;</span><span class="n">neck_beard</span><span class="p">)</span> <span class="sc">?&gt;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class="line"><span class="sr">		&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="sr">/article&gt;</span>
</span><span class="line"><span class="sr">	&lt;?php endwhile; ?&gt;</span>
</span><span class="line"><span class="sr">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">&lt;</span><span class="sr">/html&gt;</span>
</span><span class="line"><span class="sr">&lt;?php mysql_free_result($result); ?&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally modify <code>recipes/webserver.rb</code> to use <code>index.php.erb</code> template to 
generate a new <code>index.php</code> document root: </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/webserver.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: webserver</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2::mod_php5&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">package</span> <span class="s2">&quot;php-mysql&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:install</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[apache2]&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># disable default site</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;000-default&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">false</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create apache config</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;apache2.conf.erb&quot;</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[apache2]&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create document root</span>
</span><span class="line"><span class="n">directory</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0755&quot;</span>
</span><span class="line">  <span class="n">recursive</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># write site</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">/index.php&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;index.php.erb&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># enable myface</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Since we changed the document root and our recipe contains no statements to
remove the old <code>index.html</code> document root, we’ll need to destroy our vagrant
test node and do a full <code>vagrant up</code> again, otherwise if we visit
<a href="http://33.33.33.10">http://33.33.33.10</a> again, we’ll just see the old document root:</p>

<pre><code>$ vagrant destroy -f
$ vagrant up
</code></pre>

<h2 id="testing-iteration-12">Testing Iteration #12</h2>

<p>Visit <a href="http://33.33.33.10">http://33.33.33.10</a>  Now you should see the lovely new PHP version of
Myface.</p>

<p><img src="/images/myfacephp.png" alt="myfacephp" /></p>

<h1 id="more-to-come">More to Come!</h1>

<p>In Part 3, we’ll introduce a new tool <code>test-kitchen</code> and show you how to
automate all the tests you’ve been doing manually to test each iteration.</p>

<p>If you want to see the full source for MyFace, check out the following
GitHub link: <a href="https://github.com/misheska/myface">https://github.com/misheska/myface</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-16T03:49:00-07:00" pubdate data-updated="true">Jun 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#getting-started">Getting Started</a>    <ul>
      <li><a href="#upgrade-from-berkshelf-1x">Upgrade from Berkshelf 1.x</a></li>
    </ul>
  </li>
  <li><a href="#create-the-myface-application-cookbook">Create the MyFace Application Cookbook</a></li>
  <li><a href="#prepare-a-virtual-machine-for-testing">Prepare a virtual machine for testing</a></li>
  <li><a href="#iteration-1-create-an-application-user">Iteration #1: Create an application user</a>    <ul>
      <li><a href="#testing-iteration-1">Testing Iteration #1</a></li>
    </ul>
  </li>
  <li><a href="#iteration-2---refactor-to-attributes">Iteration #2 - Refactor to attributes</a>    <ul>
      <li><a href="#testing-iteration-2">Testing Iteration #2</a></li>
    </ul>
  </li>
  <li><a href="#iteration-3---install-the-apache2-web-server">Iteration #3 - Install the Apache2 Web Server</a>    <ul>
      <li><a href="#testing-iteration-3">Testing Iteration #3</a></li>
    </ul>
  </li>
  <li><a href="#iteration-4---add-content">Iteration #4 - Add Content</a>    <ul>
      <li><a href="#testing-iteration-4">Testing Iteration #4</a></li>
    </ul>
  </li>
  <li><a href="#iteration-5---refactoring-webserver">Iteration #5 - Refactoring webserver</a>    <ul>
      <li><a href="#testing-iteration-5">Testing Iteration #5</a></li>
    </ul>
  </li>
  <li><a href="#iteration-6---version-bump-and-production-deploy">Iteration #6 - Version Bump and Production Deploy</a>    <ul>
      <li><a href="#version-bump-to-100">Version Bump to 1.0.0</a></li>
      <li><a href="#configure-berkshelf">Configure Berkshelf</a></li>
      <li><a href="#upload-cookbooks">Upload cookbooks</a></li>
      <li><a href="#converge-node">Converge node</a></li>
      <li><a href="#testing-iteration-6">Testing Iteration #6</a></li>
    </ul>
  </li>
  <li><a href="#more-to-come">More to Come!</a></li>
</ul>

<p><em>Updated August 7th, 2013</em></p>

<ul>
  <li><em>Bumped vagrant from version 1.2.4 to 1.2.7</em></li>
  <li><em>Bumped berkshelf from version 2.0.7 to 2.0.8</em></li>
  <li><em>Berkshelf 2.0.8 currently needs a version constraint for test-kitchen - added</em></li>
</ul>

<p><em>Updated July 22nd, 2013</em></p>

<ul>
  <li><em>Bumped vagrant from version 1.2.3 to 1.2.4</em></li>
  <li><em>Bumped berkshelf from version 2.0.6 to 2.0.7</em></li>
  <li><em>Referenced Sean O’Meara’s &amp; Charles Johnson’s latest myface example app</em></li>
</ul>

<p><em>Updated July 9th, 2013</em></p>

<ul>
  <li><em>Bumped vagrant from version 1.2.2 to 1.2.3</em></li>
  <li><em>Bumped berkshelf from version 2.0.5 to 2.0.6</em></li>
  <li><em>Bumped VirtualBox from version 4.2.12 to 4.2.16</em></li>
  <li><em>Berkshelf 2.0.6 no longer needs the version constraint for test-kitchen - removed</em></li>
</ul>

<p>Jamie Winsor hasn’t yet updated his <a href="http://vialstudios.com/guide-authoring-cookbooks.html">guide to authoring cookbooks the Berkshelf way</a>
to match <a href="https://github.com/RiotGames/berkshelf/issues/416">recent changes related to Vagrant 1.x</a> and <a href="http://www.opscode.com/blog/2013/03/11/chef-11-server-up-and-running/">Chef 11</a>
This post is an attempt to update these instructions, walking through his
and Sean O’Meara’s example app - <a href="https://github.com/someara/myface-cookbook">MyFace</a>.
For more information on <a href="http://berkshelf.com/">Berkshelf</a>, check out his recent
<a href="http://www.youtube.com/watch?v=hYt0E84kYUI">talk</a>
and <a href="http://www.slideshare.net/resetexistence/the-berkshelf-way">slides</a>
from ChefConf 2013.</p>

<p>NOTE: The source code examples covered in this article can be found on
GitHub: <a href="https://github.com/misheska/myface">https://github.com/misheska/myface</a></p>

<h1 id="getting-started">Getting Started</h1>
<p>You can write Chef Cookbooks with Berkshelf on Mac OS X, Linux or Windows.
To set up your cookbook-writing environment, make sure you have the following
installed:</p>

<ul>
  <li>
    <p><a href="http://virtualbox.org">Install VirtualBox 4.2.x (or higher)</a>
NOTE: Avoid VirtualBox 4.2.14, <a href="https://twitter.com/mitchellh/status/348886504728305664">it breaks vagrant</a>.  VirtualBox 4.2.16 was tested for
this post.</p>
  </li>
  <li>
    <p><a href="http://vagrantup.com">Install Vagrant 1.2.1 (or higher)</a>.  Vagrant 1.2.7 was tested for this post.</p>
  </li>
  <li>
    <p>Install Ruby 1.9.x via <a href="http://misheska.com/blog/2013/06/16/use-opscode-chef-omnibus-ruby-for-writing-cookbooks/">Chef Omnibus Installer Ruby</a>, <a href="http://misheska.com/blog/2013/06/16/using-rvm-to-manage-multiple-versions-of-ruby/">rvm</a> or <a href="http://misheska.com/blog/2013/06/15/using-rbenv-to-manage-multiple-versions-of-ruby/">rbenv</a></p>
  </li>
  <li>
    <p>Install Berkshelf</p>
  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$ gem install berkshelf --no-ri --no-rdoc
</span><span class="line">Fetching: berkshelf-2.0.8.gem (100%)
</span><span class="line">Successfully installed berkshelf-2.0.8
</span><span class="line">1 gem installed
</span><span class="line">
</span><span class="line">$ berks -v
</span><span class="line">Berkshelf (2.0.8)
</span><span class="line">
</span><span class="line">Copyright 2012-2013 Riot Games
</span><span class="line">
</span><span class="line">    Jamie Winsor (&lt;jamie@vialstudios.com&gt;)
</span><span class="line">    Josiah Kiehl (&lt;jkiehl@riotgames.com&gt;)
</span><span class="line">    Michael Ivey (&lt;michael.ivey@riotgames.com&gt;)
</span><span class="line">    Justin Campbell (&lt;justin.campbell@riotgames.com&gt;)
</span><span class="line">    Seth Vargo (&lt;sethvargo@gmail.com&gt;)</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Install the vagrant-berkshelf Plugin (1.3.3 or higher)</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$ vagrant plugin install vagrant-berkshelf
</span><span class="line">Installing the 'vagrant-berkshelf' plugin. This can take a few minutes...
</span><span class="line">Installed the plugin 'vagrant-berkshelf (1.3.3)'!</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Install the vagrant-omnibus plugin (1.1.0 or higher)</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$ vagrant plugin install vagrant-omnibus
</span><span class="line">Installing the 'vagrant-omnibus' plugin.  This can take a few minutes...
</span><span class="line">Installed the plugin 'vagrant-omnibus (1.1.0)'!</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="upgrade-from-berkshelf-1x">Upgrade from Berkshelf 1.x</h2>
<p>NOTE: If you had a previous 1.x version of the berkshelf plugin installed,
when it was named <code>berkshelf-vagrant</code>, which you can verify by running
the following command:</p>

<pre><code>$ vagrant plugin list
berkshelf-vagrant (1.1.3)
</code></pre>

<p>Make sure you fully uninstall the old <code>berkshelf-vagrant</code> plugin before
installing the new <code>vagrant-berkshelf</code> plugin, as vagrant will get confused
by the name change:</p>

<pre><code>$ vagrant plugin uninstall berkshelf-vagrant
Uninstalling the 'berkshelf-vagrant' plugin...
$ vagrant plugin install vagrant-berkshelf
Installing the 'vagrant-berkshelf' plugin.  This can take a few minutes...
</code></pre>

<h1 id="create-the-myface-application-cookbook">Create the MyFace Application Cookbook</h1>
<p>Key to the Berkshelf way is the use of the Application Cookbook Pattern.  An
application cookbook contains the list of recipes needed to build your
application or service.  As an example, this blog post will walk you through
the creation of an example service - MyFace - the next killer social web app.</p>

<p>First create a new cookbook for the MyFace application using the
<code>berks cookbook</code> command:</p>

<pre><code>$ berks cookbook myface
      create  myface/files/default
      create  myface/templates/default
      create  myface/attributes
      create  myface/definitions
      create  myface/libraries
      create  myface/providers
      create  myface/recipes
      create  myface/resources
      create  myface/recipes/default.rb
      create  myface/metadata.rb
      create  myface/LICENSE
      create  myface/README.md
      create  myface/Berksfile
      create  myface/Thorfile
      create  myface/chefignore
      create  myface/.gitignore
         run  git init from "./myface"
      create  myface/Gemfile
      create  .kitchen.yml
      append  Thorfile
      create  test/integration/default
      append  .gitignore
      append  .gitignore
      append  Gemfile
      append  Gemfile
You must run `bundle install' to fetch any new gems.
      create  myface/Vagrantfile
</code></pre>

<p>Before running <code>bundle install</code> edit the <code>Gemfile</code> and add a version constraint
for the <code>test-kitchen</code> gem so that Bundler can resolve all the dependencies
properly:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/Vagrantfile  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;berkshelf&#39;</span>
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;test-kitchen&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.0.0.beta.2&#39;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:integration</span>
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;kitchen-vagrant&#39;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:integration</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As of this writing, if you do not add the version constraint for <code>test-kitchen</code>
you will get this mysterious error when you run <code>bundle install</code>:</p>

<pre><code>Bundler could not find compatible versions for gem "test-kitchen":
  In Gemfile:
    kitchen-vagrant (&gt;= 0) ruby depends on
      test-kitchen (~&gt; 1.0.0.alpha.0) ruby

    test-kitchen (0.5.0)
</code></pre>

<p>The version constraint addresses this issue.</p>

<p>Run <code>bundle install</code> in the newly created cookbook directory to install the
necessary Gem dependencies:</p>

<pre><code>$ cd myface
$ bundle install
Fetching gem metadata from https://rubygems.org/........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using i18n (0.6.4)
Using multi_json (1.7.8)
Using activesupport (3.2.14)
. . .
Using berkshelf (2.0.8)
Using coderay (1.0.9)
Using mixlib-shellout (1.2.0)
Using net-scp (1.1.2)
Using method_source (0.8.2)
Using slop (3.4.6)
Using pry (0.9.12.2)
Using safe_yaml (0.9.5)
Using test-kitchen (1.0.0.beta.2)
Using kitchen-vagrant (0.11.0)
Using bundler (1.3.5)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<h1 id="prepare-a-virtual-machine-for-testing">Prepare a virtual machine for testing</h1>
<p>It’s a good idea to develop your cookbook incrementally, testing 
in short iterations.  Berkshelf integrates with Vagrant to deploy
your cookbook changes to a virtual machine for testing.</p>

<p>Ensure that the <code>vagrant-omnibus</code> plugin is installed correctly.</p>

<pre><code>$ vagrant plugin list
...
vagrant-omnibus (1.1.0)
...
</code></pre>

<p>The <code>vagrant-omnibus</code> plugin hooks into Vagrant and allows you to specify
the version of the Chef Omnibus package you want installed using the
<code>omnibus.chef_version</code> key</p>

<p>Edit the Vagrantfile generated by the <code>berks cookbook</code> command to use
a VirtualBox template that does not have a version of Chef provisioned.
Then, specify that you want your image to always use the latest version
of Chef.  (By default Berkshelf points to an image with an older version of CentOS and Chef 11.2.0, which is also old).  Your Vagrantfile should look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/Vagrantfile  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;myface-berkshelf&quot;</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;misheska-centos6.4&quot;</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-centos64.box&quot;</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">omnibus</span><span class="o">.</span><span class="n">chef_version</span> <span class="o">=</span> <span class="ss">:latest</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;33.33.33.10&quot;</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="mi">40</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">berkshelf</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
</span><span class="line">    <span class="n">chef</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">      <span class="ss">:mysql</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class="line">        <span class="ss">:server_root_password</span> <span class="o">=&gt;</span> <span class="s1">&#39;rootpass&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:server_debian_password</span> <span class="o">=&gt;</span> <span class="s1">&#39;debpass&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:server_repl_password</span> <span class="o">=&gt;</span> <span class="s1">&#39;replpass&#39;</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="n">chef</span><span class="o">.</span><span class="n">run_list</span> <span class="o">=</span> <span class="o">[</span>
</span><span class="line">      <span class="s2">&quot;recipe[myface::default]&quot;</span>
</span><span class="line">    <span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Run <code>vagrant up</code> to start up the virtual machine and to test the stub MyFace
cookbook you just created:</p>

<pre><code>$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Box 'misheska-centos64' was not found. Fetching box from specified URL for
the provider 'virtualbox'. Note that if the URL does not have
a box for this provider, you should interrupt Vagrant now and add
the box yourself. Otherwise Vagrant will attempt to download the
full box prior to discovering this error.
Downloading or copying the box...
Extracting box...te: 2487k/s, Estimated time remaining: --:--:--)
Successfully added box 'misheska-centos64' with provider 'virtualbox'!
[default] Importing base box 'misheska-centos64'...
[default] Matching MAC address for NAT networking...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[Berkshelf] Updating Vagrant's berkshelf: '/Users/misheska/.berkshelf/default/vagrant/berkshelf-20130807-5122-1ipka2m-default'
[Berkshelf] Using myface (0.1.0)
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 =&gt; 2222 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] VM booted and ready for use!
[default] Setting hostname...
[default] Configuring and enabling network interfaces...
[default] Mounting shared folders...
[default] -- /vagrant
[default] -- /tmp/vagrant-chef-1/chef-solo-1/cookbooks
[default] Installing Chef 11.6.0 Omnibus package...
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-08-07T20:41:29-07:00] INFO: Forking chef instance to converge...
[2013-08-07T20:41:29-07:00] INFO: *** Chef 11.6.0 ***
[2013-08-07T20:41:30-07:00] INFO: Setting the run_list to ["recipe[myface::default]"] from JSON
[2013-08-07T20:41:30-07:00] INFO: Run List is [recipe[myface::default]]
[2013-08-07T20:41:30-07:00] INFO: Run List expands to [myface::default]
[2013-08-07T20:41:30-07:00] INFO: Starting Chef Run for myface-berkshelf
[2013-08-07T20:41:30-07:00] INFO: Running start handlers
[2013-08-07T20:41:30-07:00] INFO: Start handlers complete.
[2013-08-07T20:41:30-07:00] INFO: Chef Run complete in 0.025063914 seconds
[2013-08-07T20:41:30-07:00] INFO: Running report handlers
[2013-08-07T20:41:30-07:00] INFO: Report handlers complete
</code></pre>

<p>If all goes well, you should see <code>Chef Run complete</code> with no errors.</p>

<p>NOTE: The basebox URL comes from my current collection of baseboxes.  The
following link points to a README file which provides links to all the
vagrant baseboxes I use (which I normally update frequently):
<a href="https://github.com/misheska/basebox-packer">https://github.com/misheska/basebox-packer</a></p>

<p>If you would ever like to delete your test virtual machine and start over,
you can destroy your test virtual machine with the <code>vagrant destroy</code> command:</p>

<pre><code>$ vagrant destroy
Are you sure you want to destroy the 'default' VM? [y/N] y
[default] Forcing shutdown of VM...
[default] Destroying VM and associated drives...
[Berkshelf] Cleaning Vagrant's berkshelf
</code></pre>

<p>Run <code>vagrant up</code> to recreate the test virtual machine.</p>

<p><strong>NOTE:</strong> If you just ran <code>vagrant destroy</code> make sure you run <code>vagrant up</code>
before proceeding to the next section.</p>

<h1 id="iteration-1-create-an-application-user">Iteration #1: Create an application user</h1>
<p>For our first short iteration, let’s create a <code>myface</code> user under which
we’ll run our application.  One best practice is to avoid running
applications as root and create a user/group under which the application runs
instead who has just enough rights that the app needs.</p>

<p>Edit <code>myface/recipes/default.rb</code> defining a new <a href="http://docs.opscode.com/resource_group.html">Group Resource</a>
and <a href="http://docs.opscode.com/resource_user.html">User Resource</a> for myface,
so it looks like the following:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: default</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="s2">&quot;myface&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Save <code>recipes/default.rb</code> and re-run <code>vagrant provision</code> to create the
myface user on your test virtual machine:</p>

<pre><code>$ vagrant provision
[Berkshelf] Updating Vagrant's berkshelf: '/Users/misheska/.berkshelf/default/vagrant/berkshelf-20130807-5122-1ipka2m-default'
[Berkshelf] Using myface (0.1.0)
[default] Chef 11.6.0 Omnibus package is already installed.
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-08-07T20:46:33-07:00] INFO: Forking chef instance to converge...
[2013-08-07T20:46:33-07:00] INFO: *** Chef 11.6.0 ***
[2013-08-07T20:46:34-07:00] INFO: Setting the run_list to ["recipe[myface::default]"] from JSON
[2013-08-07T20:46:34-07:00] INFO: Run List is [recipe[myface::default]]
[2013-08-07T20:46:34-07:00] INFO: Run List expands to [myface::default]
[2013-08-07T20:46:34-07:00] INFO: Starting Chef Run for myface-berkshelf
[2013-08-07T20:46:34-07:00] INFO: Running start handlers
[2013-08-07T20:46:34-07:00] INFO: Start handlers complete.
[2013-08-07T20:46:34-07:00] INFO: group[myface] created
[2013-08-07T20:46:34-07:00] INFO: user[myface] created
[2013-08-07T20:46:34-07:00] INFO: Chef Run complete in 0.185753077 seconds
[2013-08-07T20:46:34-07:00] INFO: Running report handlers
[2013-08-07T20:46:34-07:00] INFO: Report handlers complete
</code></pre>

<p>You should expect to see the Chef run complete with no errors.  Notice
that it also creates <code>group[myface]</code> and <code>user[myface]</code>.</p>

<h2 id="testing-iteration-1">Testing Iteration #1</h2>

<p>Verify that Chef actually created the myface user on our test virtual
machine by running the following:</p>

<pre><code>$ vagrant ssh -c "getent passwd myface"
myface:x:497:503::/home/myface:/bin/bash
</code></pre>

<p>We use <code>vagrant ssh -c</code> to run a command on our test virtual machine.  The
<code>getent</code> command can be used to query all user databases.  In this
case we’re looking for <code>myface</code>, and it exists!</p>

<p>Because we are using well-defined resources that are completely
<a href="http://en.wikipedia.org/wiki/Idempotence">idempotent</a>, you should notice
that if you run <code>vagrant provision</code> again, the Chef run executes more quickly
and it does not try to re-create the user/group it already created.</p>

<pre><code>$ vagrant provision
[Berkshelf] Updating Vagrant's berkshelf: '/Users/misheska/.berkshelf/default/vagrant/berkshelf-20130807-5122-1ipka2m-default'
[Berkshelf] Using myface (0.1.0)
[default] Chef 11.6.0 Omnibus package is already installed.
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-08-07T20:48:27-07:00] INFO: Forking chef instance to converge...
[2013-08-07T20:48:27-07:00] INFO: *** Chef 11.6.0 ***
[2013-08-07T20:48:28-07:00] INFO: Setting the run_list to ["recipe[myface::default]"] from JSON
[2013-08-07T20:48:28-07:00] INFO: Run List is [recipe[myface::default]]
[2013-08-07T20:48:28-07:00] INFO: Run List expands to [myface::default]
[2013-08-07T20:48:28-07:00] INFO: Starting Chef Run for myface-berkshelf
[2013-08-07T20:48:28-07:00] INFO: Running start handlers
[2013-08-07T20:48:28-07:00] INFO: Start handlers complete.
[2013-08-07T20:48:28-07:00] INFO: Chef Run complete in 0.027612724 seconds
[2013-08-07T20:48:28-07:00] INFO: Running report handlers
[2013-08-07T20:48:28-07:00] INFO: Report handlers complete
</code></pre>

<h1 id="iteration-2---refactor-to-attributes">Iteration #2 - Refactor to attributes</h1>
<p>What if at some point you wanted to change the name of the <code>myface</code> user/group
you just created to something else?  At the moment, you would need to edit
<code>myface/recipes/default.rb</code> in three places.</p>

<p>Let’s create a new file called <code>myface/attributes/default.rb</code> which
initializes Chef <a href="http://docs.opscode.com/essentials_cookbook_attribute_files.html">attributes</a>
defining the user name and group name under which our application will run so
that you <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">don’t repeat yourself</a>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In Chef, attributes are a hash of a hash used to override the default settings
on a node.  The first hash is the cookbook name - in our
case we’ve named our cookbook <code>:myface</code>. The second hash is the name of
our attribute - in this case, we’re defining two new attributes: <code>:user</code> and
<code>:group</code>.</p>

<p><code>default</code> implies the use of the <a href="http://docs.opscode.com/chef/essentials_node_object.html">node object</a>
<code>node.default</code> and is a Chef attribute file shorthand.  The following are
equivalent definitions to the ones above:</p>

<pre><code>node.default[:myface][:user] = "myface"
node.default[:myface][:user] = "myface"
</code></pre>

<p>Also note the use of symbols instead of strings.  It is <a href="http://www.robertsosinski.com/2009/01/11/the-difference-between-ruby-symbols-and-strings/">strongly recommended
that you use symbols instead of strings</a>
for hash indexes. </p>

<p>Now that you’ve created your attribute definitions, edit
<code>myface/recipes/default.rb</code> and replace all references to the “myface” user name
with <code>node[:myface][:user]</code> and all references to the “myface” group with
<code>node[:myface][:group]</code>.  <code>myface/recipes/default.rb</code> should now look like
this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: default</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Re-provision with <code>vagrant provision</code> to see how the refactor went:</p>

<pre><code>$ vagrant provision
</code></pre>

<p>As long as you didn’t create any syntax errors in your refactoring file edits,
there should be no net change on the virtual machine test node (as you’ve only
just moved some strings into a node attribute).  </p>

<h2 id="testing-iteration-2">Testing Iteration #2</h2>

<p>Running  <code>getent</code> on the test virtual machine should also produce the same
result as when you validated Iteration #1:</p>

<pre><code>$ vagrant ssh -c "getent passwd myface"
myface:x:497:503::/home/myface:/bin/bash
</code></pre>

<h1 id="iteration-3---install-the-apache2-web-server">Iteration #3 - Install the Apache2 Web Server</h1>
<p>Our hot new social networking application, myface, is a web app, so we need
to install a web server.  Let’s install the Apache2 web server.</p>

<p>Modify <code>myface/recipes/default.rb</code> to include the apache2 cookbook’s default
recipe:</p>

<pre><code>include_recipe "apache2"
</code></pre>

<p>The resultant <code>myface/recipes/default.rb</code> file should look like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: default</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Since you are loading Apache2 from another cookbook, you need to configure the
dependency in your metadata.  Edit <code>myface/metadata.rb</code> and add the <code>apache2</code>
dependency at the bottom:</p>

<pre><code>depends "apache2", "~&gt; 1.6.0"
</code></pre>

<p>This tells Chef that the myface cookbook depends on the apache2 cookbook.
We’ve also specified a version constraint using the optimistic operator
<code>~&gt;</code> to tell our Chef that we want the latest version of the apache2 cookbook
that is greater than 1.6.0 but <em>not</em> 1.7.0 or higher.</p>

<p>It is recommended that Chef cookbooks follow a
<a href="http://semver.org/">Semantic Versioning</a> scheme.  So if you write your
cookbook to use the latest apache2 1.6.x cookbook, if the apache2 cookbook is
ever bumped to a 1.7.x version (or 2.x), it has some public API functionality
that has at least been deprecated.  So you’ll want to review the changes and
test before automatically using an apache2 cookbook version 1.7.x or higher.
However, automatic use of any new 1.6.x is perfectly fine, because no
only backwards-compatible bug fixes has been introduced.  Semantic Versioning
guarantees there are no changes in the public APIs.</p>

<p>Your <code>myface/metadata.rb</code> file should look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/metadata.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">name</span>             <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">maintainer</span>       <span class="s2">&quot;YOUR_NAME&quot;</span>
</span><span class="line"><span class="n">maintainer_email</span> <span class="s2">&quot;YOUR_EMAIL&quot;</span>
</span><span class="line"><span class="n">license</span>          <span class="s2">&quot;All rights reserved&quot;</span>
</span><span class="line"><span class="n">description</span>      <span class="s2">&quot;Installs/Configures myface&quot;</span>
</span><span class="line"><span class="n">long_description</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;README.md&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">version</span>          <span class="s2">&quot;0.1.0&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;apache2&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.6.0&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now when you re-run <code>vagrant provision</code> it will install apache2 on your
test virtual machine:</p>

<pre><code>$ vagrant provision
[Berkshelf] Updating Vagrant's berkshelf: '/Users/misheska/.berkshelf/default/vagrant/berkshelf-20130807-5122-1ipka2m-default'
[Berkshelf] Using myface (0.1.0)
[Berkshelf] Installing apache2 (1.6.6) from site: 'http://cookbooks.opscode.com/api/v1/cookbooks'
[default] Chef 11.6.0 Omnibus package is already installed.
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-08-07T20:53:08-07:00] INFO: Forking chef instance to converge...
[2013-08-07T20:53:08-07:00] INFO: *** Chef 11.6.0 ***
[2013-08-07T20:53:08-07:00] INFO: Setting the run_list to ["recipe[myface::default]"] from JSON
[2013-08-07T20:53:08-07:00] INFO: Run List is [recipe[myface::default]]
[2013-08-07T20:53:08-07:00] INFO: Run List expands to [myface::default]
[2013-08-07T20:53:08-07:00] INFO: Starting Chef Run for myface-berkshelf
[2013-08-07T20:53:08-07:00] INFO: Running start handlers
[2013-08-07T20:53:08-07:00] INFO: Start handlers complete.
...
[2013-08-07T20:54:13-07:00] INFO: service[apache2] started
[2013-08-07T20:54:13-07:00] INFO: template[/etc/httpd/mods-available/deflate.conf] sending restart action to service[apache2] (delayed)
[2013-08-07T20:54:14-07:00] INFO: service[apache2] restarted
[2013-08-07T20:54:14-07:00] INFO: Chef Run complete in 66.177345199 seconds
[2013-08-07T20:54:14-07:00] INFO: Running report handlers
[2013-08-07T20:54:14-07:00] INFO: Report handlers complete
</code></pre>

<h2 id="testing-iteration-3">Testing Iteration #3</h2>

<p>You can verify that the apache2 <code>httpd</code> service is running on your berkshelf
virtual machine with the following command:</p>

<pre><code>$ vagrant ssh -c "sudo /sbin/service httpd status"
httpd (pid  4831) is running.
</code></pre>

<p>Since this is a web server, so you can also check it out in your favorite web
browser.  The host-only private network address for the virtual machine
that Berkshelf created is in the <code>Vagrantfile</code>.  Display the IP address with
the following command:</p>

<pre><code>$ grep ip: Vagrantfile
config.vm.network :private_network, ip: "33.33.33.10"
</code></pre>

<p>Check it out with your favorite web browser:</p>

<p><a href="http://33.33.33.10">http://33.33.33.10</a></p>

<p>While you will get a <code>404 Not Found</code> error because we haven’t added any
content to our web site yet, the important part is that <code>Apache Server
at 33.33.33.10 Port 80</code> sent the response:</p>

<p><img src="/images/apachewebserver.png" alt="Apache Server Response" /></p>

<p>Wait a second, though.  You never downloaded the <code>apache2</code> cookbook!
That’s the magic of the Berkshelf Vagrant plugin you installed earlier.  The
Berkshelf Vagrant plugin will make sure that any changes you make to your
cookbook and all of your cookbook’s dependencies are made available to your
virtual machine.  Berkshelf automatically loads all your cookbook dependencies
much like Bundler automatically loads all your gem dependencies.</p>

<p>Where does the Berkshelf put the cookbooks it downloads?  You can find them
in <code>~/.berkshelf/cookbooks</code></p>

<pre><code>Users/misheska/.berkshelf/cookbooks
└── apache2-1.6.6
    ├── attributes
    ├── definitions
    ├── files
    │   └── default
    │       └── tests
    │           └── minitest
    │               └── support
    ├── recipes
    └── templates
        └── default
            └── mods
</code></pre>

<p><code>~/.berkshelf</code> is just the default location where Berkshelf stores data
on your local disk.  This location can be altered by setting the environment
variable <code>BERKSHELF_PATH</code>.</p>

<h1 id="iteration-4---add-content">Iteration #4 - Add Content</h1>
<p>Let’s add some content to make that 404 go away.  Edit
<code>myface/recipes/default.rb</code> as follows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: default</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># disable default site</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;000-default&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">false</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create apache config</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/myface.conf&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;apache2.conf.erb&quot;</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[apache2]&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create document root</span>
</span><span class="line"><span class="n">directory</span> <span class="s2">&quot;/srv/apache/myface&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line">  <span class="n">recursive</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># write site</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;/srv/apache/myface/index.html&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;index.html.erb&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span> <span class="c1"># forget me to create debugging exercise</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># enable myface</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;myface.conf&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you’re familiar with Chef and configuring a web app via apache2, nothing
here should be too surprising.  But if not, spend some time reading up on
the resource references at <a href="http://docs.opscode.com">http://docs.opscode.com</a></p>

<p>With Chef, you can create config files from templates using
<a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/erb/rdoc/ERB.html">ERB</a>, a
Ruby templating system.  Create a new template file called
<code>myface/templates/default/apache2.conf.erb</code> which will become the
file <code>.../sites-available/myface.conf</code> on our test virtual machine
(refer to <code>myface/recipes/default.rb</code> above):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/templates/default/apache2.conf.erb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># Managed by Chef for &lt;%= node[:hostname] %&gt;</span>
</span><span class="line">
</span><span class="line"><span class="no">Alias</span> <span class="o">/</span> <span class="sr">/srv/</span><span class="n">apache</span><span class="o">/</span><span class="n">myface</span><span class="o">/</span>
</span><span class="line">
</span><span class="line"><span class="o">&lt;</span><span class="no">Directory</span> <span class="sr">/srv/</span><span class="n">apache</span><span class="o">/</span><span class="n">myface</span><span class="o">&gt;</span>
</span><span class="line">	<span class="no">Options</span> <span class="no">FollowSymLinks</span> <span class="o">+</span><span class="no">Indexes</span>
</span><span class="line">	<span class="no">Allow</span> <span class="n">from</span> <span class="no">All</span>
</span><span class="line"><span class="o">&lt;</span><span class="sr">/Directory&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Also create our web site content as <code>myface/templates/default/index.html.erb</code>.
While it doesn’t take advantage of ERB templating yet, it will in further
iterations.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/templates/default/index.html.erb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">Welcome</span> <span class="n">to</span> <span class="no">MyFace</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After you have created these three files, run <code>vagrant provision</code> to deploy
your changes:</p>

<pre><code>$ vagrant provision
</code></pre>

<h2 id="testing-iteration-4">Testing Iteration #4</h2>

<p>If the Chef run completed successfully, if you point your web browser at your
myface web site again:</p>

<p><a href="http://33.33.33.10">http://33.33.33.10</a></p>

<p>You’ll see some lovely content!</p>

<p><img src="/images/welcometomyface.png" alt="Welcome to MyFace" /></p>

<h1 id="iteration-5---refactoring-webserver">Iteration #5 - Refactoring webserver</h1>
<p><code>myface/recipes/default.rb</code> is getting rather large and we’ve got a lot more
to add to our cookbook.  Let’s go through another refactoring pass.</p>

<p>Let’s move all the webserver-related resources to their own file
<code>myface/recipes/webserver.rb</code>.  Rename <code>myface/recipes/default.rb</code> to
<code>myface/recipes/webserver.rb</code>.</p>

<p>Now <code>myface/recipes/webserver.rb</code> should look like this: </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/webserver.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: webserver</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># disable default site</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;000-default&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">false</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create apache config</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/myface.conf&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;apache2.conf.erb&quot;</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[apache2]&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create document root</span>
</span><span class="line"><span class="n">directory</span> <span class="s2">&quot;/srv/apache/myface&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line">  <span class="n">recursive</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># write site</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;/srv/apache/myface/index.html&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;index.html.erb&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># enable myface</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;myface.conf&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a new <code>myface/recipes/default.rb</code> file which references <code>webserver.rb</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: default</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;myface::webserver&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Converge your node again to make sure there are no syntax errors:</p>

<pre><code>$ vagrant provision
</code></pre>

<p>Let’s eliminate some more of the duplication that crept in while we were
working on things.  Edit <code>myface/attributes/default.rb</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;myface.conf&quot;</span>
</span><span class="line"><span class="n">default</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/srv/apache/myface&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>NOTE: With Chef 11, it is now possible to nest attributes, like so:</p>

<pre><code>node.default[:app][:name] = "my_app"
node.default[:app][:document_root] = "/srv/apache/#{node[:app][:name]}"
</code></pre>

<p>This approach is overkill for MyFace (and is frankly overkill for most
Chef recipes).  Even though nesting is an option now with Chef 11, you should
try to keep your attribute files as simple and straightforward to follow as
possible.</p>

<p>In <code>myface/recipes/webserver.rb</code> replace the corresponding hardcoded references
to attribute references: </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/webserver.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: webserver</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># disable default site</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;000-default&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">false</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create apache config</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;apache2.conf.erb&quot;</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[apache2]&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create document root</span>
</span><span class="line"><span class="n">directory</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line">  <span class="n">recursive</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># write site</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">/index.html&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;index.html.erb&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># enable myface</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Converge your node one last time to make sure there are no syntax errors:</p>

<pre><code>$ vagrant provision
</code></pre>

<h2 id="testing-iteration-5">Testing Iteration #5</h2>

<p>Visiting <a href="http://33.33.33.10">http://33.33.33.10</a> should produce the same result as before as you
have made no net changes, just shuffled things around a bit.</p>

<h1 id="iteration-6---version-bump-and-production-deploy">Iteration #6 - Version Bump and Production Deploy</h1>
<p>Now that we have tested our cookbook locally and everything seems to work,
we’re ready to finalize the cookbook and deploy it to production.</p>

<h2 id="version-bump-to-100">Version Bump to 1.0.0</h2>

<p>First you need to “bump” the cookbook version in the <code>metadata.rb</code> file to
its final version 1.0.0.  As mentioned in Iteration #3, cookbooks (even the
ones you write), should follow the
<a href="http://semver.org/">Semantic Versioning scheme</a>.  Since this is the first
public version of our cookbook, it’s version 1.0.0.</p>

<p><code>myface/metadata.rb</code> should look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/metadata.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">name</span>             <span class="s2">&quot;myface&quot;</span>
</span><span class="line"><span class="n">maintainer</span>       <span class="s2">&quot;Mischa Taylor&quot;</span>
</span><span class="line"><span class="n">maintainer_email</span> <span class="s2">&quot;mischa@misheska.com&quot;</span>
</span><span class="line"><span class="n">license</span>          <span class="s2">&quot;Apache 2.0&quot;</span>
</span><span class="line"><span class="n">description</span>      <span class="s2">&quot;Installs/Configures myface&quot;</span>
</span><span class="line"><span class="n">long_description</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;README.md&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">version</span>          <span class="s2">&quot;1.0.0&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;apache2&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.6.0&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="configure-berkshelf">Configure Berkshelf</h2>

<p>In order to deploy to your production server (instead of just locally with
vagrant), you’ll need to add a section to your Berkshelf config file with
your production Chef settings.  The config file is located in
<code>$HOME/.berkshelf/config.json</code>.</p>

<p>For example, I’m using hosted Chef to manage my servers, so my
Chef settings are as follows:</p>

<pre><code>Chef Server API URL endpoint: https://api.opscode.com/organizations/misheska
Chef API validation client name: misheska-validator
Chef API validation key path: /Users/misheska/.chef/misheska-validator.pem
Chef API client key: /Users/misheska/.chef/misheska.pem
Chef API node name: misheska
</code></pre>

<p>So here’s what my <code>$HOME/.berkshelf/config.json</code> file looks like:</p>

<pre><code>{
  "chef":{
    "chef_server_url": "https://api.opscode.com/organizations/misheska",
    "validation_client_name": "misheska-validator",
    "validation_key_path": "/Users/mischa/.chef/misheska-validator.pem",
    "client_key": "/Users/mischa/.chef/misheska.pem",
    "node_name":"misheska"
  },
  "vagrant":{
    "vm":{
      "box": "misheska-centos-6.4",
      "box_url":"https://www.dropbox.com/s/y42egyh9cqsge24/misheska-centos-6.4.box",
      "forward_port": {
      },
      "network":{
        "bridged": false,
        "hostonly": "33.33.33.10"
      },
      "provision": "chef_solo"
    }
  },
  "ssl": {
    "verify":false
  }
}
</code></pre>

<p>I assume you have your own production Chef setup either running 
<a href="http://www.opscode.com/hosted-chef/">Hosted Chef</a>,
<a href="http://www.opscode.com/private-chef/">Private Chef</a>, or
<a href="http://docs.opscode.com/chef/manage_server_open_source.html">Open Source Chef Server</a>.  If you need more help getting your .pem file values, refer to
the <a href="https://learnchef.opscode.com/quickstart/chef-repo/">QuickStart Guide on LearnChef</a>.</p>

<h2 id="upload-cookbooks">Upload cookbooks</h2>

<p>Edit your <code>$HOME/.berkshelf/config.json</code> file similarly with your .pem file
values.  Then run <code>berks upload</code> to upload your cookbooks to the chef server:</p>

<pre><code>$ berks upload
Using myface (1.0.0)
Using apache2 (1.6.6)
Uploading myface (1.0.0) to: 'https://api.opscode.com:443/organizations/misheska'
Uploading apache2 (1.6.6) to: 'https://api.opscode.com:443/organizations/misheska'
</code></pre>

<p>Similarly to when you ran <code>vagrant up</code>, Berkshelf automatically uploaded all
the cookbook dependencies.</p>

<h2 id="converge-node">Converge node</h2>

<p>Add the default <code>myface</code> cookbook recipe to your node’s run list.  For example,
I used the following command to add <code>myface</code> to mine:</p>

<pre><code>$ knife node run_list add mischa-ubuntu 'recipe[myface]'
mischa-ubuntu:
  run_list: recipe[myface]
</code></pre>

<p>Converge the node by running <code>chef-client</code> (if you don’t already have it
setup to run chef-client automatically).  For example, here’s the command
I used to run <code>chef-client</code> on my production node:</p>

<pre><code>$ knife ssh name:mischa-ubuntu "sudo chef-client" -x misheska
Starting Chef Client, version 11.4.4
resolving cookbooks for run list: ["myface"]
Synchronizing Cookbooks:
  - myface
  - apache2
...
Chef Client finished, 20 resources updated 
</code></pre>

<h2 id="testing-iteration-6">Testing Iteration #6</h2>

<p>Browsing your production node’s URL should produce the same result as when
you tested Iteration #4.  For example, I visited <a href="http://mischa-ubuntu">http://mischa-ubuntu</a> </p>

<h1 id="more-to-come">More to Come!</h1>
<p>This is just part one of a multi-part series.  So far you’ve gone through
several short iteration loops as you evolve the myface cookbook web
application.  In <a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>,
we’ll wire up a database to the myface application and explore the use of
the <code>mysql</code> and <code>database</code> cookbooks.</p>

<p>If you want to see the full source for myface, check out the following
GitHub link: <a href="https://github.com/misheska/myface">https://github.com/misheska/myface</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/16/use-opscode-chef-omnibus-ruby-for-writing-cookbooks/">Use Opscode Chef Omnibus Ruby for Writing Cookbooks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-16T02:35:00-07:00" pubdate data-updated="true">Jun 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#how-to-set-up-omnibus-chef-ruby-on-mac-os-x">How to set up Omnibus Chef Ruby on Mac OS X</a></li>
  <li><a href="#how-to-set-up-omnibus-chef-ruby-on-linux">How to set up Omnibus Chef Ruby on Linux</a></li>
  <li><a href="#how-to-set-up-omnibus-chef-ruby-on-windows">How to set up Omnibus Chef Ruby on Windows</a></li>
</ul>

<p>If your only use of Ruby is because you want to write cookbooks for Opscode
Chef, rather than going through the bother of setting up a full Ruby
development environment via <a href="http://misheska.com/blog/2013/06/16/using-rvm-to-manage-multiple-versions-of-ruby/">rvm</a> or <a href="http://misheska.com/blog/2013/06/15/using-rbenv-to-manage-multiple-versions-of-ruby/">rbenv</a>
you can just reuse the Ruby 1.9.x environment that is bundled with the
Opscode Omnibus Chef installer.</p>

<p>In this post, I’ll cover how to configure the Ruby 1.9.x interpreter bundled
with the Opscode Omnibus Chef installer on Mac OS X, Linux and Windows so
it can be used for writing cookbooks.</p>

<h1 id="how-to-set-up-omnibus-chef-ruby-on-mac-os-x">How to set up Omnibus Chef Ruby on Mac OS X</h1>
<p>First install Apple Xcode, which includes a C compiler needed to build the
tools required for cookbook development from source (like
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Berkshelf</a> ).
Download and install the latest version of Xcode from the App Store, if you
don’t have it installed already.  Also make sure you install the <em>Command Line
Tools</em> by choosing the menu item <code>Xcode -&gt; Preferences...</code> and click
on the <em>Downloads</em> tab.  Click on the <em>Install</em> button to download the
Command Line Tools.
<img src="/images/xcodecommandline.png" alt="Xcode Command Line Tools" /></p>

<p>In a web browser, go to the <a href="http://www.opscode.com/chef/install">http://www.opscode.com/chef/install</a> page to
display the instructions for installing the Chef Client via the Opscode
Omnibus Chef installer.</p>

<p>As of this writing, the quick install instructions for Mac OS X are as
follows:</p>

<pre><code>$ curl -L https://www.opscode.com/chef/install.sh | sudo bash
</code></pre>

<p>The Chef Client installer also installs Ruby 1.9.3 for its own use in
the directory <code>/opt/chef/embedded</code>.  You can also use this copy of Ruby
for your own cookbook development.</p>

<p>WARNING: Don’t try to mix and match the Chef Client’s Ruby 1.9.3 together
with a RVM/rbenv Ruby development setup.  Choose one or the other.  If your
Ruby needs go beyond Chef and writing Chef cookbooks, set up a “real”
RVM/rbenv Ruby environment.</p>

<p>Now that you have a Ruby 1.9.3 environment via the Chef Client install, you
can install any extra gem dependencies needed for writing Chef cookbooks by
using the <code>/opt/chef/embedded/bin/gem install</code> command.  For example, here’s
how to install Berkshelf, a popular cookbook authoring support tool:</p>

<pre><code>$ sudo /opt/chef/embedded/bin/gem install berkshelf --no-ri --no-rdoc
Password:
Fetching: i18n-0.6.1.gem (100%)
Fetching: multi_json-1.7.7.gem (100%)
Fetching: activesupport-3.2.13.gem (100%)
...
Successfully installed safe_yaml-0.9.3
Successfully installed test-kitchen-1.0.0.alpha.7
Successfully installed berkshelf-2.0.3
43 gems installed
</code></pre>

<p>Create a soft link to any gem-installed binaries in an existing PATH directory,
like <code>/usr/local/bin</code></p>

<pre><code># On Mac OS X, /usr/local/bin is not created by default
$ sudo mkdir -p /usr/local/bin
Password:
$ sudo ln -s /opt/chef/embedded/bin/berks /usr/local/bin/berks
$ berks -v
Berkshelf (2.0.3)
</code></pre>

<p>Don’t be tempted to add <code>/opt/chef/embedded/bin</code> to your PATH.  You still want
to keep Opscode’s Ruby install separate from your main system Ruby install.</p>

<h1 id="how-to-set-up-omnibus-chef-ruby-on-linux">How to set up Omnibus Chef Ruby on Linux</h1>
<p>Make sure all the prerequisite packages are installed for the gems you will
be using.</p>

<p>Ubuntu prerequisites:</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get install -y curl
$ sudo apt-get install -y build-essential git
$ sudo apt-get install -y libxml2-dev libxslt-dev libssl-dev
</code></pre>

<p>RHEL/CentOS prerequisites:</p>

<pre><code>$ sudo yum update
$ sudo yum install -y curl
$ sudo yum install -y git
$ sudo yum install -y gcc-c++ patch readline readline-devel zlib zlib-devel
$ sudo yum install -y libyaml-devel libffi-devel openssl-devel make bzip2
$ sudo yum install -y autoconf automake libtool bison
$ sudo yum install -y libxml2-devel libxslt-devel
</code></pre>

<p>In a web browser, go to the <a href="http://www.opscode.com/chef/install">http://www.opscode.com/chef/install</a> page to
display the instructions for installing the Chef Client via the Opscode
Omnibus Chef installer for your distribution of Linux.</p>

<p>As of this writing, the quick install instructions for Ubuntu/CentOS are as
follows:</p>

<pre><code>$ curl -L https://www.opscode.com/chef/install.sh | sudo bash
</code></pre>

<p>The Chef Client installer also installs Ruby 1.9.3 for its own use in
the directory <code>/opt/chef/embedded</code>.  You can also use this copy of Ruby
for your own cookbook development.</p>

<p>WARNING: Don’t try to mix and match the Chef Client’s Ruby 1.9.3 together
with a RVM/rbenv Ruby development setup.  Choose one or the other.  If your
Ruby needs go beyond Chef and writing Chef cookbooks, set up a “real”
RVM/rbenv Ruby environment.</p>

<p>Now that you have a Ruby 1.9.3 environment via the Chef Client install, you
can install any extra gem dependencies needed for writing Chef cookbooks by
using the <code>/opt/chef/embedded/bin/gem install</code> command.  For example, here’s
how to install Berkshelf, a popular cookbook authoring support tool:</p>

<pre><code>$ sudo /opt/chef/embedded/bin/gem install berkshelf --no-ri --no-rdoc
Password:
Building native extensions.  This could take a while...
Fetching: httpclient-2.2.0.2.gem (100%)
Fetching: rubyntlm-0.1.1.gem (100%)
Fetching: uuidtools-2.1.4.gem (100%)
...
Successfully installed safe_yaml-0.9.3
Successfully installed test-kitchen-1.0.0.alpha.7
Successfully installed berkshelf-2.0.3
25 gems installed
</code></pre>

<p>Create a soft link to any gem-installed binaries in an existing PATH directory,
like <code>/usr/local/bin</code></p>

<pre><code>$ sudo ln -s /opt/chef/embedded/bin/berks /usr/local/bin/berks
$ berks -v
Berkshelf (2.0.3)
</code></pre>

<p>Don’t be tempted to add <code>/opt/chef/embedded/bin</code> to your PATH.  You still want
to keep Opscode’s Ruby install separate from your main system Ruby install.</p>

<h1 id="how-to-set-up-omnibus-chef-ruby-on-windows">How to set up Omnibus Chef Ruby on Windows</h1>
<p>In a web browser, go to the <a href="http://www.opscode.com/chef/install">http://www.opscode.com/chef/install</a> page to
display the instructions for installing the Chef Client via the Opscode
Omnibus Chef installer for your distribution of Linux.</p>

<p>After you select a Chef verison (pick the latest), you will be provided
a download link to the Omnibus Chef Windows installer.  After downloading
Run the install, choosing the default options.</p>

<p>The Chef Client installer also installs Ruby 1.9.3 for its own use in
the directory <code>C:\opscode\chef\embedded</code>.  You can also use this copy of Ruby
for your own cookbook development.</p>

<p>WARNING: Don’t try to mix and match the Chef Client’s Ruby 1.9.3 together
with a RVM/rbenv Ruby development setup.  Choose one or the other.  If your
Ruby needs go beyond Chef and writing Chef cookbooks, set up a “real”
RVM/rbenv Ruby environment.</p>

<p>Now that you have a Ruby 1.9.3 environment via the Chef Client install, you
can install any extra gem dependencies needed for writing Chef cookbooks by
using the <code>c:\opscode\chef\embedded\bin install</code> command.  For example,
here’s how to install Berkshelf, a popular cookbook authoring support tool:</p>

<pre><code>&gt; c:\opscode\chef\embedded\bin\gem install berkshelf --no-ri --no-rdoc
Fetching: i18n-0.6.1.gem (100%)
Fetching: multi_json-1.7.7.gem (100%)
Fetching: activesupport-3.2.13.gem (100%)
...
Successfully installed safe_yaml-0.9.3
Successfully installed test-kitchen-1.0.0.alpha.7
Successfully installed berkshelf-2.0.3
43 gems installed
</code></pre>

<p>Add <code>c:\opscode\chef\embedded\bin</code> to your PATH environment variable:
<img src="/images/opscodechefpathwin.png" alt="Environments Control Panel" /></p>

<p>Restart your Command Prompt to pick up the new environment variable setting,
and then you can run Berkshelf:</p>

<pre><code>&gt; berks -v
Berkshelf (2.0.3)
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/16/using-rvm-to-manage-multiple-versions-of-ruby/">Using RVM to Manage Multiple Versions of Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-16T00:35:00-07:00" pubdate data-updated="true">Jun 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#mac-os-x">Mac OS X</a>    <ul>
      <li><a href="#install-rvm-and-ruby-19x---mac-os-x">Install RVM and Ruby 1.9.x - Mac OS X</a></li>
      <li><a href="#install-ruby-187---mac-os-x">Install Ruby 1.8.7 - Mac OS X</a></li>
      <li><a href="#install-ruby-200---mac-os-x">Install Ruby 2.0.0 - Mac OS X</a></li>
      <li><a href="#remove-rvm---mac-os-x">Remove RVM - Mac OS X</a></li>
    </ul>
  </li>
  <li><a href="#linux">Linux</a>    <ul>
      <li><a href="#install-rvm-and-ruby-19x---linux">Install RVM and Ruby 1.9.x - Linux</a></li>
      <li><a href="#install-ruby-200---linux">Install Ruby 2.0.0 - Linux</a></li>
      <li><a href="#remove-rvm---linux">Remove RVM - Linux</a></li>
    </ul>
  </li>
</ul>

<p>Out of the box, Ruby does not provide a mechanism to support multiple
installed versions.  Compounding this issue, the default system-installed
version of Ruby for most versions of Linux/Mac OS X tend to be quite old.
For example, even in the latest version of Mac OS X Mountain Lion, the
system-wide version of Ruby is over five years old (ruby 1.8.7).  Most
developers prefer to use a newer version of Ruby installed in their home
directory and to leave the default systemwide version of Ruby untouched.</p>

<p><a href="http://rvm.io">Ruby Version Manager (RVM)</a>  makes installing multiple
versions of Ruby easy.  It’s a great way to use Ruby 1.9.x for your current
development while also being able to play with Ruby 2.0 for newer projects.
RVM also supports partitioning of Ruby gem installs via a feature called
gemsets in order to avoid versioning conflicts.  However, with the advent of
<a href="http://gembundler.com">Bundler</a> most developers tend to prefer using Bundler
as the preferred way for managing gems at the application level.</p>

<p>RVM is supported on Linux and Mac OS X.  RVM doesn’t work on Windows.
For Windows, <a href="https://github.com/vertiginous/pik">Pik</a> is an RVM alternative.</p>

<h1 id="mac-os-x">Mac OS X</h1>

<h2 id="install-rvm-and-ruby-19x---mac-os-x">Install RVM and Ruby 1.9.x - Mac OS X</h2>
<p>First, you’ll need to install a C compiler to build Ruby from source.  Just
download and install the latest version of Xcode from the App Store, if you
don’t have it already.  Also make sure you install the <em>Command Line Tools</em>
by choosing the menu item <code>Xcode -&gt; Preferences...</code> and click
on the <em>Downloads</em> tab.  Click on the <em>Install</em> button to download the
Command Line Tools.
<img src="/images/xcodecommandline.png" alt="Xcode Command Line Tools" /></p>

<p>Next, you’ll need to install the Homebrew package manager.  RVM will
automatically download all dependencies if a package manager is installed.
Also, the dependencies for installing Ruby are complicated enough that it
is helpful to use a package manager to install them, so you can uninstall
them easily if necessary.  Run the following command to install Homebrew:</p>

<pre><code>ruby -e "$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)"
</code></pre>

<p>Run <code>brew doctor</code> and address any issues it discovers.  When
all is well, you should see:</p>

<pre><code>$ brew doctor
Your system is raring to brew.
</code></pre>

<p>After Xcode and Homebrew are installed, you can install RVM with the following
commands:</p>

<pre><code>$ \curl -L https://get.rvm.io | bash -s stable
$ source $HOME/.rvm/scripts/rvm
</code></pre>

<p>Run <code>rvm requirements</code> to install additional dependencies:</p>

<pre><code>$ rvm requirements
Installing requirements for osx, might require sudo password.
Already up-to-date.
Cloning into '/usr/local/Library/Taps/homebrew-dupes'...
remote: Counting objects: 906, done.
remote: Compressing objects: 100% (495/495), done.
remote: Total 906 (delta 498), reused 803 (delta 411)
Receiving objects: 100% (906/906), 157.67 KiB | 112 KiB/s, done.
Resolving deltas: 100% (498/498), done.
Tapped 41 formula
Installing required packages: autoconf, automake, libtool, pkg-config, apple-gcc42, libyaml, readline, libxml2, libxslt, libksba, openssl...........................................................................................................................................................
Updating certificates in '/usr/local/etc/openssl/cert.pem'.
</code></pre>

<p>Tell rvm to automatically install dependencies via Homebrew with the following command:</p>

<pre><code>$ rvm autolibs osx_brew
</code></pre>

<p>Next, build and install the latest version of Ruby by running the following
(this will take a long time):</p>

<pre><code>$ rvm install 1.9.3
</code></pre>

<p>You may get an error message saying “There was an error while trying to
resolve rubygems version for ‘latest’.  Halting the installation.” Just
run the install again like so to fix the issue:</p>

<pre><code>$ rvm reinstall 1.9.3
</code></pre>

<p>Verify the RVM install by running the following commands:</p>

<pre><code>$ rvm -h
$ rvm list
$ rvm use 1.9.3
$ rvm rubygems latest
</code></pre>

<p>To ensure that the newer Ruby 1.9.3 is used by default instead of the
system 1.8.7 version, run the following command:</p>

<pre><code>$ rvm use 1.9.3 --default
</code></pre>

<p>If you’d like to manage RVM with a GUI, check out <a href="http://jewelrybox.unfiniti.com/">JewelryBox</a>:</p>

<p><img src="/images/jewelrybox.png" alt="Jewelry Box" /></p>

<h2 id="install-ruby-187---mac-os-x">Install Ruby 1.8.7 - Mac OS X</h2>
<p>For legacy GUI support, Ruby 1.8.7 has some dependencies on tcl/tk, which
Mountain Lion no longer installs by default (now that X11 is an optional
install).  To compile Ruby 1.8.7 without tcl/tk support, use the following
command overrides on <code>rvm install</code>:</p>

<pre><code>$ rvm install 1.8.7 --with-gcc=clang --without-tcl --without-tk
</code></pre>

<p>To compile Ruby 1.8.7 with tcl/tk support, install X11 via
<a href="http://xquartz.macosforge.org/landing">http://xquartz.macosforge.org/landing</a>
then compile Ruby 1.8.7 with the following:</p>

<pre><code>$ export CPPFLAGS=-I/opt/X11/include
$ CC=/usr/local/bin/gcc-4.2 rvm install 1.8.7
</code></pre>

<h2 id="install-ruby-200---mac-os-x">Install Ruby 2.0.0 - Mac OS X</h2>
<p>Installing Ruby 2.0 is very straightforward, just run the following:</p>

<pre><code>$ rvm install 2.0.0
</code></pre>

<p>Verify the Ruby 2.0 install by running the following commands:</p>

<pre><code>$ rvm use 2.0.0
$ ruby -v
ruby 2.0.0p195 (2013-05-14 revision 40734) [x86_64-darwin12.3.0]
</code></pre>

<p>If you want to make Ruby 2.0 your default version of ruby, run the following:</p>

<pre><code>$ rvm use 2.0.0 --default
</code></pre>

<h2 id="remove-rvm---mac-os-x">Remove RVM - Mac OS X</h2>
<p>Should you want to uninstall/remove RVM, it’s pretty easy.  First, run
the following commands:</p>

<pre><code>$ rvm implode
$ gem uninstall rvm
</code></pre>

<p>Then just follow the instructions from <code>rvm implode</code>:</p>

<ul>
  <li>
    <p>Delete the following files, if they exist:
<code>/etc/rvmrc</code>
<code>$HOME/.rvmrc</code></p>
  </li>
  <li>
    <p>Also, remove the lines sourcing RVM scripts from 
<code>$HOME/.bash_profile</code> <code>/etc/zprofile</code> and 
<code>/etc/profile.d/rvm.sh</code> if they exist.  (A reboot doesn’t hurt
after you do this, just to make sure).</p>
  </li>
</ul>

<p>To uninstall Homebrew, run the following:</p>

<pre><code>cd `brew --prefix`
brew install libtool
rm -rf Cellar
rm `git ls-files`
rm -r Library/Homebrew Library/Aliases Library/Formula Library/Contributions
rm -rf .git
rm -rf ~/Library/Caches/Homebrew
</code></pre>

<h1 id="linux">Linux</h1>

<h2 id="install-rvm-and-ruby-19x---linux">Install RVM and Ruby 1.9.x - Linux</h2>
<p>RVM installation is more straightforward on Linux, as the Ruby source was
designed for the GCC compiler that ships with any Linux distribution.</p>

<p>First install <code>curl</code>, so that you can fetch the RVM script.
For Ubuntu, run
the following command:</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get install -y curl
</code></pre>

<p>For RedHat/CentOS:</p>

<pre><code>$ sudo yum update
$ sudo yum install -y curl
</code></pre>

<p>With curl installed, run the RVM install with the following commands:</p>

<pre><code>$ \curl -L https://get.rvm.io | bash -s stable
$ source $HOME/.rvm/scripts/rvm
</code></pre>

<p>On Ubuntu, run <code>rvm requirements</code> to install additional dependencies:</p>

<pre><code>$ rvm requirements
</code></pre>

<p>For CentOS, <code>rvm requirements</code> will need to download packages from EPEL, so
add the <code>--verify-downloads 1</code> parameter after the <code>rvm requirements</code> command:</p>

<pre><code>$ rvm requirements --verify-downloads 1
</code></pre>

<p>Next build and install Ruby 1.9.3 (this will take awhile):</p>

<pre><code>$ rvm install 1.9.3
$ rvm use 1.9.3
$ rvm rubygems latest
</code></pre>

<p>Verify rvm install:</p>

<pre><code>$ rvm -h
$ rvm list
$ rvm use 1.9.3
$ ruby -v
ruby 1.9.3p429 (2013-05-15 revision 40747) [x86_64-linux]
</code></pre>

<h2 id="install-ruby-200---linux">Install Ruby 2.0.0 - Linux</h2>
<p>Installing Ruby 2.0 is very straightforward, just run the following:</p>

<pre><code>$ rvm install 2.0.0
</code></pre>

<p>Verify the Ruby 2.0 install by running the following commands:</p>

<pre><code>$ rvm use 2.0.0
$ ruby -v
ruby 2.0.0p195 (2013-05-14 revision 40734) [x86_64-linux]
</code></pre>

<p>If you want to make Ruby 2.0 your default version of ruby, run the following:</p>

<pre><code>$ rvm use 2.0.0 --default
</code></pre>

<h2 id="remove-rvm---linux">Remove RVM - Linux</h2>
<p>Should you want to uninstall/remove RVM, it’s pretty easy.  First, run
the following commands:</p>

<pre><code>$ rvm implode
$ gem uninstall rvm
</code></pre>

<p>Then just follow the instructions from <code>rvm implode</code>:</p>

<ul>
  <li>
    <p>Delete the following files, if they exist:
<code>/etc/rvmrc</code>
<code>$HOME/.rvmrc</code></p>
  </li>
  <li>
    <p>Also, remove the lines sourcing RVM scripts from
<code>$HOME/.bash_profile</code> <code>/etc/zprofile</code> and
<code>/etc/profile.d/rvm.sh</code> if they exist.  (A reboot doesn’t hurt
after you do this, just to make sure).</p>
  </li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/15/using-rbenv-to-manage-multiple-versions-of-ruby/">Using Rbenv to Manage Multiple Versions of Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-15T15:53:00-07:00" pubdate data-updated="true">Jun 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#mac-os-x">Mac OS X</a>    <ul>
      <li><a href="#install-rbenv-and-ruby-19x---mac-os-x">Install Rbenv and Ruby 1.9.x - Mac OS X</a></li>
      <li><a href="#install-bundler---mac-os-x">Install Bundler - Mac OS X</a></li>
      <li><a href="#install-ruby-200---mac-os-x">Install Ruby 2.0.0 - Mac OS X</a></li>
      <li><a href="#upgrade-rbenv---mac-os-x">Upgrade Rbenv - Mac OS X</a></li>
      <li><a href="#remove-rbenv---mac-os-x">Remove Rbenv - Mac OS X</a></li>
    </ul>
  </li>
  <li><a href="#linux">Linux</a>    <ul>
      <li><a href="#install-rbenv-and-ruby-19x---linux">Install Rbenv and Ruby 1.9.x - Linux</a></li>
      <li><a href="#install-bundler---linux">Install Bundler - Linux</a></li>
      <li><a href="#install-ruby-200---linux">Install Ruby 2.0.0 - Linux</a></li>
      <li><a href="#upgrade-rbenv---linux">Upgrade Rbenv - Linux</a></li>
      <li><a href="#remove-rbenv---linux">Remove Rbenv - Linux</a></li>
    </ul>
  </li>
</ul>

<p><em>Updated July 9th, 2013:</em></p>

<ul>
  <li><em>Bumped ruby 1.9.3 version from 1.9.3p429 to 1.9.3p448</em></li>
  <li><em>Bumped ruby 2.0.0 version from 2.0.0p195 to 2.0.0p247</em></li>
  <li><em>Removed openssl workaround for compiling ruby 2.0.0 on Mac OS X - this has been fixed</em></li>
</ul>

<p>Out of the box, Ruby does not provide a mechanism to support multiple
installed versions.  Compounding this issue, the default system-installed
version of Ruby for most versions of Linux/Mac OS X tend to be quite old.
For example, even in the latest version of Mac OS X Mountain Lion, the
system-wide version of Ruby is over five years old (ruby 1.8.7).  Most
developers prefer to use a newer version of Ruby installed in their home
directory and to leave the default systemwide version of Ruby untouched.</p>

<p><a href="https://github.com/sstephenson/rbenv/">Rbenv</a> makes managing multiple
versions of Ruby easy.  It’s a great way to work on current development
projects using Ruby 1.9.x and be able to switch to Ruby 2.0.x for new
work.  Rbenv is a lightweight alternative to
<a href="http://rvm.io">Ruby Version Manager (RVM)</a>.  Rbenv does not include
any mechanism to install Ruby or manage gems, like with RVM.</p>

<p>Rbenv is supported on Linux and Mac OS X.  Rbenv doesn’t work on Windows.
For Windows, <a href="https://github.com/vertiginous/pik">Pik</a> is an Rbenv alternative.</p>

<p>NOTE: Rbenv is incompatible with RVM because RVM overrides the
<code>gem</code> command with a function.  If you want to switch to Rbenv,
make sure you uninstall RVM first.  Run the following commands to uninstall
RVM:</p>

<pre><code>$ rvm implode
$ gem uninstall rvm
</code></pre>

<p>Then remove/comment out the RVM loader line in <code>.bash_profile</code>
and/or <code>.bashrc</code></p>

<h1 id="mac-os-x">Mac OS X</h1>

<h2 id="install-rbenv-and-ruby-19x---mac-os-x">Install Rbenv and Ruby 1.9.x - Mac OS X</h2>
<p>First you’ll need to install a C compiler to build Ruby from source.  Just
download and install the latest version of Xcode from the App Store, if you
don’t have it installed already.  Also make sure you install the <em>Command Line
Tools</em> by choosing the menu item <code>Xcode -&gt; Preferences...</code> and click
on the <em>Downloads</em> tab.  Click on the <em>Install</em> button to download the
Command Line Tools.
<img src="/images/xcodecommandline.png" alt="Xcode Command Line Tools" /></p>

<p>Next, you’ll need to install the Homebrew package manager to get all the
dependencies needed to compile Ruby from source.  While you could manage
these dependencies by hand, using a package manager is a better idea, as
package managers know how to uninstall what they install.</p>

<p>Run the following command to install Homebrew:</p>

<pre><code>$ ruby -e "$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)"
</code></pre>

<p>Run <code>brew doctor</code> and address any issues it discovers.  When
all is well, you should see:</p>

<pre><code>$ brew doctor
Your system is raring to brew.
</code></pre>

<p>Next, install the additional dependencies to compile Ruby from source:</p>

<pre><code># For update-system
brew update
brew tap homebrew/dupes
# For ruby
brew install apple-gcc42
</code></pre>

<p>And now install <code>rbenv</code> and the <code>ruby-build</code> plugin:</p>

<pre><code>brew update
brew install rbenv
brew install ruby-build
</code></pre>

<p>Add <code>rbenv init</code> to your shell to enable shims and autocompletion:</p>

<pre><code>$ echo 'eval "$(rbenv init -)"' &gt;&gt; $HOME/.bash_profile
$ source ~/.bash_profile
</code></pre>

<p>Restart shell as a login shell so that the PATH changes take effect:</p>

<pre><code>$ exec $SHELL -l
</code></pre>

<p>Install the latest version of ruby 1.9.x (at the time of this writing 1.9.3-p448)</p>

<pre><code>$ rbenv install 1.9.3-p448
</code></pre>

<p>Rebuild the shim executable</p>

<pre><code>$ rbenv rehash
</code></pre>

<p>You’ll need to run <code>rbenv rehash</code> every time you install a new version of Ruby
or install a new gem.</p>

<p>Set the latest version of ruby to be the default version of ruby</p>

<pre><code>$ rbenv global 1.9.3-p448
</code></pre>

<p>Verify the ruby install.  If everything was installed correctly, the <code>ruby -v</code>
command should report that version 1.9.3p448 is installed.</p>

<pre><code>$ ruby -v
ruby 1.9.3p448 (2013-06-27 revision 41675) [x86_64-darwin12.0.0]
</code></pre>

<h2 id="install-bundler---mac-os-x">Install Bundler - Mac OS X</h2>
<p>You’ll need to use <a href="http://gembundler.com/">Bundler</a> to manage gems.  Installing
a gem is also a good way to ensure that you’ve installed most of the Ruby
prerequisites.</p>

<p>First, make sure you update to the latest version of Rubygems:</p>

<pre><code>$ gem update --system
</code></pre>

<p>Then install the <code>bundler</code> gem.  If the <code>gem install</code> command reports
<code>Successfully installed</code> you’re good to go:</p>

<pre><code>$ gem install bundler
Successfully installed bundler-1.3.5
Parsing documentation for bundler-1.3.5
1 gem installed
$ rbenv rehash
</code></pre>

<h2 id="install-ruby-200---mac-os-x">Install Ruby 2.0.0 - Mac OS X</h2>
<p>As of this writing, Ruby 2.0.0-p247 is the latest version of Ruby 2.0.0.
Use <code>rbenv install --list</code> to print out the available versions.  To install:</p>

<pre><code>$ rbenv install 2.0.0-p247
</code></pre>

<p>To verify the install:</p>

<pre><code>$ rbenv local 2.0.0-p247
$ ruby -v
ruby 2.0.0p247 (2013-06-27 revision 41674) [x86_64-darwin12.0.0]
</code></pre>

<p>If you want to make Ruby 2.0.0 the global default version of ruby:</p>

<pre><code>$ rbenv global 2.0.0-p247
</code></pre>

<h2 id="upgrade-rbenv---mac-os-x">Upgrade Rbenv - Mac OS X</h2>
<p>To upgrade rbenv via homebrew:</p>

<pre><code>$ brew update
$ brew upgrade rbenv
$ brew upgrade ruby-build
</code></pre>

<h2 id="remove-rbenv---mac-os-x">Remove Rbenv - Mac OS X</h2>
<p>Uninstall the packages you installed via homebrew:</p>

<pre><code>brew uninstall rbenv
brew uninstall ruby-build
</code></pre>

<p>Remove the following directory:</p>

<pre><code>rm -rf $HOME/.rbenv
</code></pre>

<p>And remember to remove whatever you added to <code>$HOME/.bash_profile</code></p>

<h1 id="linux">Linux</h1>

<h2 id="install-rbenv-and-ruby-19x---linux">Install Rbenv and Ruby 1.9.x - Linux</h2>
<p>Make sure the prerequisite packages are installed.</p>

<p>Ubuntu prerequisites:</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get install -y build-essential git
$ sudo apt-get install -y libxml2-dev libxslt-dev libssl-dev
</code></pre>

<p>RHEL/CentOS prerequisites:</p>

<pre><code>$ sudo yum update
$ sudo yum install -y git
$ sudo yum install -y gcc-c++ patch readline readline-devel zlib zlib-devel
$ sudo yum install -y libyaml-devel libffi-devel openssl-devel make bzip2
$ sudo yum install -y autoconf automake libtool bison
$ sudo yum install -y libxml2-devel libxslt-devel 
</code></pre>

<p>Download the rbenv source distribution to
$HOME/.rbenv:</p>

<pre><code>$ git clone git://github.com/sstephenson/rbenv.git $HOME/.rbenv
</code></pre>

<p>Add $HOME/.rbenv/bin to your $PATH</p>

<pre><code>$ echo 'export PATH="$HOME/.rbenv/bin:$PATH"' &gt;&gt; $HOME/.bashrc
</code></pre>

<p>Add <code>rbenv init</code> to your shell to enable shims and autocompletion:</p>

<pre><code>$ echo 'eval "$(rbenv init -)"' &gt;&gt; $HOME/.bashrc
</code></pre>

<p>Restart shell as a login shell so that the PATH changes take effect:</p>

<pre><code>$ exec $SHELL -l
</code></pre>

<p>Install the <code>ruby-build</code> plugin, which provides an
<code>rbenv install</code> command to simplify the process of compiling
and install new Ruby versions:</p>

<pre><code>$ git clone git://github.com/sstephenson/ruby-build.git $HOME/.rbenv/plugins/ruby-build
</code></pre>

<p>Install the latest version of ruby 1.9.x (at the time of this writing 1.9.3-p448)</p>

<pre><code>$ rbenv install 1.9.3-p448
</code></pre>

<p>Rebuild the shim executable</p>

<pre><code>$ rbenv rehash
</code></pre>

<p>You’ll need to run <code>rbenv rehash</code> every time you install a new
version of Ruby or install a new gem.</p>

<p>Set the latest version of ruby to be the default version of ruby</p>

<pre><code>$ rbenv global 1.9.3-p448
</code></pre>

<p>Verify the ruby install.  If everything was installed correctly, the
<code>ruby -v</code> command should report that version 1.9.3p448 is installed.</p>

<pre><code>$ ruby -v
ruby 1.9.3p448 (2013-06-27 revision 41675) [x86_64-linux]
</code></pre>

<h2 id="install-bundler---linux">Install Bundler - Linux</h2>

<p>You’ll need to use <a href="http://gembundler.com/">Bundler</a> to manage gems.
Installing a gem is also a good way to ensure that you’ve installed most
of the Ruby prerequisites.</p>

<p>First, make sure you update to the latest version of Rubygems:</p>

<pre><code>$ gem update --system
</code></pre>

<p>Then install the <code>bundler</code> gem.  If the <code>gem install</code> command reports
<code>Successfully installed</code> you’re good to go:</p>

<pre><code>$ gem install bundler
Successfully installed bundler-1.3.5
Parsing documentation for bundler-1.3.5
1 gem installed
$ rbenv rehash
</code></pre>

<h2 id="install-ruby-200---linux">Install Ruby 2.0.0 - Linux</h2>
<p>As of this writing, Ruby 2.0.0-p247 is the latest version of Ruby 2.0.0.
Use <code>rbenv install --list</code> to print out the available versions.  To install:</p>

<pre><code>$ rbenv install 2.0.0-p247
</code></pre>

<p>To verify the install:</p>

<pre><code>$ rbenv local 2.0.0-p247
$ ruby -v
ruby 2.0.0p247 (2013-06-27 revision 41674) [x86_64-linux] 
</code></pre>

<p>If you want to make Ruby 2.0.0 the global default version of ruby:</p>

<pre><code>$ rbenv global 2.0.0-p247
</code></pre>

<h2 id="upgrade-rbenv---linux">Upgrade Rbenv - Linux</h2>
<p>Since Rbenv is a Git repository, upgrading is just a matter of refreshing the
source:</p>

<pre><code>$ cd $HOME/.rbenv
$ git pull
</code></pre>

<h2 id="remove-rbenv---linux">Remove Rbenv - Linux</h2>
<p>To uninstall/remove Rbenv, remove the following directory:</p>

<pre><code>$ rm -rf $HOME/.rbenv
</code></pre>

<p>And remember to remove whatever you added to <code>$HOME/.bash_profile</code></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/08/06/getting-started-writing-chef-cookbooks-the-berkshelf-way-part3/">Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/28/windows-server-2012-automated-install-settings/">Windows Server 2012 Automated Install Settings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/27/windows-8-automated-install-settings/">Windows 8 Automated Install Settings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/26/windows-7-automated-install-settings/">Windows 7 Automated Install Settings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/25/windows-server-2008-r2-automated-install-settings/">Windows Server 2008 R2 automated install settings</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/misheska">@misheska</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'misheska',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Mischa Taylor -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
