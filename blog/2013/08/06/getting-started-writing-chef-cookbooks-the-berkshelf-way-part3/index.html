
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 3 - Mischa Taylor's Coding Blog</title>
  <meta name="author" content="Mischa Taylor">

  
  <meta name="description" content="Iteration #13 - Install Test Kitchen Testing Iteration #13 - Show the Test Kitchen version Iteration #14 - Create a Kitchen YAML file Testing &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://misheska.com/blog/2013/08/06/getting-started-writing-chef-cookbooks-the-berkshelf-way-part3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mischa Taylor's Coding Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38545837-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mischa Taylor's Coding Blog</a></h1>
  
    <h2>On the edge of time and reason</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:misheska.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/contact">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-06T12:46:00-07:00" pubdate data-updated="true">Aug 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><ul id="markdown-toc">
  <li><a href="#iteration-13---install-test-kitchen">Iteration #13 - Install Test Kitchen</a>    <ul>
      <li><a href="#testing-iteration-13---show-the-test-kitchen-version">Testing Iteration #13 - Show the Test Kitchen version</a></li>
    </ul>
  </li>
  <li><a href="#iteration-14---create-a-kitchen-yaml-file">Iteration #14 - Create a Kitchen YAML file</a>    <ul>
      <li><a href="#testing-iteration-14---provision-with-test-kitchen">Testing Iteration #14 - Provision with Test Kitchen</a></li>
    </ul>
  </li>
  <li><a href="#iteration-15---provisioning-on-ubuntu">Iteration #15 - Provisioning on Ubuntu</a>    <ul>
      <li><a href="#testing-iteration-15---deploy-locally-to-ubuntu-1204">Testing Iteration #15 - Deploy locally to Ubuntu 12.04</a></li>
    </ul>
  </li>
  <li><a href="#iteration-16---writing-your-first-serverspec-test">Iteration #16 - Writing your first Serverspec test</a>    <ul>
      <li><a href="#testing-iteration-16---running-your-first-serverspec-test">Testing Iteration #16 - Running your first Serverspec test</a></li>
    </ul>
  </li>
  <li><a href="#iteration-17---completing-the-webserver-test-suite">Iteration #17 - Completing the webserver test suite</a></li>
</ul>

<p>NOTE: Preview for beta testers to review…</p>

<p>This is the third article in a series on writing Opscode Chef cookbooks the
Berkshelf Way.  Here’s a link to <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a> and
<a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>.  The source code examples covered in this
article can be found on Github: <a href="https://github.com/misheska/myface">https://github.com/misheska/myface</a></p>

<p>In this installment, we’re going to learn how to use Test Kitchen to 
automate all the verification steps we did by hand for each iteration in
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a> and
<a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>.  If not anything else, it’s worth learning
Test Kitchen because OpsCode, the company that makes Chef, has encouraged the
use of Test Kitchen to verify community cookbooks.</p>

<p>Test Kitchen is built on top of vagrant and supplements the <code>Vagrantfile</code> file
you have been using so far in this series to do local automated testing.  The
main benefit to Test Kitchen is that it makes it easy to run tests on multiple
platforms in parallel, which is more difficult to do with just a <code>Vagrantfile</code>.
We’ll be showcasing this aspect of Test Kitchen by ensuring that Myface works
on both the CentOS 6.4 and Ubuntu 12.04 Linux distributions.</p>

<h1 id="iteration-13---install-test-kitchen">Iteration #13 - Install Test Kitchen</h1>
<p>Edit <code>myface/Gemfile</code> and add the following line to load the
Test Kitchen gem:</p>

<pre><code>gem 'test-kitchen', '~&gt; 1.0.0.beta.2'
</code></pre>

<p>Your <code>myface/Gemfile</code> should look like the following after editing:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/Gemfile  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;berkshelf&#39;</span>
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;test-kitchen&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.0.0.beta.2&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Test Kitchen is in beta release and is still evolving rapidly.  The
1.0.0.beta.2 version constraint will ensure that you are using the latest
stable prerelease version.</p>

<p>After you have updated the <code>Gemfile</code> run <code>bundle install</code> to download the
test-kitchen gem and all its dependencies:</p>

<pre><code>$ bundle install
Fetching gem metadata from https://rubygems.org/........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using i18n (0.6.4)
Using multi_json (1.7.8)
Using activesupport (3.2.14)
...
Installing test-kitchen (1.0.0.beta.2)
Using bundler (1.3.5)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<h2 id="testing-iteration-13---show-the-test-kitchen-version">Testing Iteration #13 - Show the Test Kitchen version</h2>

<p>If everything worked properly you should be able to run the <code>kitchen --version</code>
command to see your installed Test Kitchen’s version information</p>

<pre><code>$ kitchen --version
Test Kitchen version 1.0.0.beta.2
</code></pre>

<h1 id="iteration-14---create-a-kitchen-yaml-file">Iteration #14 - Create a Kitchen YAML file</h1>

<p>In order to use Test Kitchen on a cookbook, first you need to add a few more
dependencies and create a template Kitchen YAML file.  Test Kitchen makes this
easy by providing the <code>kitchen init</code> command to perform all these
initialization steps automatically </p>

<pre><code>$ kitchen init
      create  .kitchen.yml
      append  Thorfile
      create  test/integration/default
      append  .gitignore
      append  .gitignore
      append  Gemfile
You must run 'bundle install' to fetch any new gems.
</code></pre>

<p>Since <code>kitchen init</code> modified your Gemfile, you need to re-run <code>bundle install</code>
(as suggested above) to pick up the new gem dependencies:</p>

<pre><code>$ bundle install
Fetching gem metadata from https://rubygems.org/........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using i18n (0.6.4)
Using multi_json (1.7.8)
Using activesupport (3.2.14)
...
Using safe_yaml (0.9.5)
Using test-kitchen (1.0.0.beta.2)
Installing kitchen-vagrant (0.11.0)
Using bundler (1.3.5)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<p>Most importantly, this new <code>bundle install</code> pass installed the
<code>kitchen-vagrant</code> vagrant driver for Test Kitchen.</p>

<p>Now that you have created a <code>.kitchen.yml</code> Kitchen YAML file and loaded all
the necessary gems, let’s customize the file so that we’ll use 
to verify that the Myface cookbook works on CentOS 6.4, like we were doing in
the previous installments with the <code>Vagrantfile</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/.kitchen.yml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="nn">---</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">require_chef_omnibus</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">platforms</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">centos-6.4</span>
</span><span class="line">  <span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">box</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">misheska-centos64</span>
</span><span class="line">    <span class="l-Scalar-Plain">box_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-centos64.box</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">suites</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class="line">  <span class="l-Scalar-Plain">run_list</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;recipe[myface]&quot;</span><span class="p-Indicator">]</span>
</span><span class="line">  <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">mysql</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">server_root_password</span><span class="p-Indicator">:</span> <span class="s">&quot;rootpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_debian_password</span><span class="p-Indicator">:</span> <span class="s">&quot;debpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_repl_password</span><span class="p-Indicator">:</span> <span class="s">&quot;replpass&quot;</span> <span class="p-Indicator">}</span> <span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Everything in the YAML file should be straightforward to understand, except
perhaps the <code>attributes</code> item in the <code>suites</code> stanza.  These values 
came from the <code>Vagrantfile</code> we used in the previous installments of this
series.  Here’s an excerpt from the <code>Vagrantfile</code> - at the end are some
values that Berkshelf initialzed (which we used in
<a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>).</p>

<pre><code>...
  config.vm.provision :chef_solo do |chef|
    chef.json = {
      :mysql =&gt; {
        :server_root_password =&gt; 'rootpass',
        :server_debian_password =&gt; 'debpass',
        :server_repl_password =&gt; 'replpass'
      }
    }

   chef.run_list = [
        "recipe[myface::default]"
    ]
  end
end
</code></pre>

<p>Those <code>Vagrantfile</code> attributes were just converted into a format that the
Test Kitchen YAML file format finds acceptable.</p>

<p>You can add even more Vagrantfile customizations to your <code>kitchen.yml</code> file
if you like.  For example, you can assign a host-only network IP so you can
look at the MyFace website with a browser on your host.  Add the following
<code>network:</code> block to a platform’s <code>driver_config:</code>:</p>

<pre><code>...
driver_config:
  network:
  - ["private_network", {ip: "33.33.33.10"}]
...
</code></pre>

<p>After adding this block your <code>.kitchen.yml</code> should look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/.kitchen.yml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="nn">---</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">require_chef_omnibus</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">platforms</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">centos-6.4</span>
</span><span class="line">  <span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">box</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">misheska-centos64</span>
</span><span class="line">    <span class="l-Scalar-Plain">box_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-centos64.box</span>
</span><span class="line">    <span class="l-Scalar-Plain">network</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="p-Indicator">[</span><span class="s">&quot;private_network&quot;</span><span class="p-Indicator">,</span> <span class="p-Indicator">{</span><span class="nv">ip</span><span class="p-Indicator">:</span> <span class="s">&quot;33.33.33.10&quot;</span><span class="p-Indicator">}]</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">suites</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class="line">  <span class="l-Scalar-Plain">run_list</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;recipe[myface]&quot;</span><span class="p-Indicator">]</span>
</span><span class="line">  <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">mysql</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">server_root_password</span><span class="p-Indicator">:</span> <span class="s">&quot;rootpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_debian_password</span><span class="p-Indicator">:</span> <span class="s">&quot;debpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_repl_password</span><span class="p-Indicator">:</span> <span class="s">&quot;replpass&quot;</span> <span class="p-Indicator">}</span> <span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>For more information on the <code>kitchen-vagrant</code> settings, refer to the
README.md file for <code>kitchen-vagrant</code> at <a href="https://github.com/opscode/kitchen-vagrant/blob/master/README.md">https://github.com/opscode/kitchen-vagrant/blob/master/README.md</a></p>

<h2 id="testing-iteration-14---provision-with-test-kitchen">Testing Iteration #14 - Provision with Test Kitchen</h2>

<p>You can do nearly everything that you were doing with vagrant just using Test
Kitchen.  The Test Kitchen equivalent of the <code>vagrant up</code> command is 
<code>kitchen converge</code>.  Try running the <code>kitchen converge</code> command now to verify
that your <code>.kitchen.yml</code> file is valid.  When you run <code>kitchen converge</code> it will
spin up a CentOS 6.4 vagrant test node instance and use Chef Solo to provision
the MyFace cookbook on the test node:</p>

<pre><code>$ kitchen converge 
-----&gt; Starting Kitchen (v1.0.0.beta.2)
-----&gt; Creating &lt;default-centos-64&gt;
       [kitchen::driver::vagrant command] BEGIN (vagrant up --no-provision)
       Bringing machine 'default' up with 'virtualbox' provider...
       [default] Importing base box 'misheska-centos64'...
       [default] Matching MAC address for NAT networking...
       [default] Setting the name of the VM...
       [default] Clearing any previously set forwarded ports...
       [Berkshelf] Skipping Berkshelf with --no-provision
       [default] Fixed port collision for 22 =&gt; 2222. Now on port 2200.
       [default] Creating shared folders metadata...
       [default] Clearing any previously set network interfaces...
       [default] Preparing network interfaces based on configuration...
       [default] Forwarding ports...
       [default] -- 22 =&gt; 2200 (adapter 1)
       [default] Running 'pre-boot' VM customizations...
       [default] Booting VM...
       [default] Waiting for VM to boot. This can take a few minutes.
       [default] VM booted and ready for use!
       [default] Setting hostname...
       [default] Mounting shared folders...
       [default] -- /vagrant
       [kitchen::driver::vagrant command] END (0m39.38s)
       [kitchen::driver::vagrant command] BEGIN (vagrant ssh-config)
       [kitchen::driver::vagrant command] END (0m2.85s)
       Vagrant instance &lt;default-centos-64&gt; created.
       Finished creating &lt;default-centos-64&gt; (0m46.19s).
-----&gt; Converging &lt;default-centos-64&gt;
-----&gt; Installing Chef Omnibus (true)
       --2013-08-07 07:25:35--  https://www.opscode.com/chef/install.sh
Resolving www.opscode.com...        184.106.28.82
       Connecting to www.opscode.com|184.106.28.82|:443...
       connected.
HTTP request sent, awaiting response...        200 OK
       Length: 6790 (6.6K) [application/x-sh]
       Saving to: “STDOUT”

 0% [                                       ] 0           --.-K/s
100%[======================================&gt;] 6,790       --.-K/s   in 0s
 
       2013-08-07 07:25:40 (461 MB/s) - written to stdout [6790/6790]

       Downloading Chef  for el...
       Installing Chef
       warning: /tmp/tmp.wAJrUjYo/chef-.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY
Preparing...                #####  ########################################### [100%]
   1:chef                          ########################################### [100%]
       Thank you for installing Chef!
       Resolving cookbook dependencies with Berkshelf
Using myface (2.0.0)
...
       Recipe: apache2::default
         * service[apache2] action restart[2013-08-07T07:28:54+00:00] INFO: Processing service[apache2] action restart (apache2::default line 221)
       [2013-08-07T07:28:55+00:00] INFO: service[apache2] restarted

           - restart service service[apache2]

       [2013-08-07T07:28:55+00:00] INFO: Chef Run complete in 162.083058446 seconds
       [2013-08-07T07:28:55+00:00] INFO: Running report handlers
       [2013-08-07T07:28:55+00:00] INFO: Report handlers complete
       Chef Client finished, 97 resources updated
       Finished converging &lt;default-centos-64&gt; (3m20.62s).
-----&gt; Setting up &lt;default-centos-64&gt;
       Finished setting up &lt;default-centos-64&gt; (0m0.00s).
-----&gt; Kitchen is finished. (4m11.93s)
</code></pre>

<p>To display the results of the Chef Run, type in the <code>kitchen list</code> command:</p>

<pre><code>$ kitchen list
Instance           Driver   Provisioner  Last Action
default-centos-64  Vagrant  Chef Solo    Set Up
</code></pre>

<p>If the run succeeded, it should display <code>Set Up</code> in the <code>Last Action</code> field.</p>

<p>The Test Kitchen equivalent of the <code>vagrant ssh</code> command is <code>kitchen login</code>.
Since Test Kitchen supports multiple instances, you will need to pass in
the instance name for which you wish to login as a parameter (which you can
get from the <code>kitchen list</code> output).  We want to login to the CentOS 6.4
instance (the only instance for now), so type in the command
<code>kitchen login default-centos-64</code> to login:</p>

<pre><code>$ kitchen login default-centos-64
Last login: Wed Aug  7 07:39:31 2013 from 10.0.2.2
[vagrant@default-centos-64 ~]$
</code></pre>

<p>Now you can poke around in the image the same way you did with <code>vagrant ssh</code>,
for example, verifying that the httpd server is running:</p>

<pre><code>[vagrant@default-centos-64 ~]$ sudo /sbin/service httpd status
httpd (pid  3737) is running...
</code></pre>

<p>After you are done working in the test instance, make sure to run the
<code>exit</code> command to log out so that you return back to your host prompt:</p>

<pre><code>[vagrant@default-centos-64 ~]$ exit
logout
Connection to 127.0.0.1 closed.
</code></pre>

<p>Should you need it, the Test Kitchen equivalent of <code>vagrant destroy</code> is
<code>kitchen destroy</code>.  If you make a change to the chef cookbook and
want to re-deploy, the Test Kitchen equivalent of <code>vagrant provision</code> is
<code>kitchen converge</code>.</p>

<p>Since you added a private IP for you instance, you can also view the
MyFace website on your host with your favorite web browser:</p>

<p><a href="http://33.33.33.10">http://33.33.33.10</a></p>

<p><img src="/images/welcometomyface2.png" alt="Welcome to MyFace" /></p>

<h1 id="iteration-15---provisioning-on-ubuntu">Iteration #15 - Provisioning on Ubuntu</h1>

<p>We haven’t really made use of any unique Test Kitchen features yet, let’s
start now.  We’ll also deploy our cookbook locally to Ubuntu 12.04 for
testing, in addition to CentOS 6.4.</p>

<p>Edit <code>.kitchen.yml</code> and add a reference to a Ubuntu 12.04 basebox alongside
the existing CentOS 6.4 basebox in the <code>platforms</code> stanza:</p>

<pre><code>-name: ubuntu-12.04
 driver_config:
   box: misheska-ubuntu1204
   box_url: https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-ubuntu1204.box
   network:
   - ["private_network", {ip: "33.33.33.11"}]
</code></pre>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/.kitchen.yml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="nn">---</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class="line"><span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">require_chef_omnibus</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">platforms</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">centos-6.4</span>
</span><span class="line">  <span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">box</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">misheska-centos64</span>
</span><span class="line">    <span class="l-Scalar-Plain">box_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-centos64.box</span>
</span><span class="line">    <span class="l-Scalar-Plain">network</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="p-Indicator">[</span><span class="s">&quot;private_network&quot;</span><span class="p-Indicator">,</span> <span class="p-Indicator">{</span><span class="nv">ip</span><span class="p-Indicator">:</span> <span class="s">&quot;33.33.33.10&quot;</span><span class="p-Indicator">}]</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu-12.04</span>
</span><span class="line">  <span class="l-Scalar-Plain">driver_config</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">box</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">misheska-ubuntu1204</span>
</span><span class="line">    <span class="l-Scalar-Plain">box_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://s3-us-west-2.amazonaws.com/misheska/vagrant/virtualbox/misheska-ubuntu1204.box</span>
</span><span class="line">    <span class="l-Scalar-Plain">network</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="p-Indicator">[</span><span class="s">&quot;private_network&quot;</span><span class="p-Indicator">,</span> <span class="p-Indicator">{</span><span class="nv">ip</span><span class="p-Indicator">:</span> <span class="s">&quot;33.33.33.11&quot;</span><span class="p-Indicator">}]</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">suites</span><span class="p-Indicator">:</span>
</span><span class="line"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class="line">  <span class="l-Scalar-Plain">run_list</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;recipe[myface]&quot;</span><span class="p-Indicator">]</span>
</span><span class="line">  <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">mysql</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">server_root_password</span><span class="p-Indicator">:</span> <span class="s">&quot;rootpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_debian_password</span><span class="p-Indicator">:</span> <span class="s">&quot;debpass&quot;</span><span class="p-Indicator">,</span> <span class="nv">server_repl_password</span><span class="p-Indicator">:</span> <span class="s">&quot;replpass&quot;</span> <span class="p-Indicator">}</span> <span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Before we run <code>kitchen converge</code> to do a Chef run, we need to fix our cookbook
so it will run successfully on Ubuntu 12.04.  If you tried to deploy now you
would notice that the MyFace cookbook would fail to deploy to Ubuntu 12.04
successfully due to a reference to the <code>php-mysql</code> package in 
<code>myface/receipes/webserver.rb</code>.</p>

<pre><code>... 
include_recipe "apache2"
include_recipe "apache2::mod_php5"

package "php-mysql" do
  action :install
  notifies :restart, "service[apache2]"
end
...
</code></pre>

<p>On Ubuntu the package name should be <code>php5-mysql</code> instead of <code>php-mysql</code>.</p>

<p>As with most issues in the Chef world, there’s a cookbook for that!
The Opscode <code>php</code> cookbook has conditionals to reference the correct name
for the <code>php-mysql</code> package on a number of platforms.</p>

<p>Edit <code>myface/metadata.rb</code> and add a reference to the latest version of the
<code>php</code> cookbook (currently 1.2.3):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/metadata.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="rb"><span class="line"><span class="nb">name</span>             <span class="s1">&#39;myface&#39;</span>
</span><span class="line"><span class="n">maintainer</span>       <span class="s1">&#39;Mischa Taylor&#39;</span>
</span><span class="line"><span class="n">maintainer_email</span> <span class="s1">&#39;mischa@misheska.com&#39;</span>
</span><span class="line"><span class="n">license</span>          <span class="s1">&#39;Apache 2.0&#39;</span>
</span><span class="line"><span class="n">description</span>      <span class="s1">&#39;Installs/Configures myface&#39;</span>
</span><span class="line"><span class="n">long_description</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;README.md&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">version</span>          <span class="s1">&#39;2.0.0&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;apache2&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.6.0&quot;</span>
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 3.0.0&quot;</span>
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.3.0&quot;</span>
</span><span class="line"><span class="n">depends</span> <span class="s2">&quot;php&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.2.0&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In <code>myface/recipes/webserver.rb</code> replace the <code>package "php-mysql" do ... end</code>
block with the following reference:</p>

<pre><code>include_recipe "php::module_mysql"
</code></pre>

<p>After editing, <code>myface/recipes/webserver.rb</code> should look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/recipes/metadata.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
</pre></td><td class="code"><pre><code class="rb"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Cookbook Name:: myface</span>
</span><span class="line"><span class="c1"># Recipe:: webserver</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Copyright (C) 2013 YOUR_NAME</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># All rights reserved - Do Not Redistribute</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:user</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:group</span><span class="o">]</span>
</span><span class="line">  <span class="nb">system</span> <span class="kp">true</span>
</span><span class="line">  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;apache2::mod_php5&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">include_recipe</span> <span class="s2">&quot;php::module_mysql&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># disable default site</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;000-default&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">false</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create apache config</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;apache2.conf.erb&quot;</span>
</span><span class="line">  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[apache2]&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># create document root</span>
</span><span class="line"><span class="n">directory</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">action</span> <span class="ss">:create</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0755&quot;</span>
</span><span class="line">  <span class="n">recursive</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># write site</span>
</span><span class="line"><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:document_root</span><span class="o">]</span><span class="si">}</span><span class="s2">/index.php&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">source</span> <span class="s2">&quot;index.php.erb&quot;</span>
</span><span class="line">  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># enable myface</span>
</span><span class="line"><span class="n">apache_site</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:myface</span><span class="o">][</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class="line">  <span class="n">enable</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="testing-iteration-15---deploy-locally-to-ubuntu-1204">Testing Iteration #15 - Deploy locally to Ubuntu 12.04</h2>

<p>Now that we’ve fixed up our cookbook to work on Ubuntu 12.04, let’s test it
out!  Run <code>kitchen list</code> to display the list of Test Kitchen instances:</p>

<pre><code>Instance             Driver   Provisioner  Last Action
default-centos-64    Vagrant  Chef Solo    Set Up
default-ubuntu-1204  Vagrant  Chef Solo    &lt;Not Created&gt;
</code></pre>

<p>Notice that after editing the <code>.kitchen.yml</code> we now have an Ubuntu 12.04
instance called <code>default-ubuntu-1204</code> and it is in the <code>&lt;Not Created&gt;</code>
state.</p>

<p>Go ahead setup the Ubuntu 12.04 instance by running the following command:</p>

<pre><code>$ kitchen converge default-ubuntu-1204
</code></pre>

<p>Note that this time we added an optional instance parameter so that Test
Kitchen only performs the action against the specified instance.  If you do
not specify this parameter, it defaults to <code>all</code>, running the command against
all instances.  After about 5-10 minutes or so, you should observe that Test
Kitchen downloaded an Ubuntu 12.04 basebox, booted a VM with the basebox, and
successfully deployed our chef cookbook.</p>

<p>Run the <code>kitchen list</code> command again to verify that the Ubuntu 12.04 instance
is now in the <code>Set Up</code> state as well, showing that there were no errors:</p>

<pre><code>Instance             Driver   Provisioner  Last Action
default-centos-64    Vagrant  Chef Solo    Set Up
default-ubuntu-1204  Vagrant  Chef Solo    Set Up
</code></pre>

<p>You just fixed an error with the MyFace cookbook that prevented deployment to
Ubuntu 12.04, and verified that the cookbook correctly deploys to both 
Ubuntu 12.04 and Centos 6.4.</p>

<p>Use the <code>kitchen login</code> command to ssh into each instance and poke around
if you like.  You now have two local vagrant VMs instantiated to play with!</p>

<pre><code>$ kitchen login default-ubuntu-1204
Welcome to Ubuntu 12.04.2 LTS (GNU/Linux 3.5.0-23-generic x86_64)

 * Documentation:  https://help.ubuntu.com/
Last login: Thu Aug  8 08:40:50 2013 from 10.0.2.2
$ [...poke around, run some commands...]
$ exit
Connection to 127.0.0.1 closed.

$ kitchen login default-centos-64
Last login: Thu Aug  8 08:54:44 2013 from 10.0.2.2
Welcome to your Packer-built virtual machine.
[vagrant@default-centos-64 ~]$ [...poke around, run some commands...]
[vagrant@default-centos-64 ~]$ exit
logout
Connection to 127.0.0.1 closed.
</code></pre>

<p>You can view the websites for each instance by viewing the appropriate
private IP</p>

<pre><code>CentOS 6.4:   http://33.33.33.10
Ubuntu 12.04: http://33.33.33.11
</code></pre>

<h1 id="iteration-16---writing-your-first-serverspec-test">Iteration #16 - Writing your first Serverspec test</h1>

<p>While it’s really helpful to know now that the Myface cookbook will converge on
both a CentOS 6.4 and Ubuntu 12.04 setup, we haven’t written any tests yet.
Let’s do that.</p>

<p>It’s helpful to know that Test Kitchen was designed as a framework for
post-convergence system testing.  You are supposed to set up a bunch of test
instances, perform a Chef run to apply your cookbook’s changes to them, then
when this is process is complete your tests can inspect the state of each
test instance after the Chef run is finished.  This is how we tested our
nodes by hand in <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a>
and <a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>.  Now we are going to automate the process.</p>

<p>NOTE: It is a <a href="http://watirmelon.com/2012/01/31/introducing-the-software-testing-ice-cream-cone/">testing anti-pattern to rely too much on system tests, even if they are automated</a>
so make sure you are judgicious in your use of system tests.  It can be
difficult to maintain a lot of system tests over time and keep them relevant.
The tests you performed by hand in <a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a>
and <a href="http://misheska.com/blog/2013/06/23/getting-started-writing-chef-cookbooks-the-berkshelf-way-part2/">Part 2</a>
to verify MyFace are at just the right level of detail for a system test.
Do just enough to verify that the system works correctly after it was
configured.  In a future post, I’ll cover unit tests in more detail using
<a href="http://acrmp.github.io/chefspec/">Chefspec</a> and
<a href="https://github.com/guard/guard">Guard</a>.  For now, let’s focus on system tests.</p>

<p>Test Kitchen finds tests by following a directory naming convention.  When
you installed Test Kitchen, it created the <code>test/integration/default</code>
subdirectory underneath your main cookbook.  It looks for test code in the
following directory underneath <code>test/integration</code>:</p>

<pre><code>&lt;COOKBOOOK-PATH&gt;/test/integration/&lt;TEST-SUITE-NAME&gt;/&lt;PLUGIN-NAME&gt;
</code></pre>

<p>A collection of tests is called a <a href="http://en.wikipedia.org/wiki/Test_suite">test suite</a>.  Following Test Kitchen install’s lead, we’ll just call our first
suite of tests <code>default</code>.  Test Kitchen has a number of plugins which will
install and setup any components necessary for running tests.  We’ll be using
the <code>severspec</code> plugin for our tests.  So you will be placing your test files
in the following directory:</p>

<pre><code>myface/test/integration/default/serverspec
</code></pre>

<p>Create the <code>myface/test/integration/default/serverspec</code> subdirectory now.</p>

<p>To start, we need to add a Ruby helper script which loads our Test Kitchen
plugin.  We’ll call it
<code>myface/test/integration/default/serverspec/spec_helper.rb</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/test/integration/default/serverspec/spec_helper.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;serverspec&#39;</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;pathname&#39;</span>
</span><span class="line">
</span><span class="line"><span class="kp">include</span> <span class="ss">Serverspec</span><span class="p">:</span><span class="ss">:Helper</span><span class="o">::</span><span class="no">Exec</span>
</span><span class="line"><span class="kp">include</span> <span class="ss">Serverspec</span><span class="p">:</span><span class="ss">:Helper</span><span class="o">::</span><span class="no">DetectOS</span>
</span><span class="line">
</span><span class="line"><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class="line">  <span class="n">c</span><span class="o">.</span><span class="n">before</span> <span class="ss">:all</span> <span class="k">do</span>
</span><span class="line">    <span class="n">c</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">backend</span><span class="p">(</span><span class="ss">Serverspec</span><span class="p">:</span><span class="ss">:Commands</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span><span class="o">.</span><span class="n">check_os</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This code is modeled after the examples provided on the
<a href="http://serverspec.org/tutorial.html">serverspec</a> website.</p>

<p>Create a subdirectory underneath <code>myface/test/integration/default/serverspec</code>
called <code>localhost</code>:</p>

<pre><code>myface/test/integration/default/serverspec/localhost
</code></pre>

<p>It is a serverspec convention to put tests (a.k.a. “specs”) underneath
<code>spec_helper.rb</code> in a subdirectory denoting the host name to be tested.
Serverspec supports testing via SSH access to remote hosts.  We won’t
be using this capability as we will be testing local images, so we’ll just
use <code>localhost</code> for the host name.</p>

<p>Now, let’s write our first test!  If you recall in 
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/#testing-iteration-1">Testing Iteration #1</a>, we ran
the following command to verify that the myface user was created:</p>

<pre><code>$ getent password myface
myface:x:497:503::/home/myface:/bin/bash
</code></pre>

<p>Create the following file with a serverspec test to perform the same
action:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>myface/test/integration/default/serverspec/localhost/webserver_spec.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">describe</span> <span class="s1">&#39;MyFace webserver&#39;</span> <span class="k">do</span>
</span><span class="line">
</span><span class="line">  <span class="n">it</span> <span class="s1">&#39;should have a myface user&#39;</span>
</span><span class="line">    <span class="n">expect</span><span class="p">(</span><span class="n">command</span> <span class="s1">&#39;getent passwd myface&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">return_stdout</span> <span class="sr">/myface:x:\d+:\d+::\/home\/myface:\/bin\/bash/</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Serverspec provides extensions to Rspec to help you more easily test servers.
If you’re not familiar with Rspec syntax, Code School has an excellent
tutorial on <a href="http://rspec.codeschool.com/">Testing with Rspec</a>.  Even if you
don’t know Rspec, you should still be able to follow along with
provided examples.</p>

<p>You can find a list of serverspec resources at the following link:
<a href="http://serverspec.org/resource_types.html">http://serverspec.org/resource_types.html</a>.  We’re using the <code>command</code>
resource to run the command <code>getent password myface</code> and match the
resultant output with a Ruby regular expression (because the uid and gid
field could be any number between 100-999, because myface is a system
account).</p>

<h2 id="testing-iteration-16---running-your-first-serverspec-test">Testing Iteration #16 - Running your first Serverspec test</h2>

<p>OK, let’s run our first test!</p>

<p>To start you need to run <code>kitchen setup</code> so that Test Kitchen loads and
configures all the required plugins.  In keeping with the restaurant theme,
the component that manages Test Kitchen plugins is called
<a href="http://en.wikipedia.org/wiki/Busser">Busser</a>.</p>

<pre><code>$ kitchen setup
-----&gt; Starting Kitchen (v1.0.0.beta.2)
-----&gt; Setting up &lt;default-centos-64&gt;
-----&gt; Setting up Busser
       Creating BUSSER_ROOT in /opt/busser
       Creating busser binstub
       Plugin serverspec already installed
       Finished setting up &lt;default-centos-64&gt; (0m12.21s).
-----&gt; Setting up &lt;default-ubuntu-1204&gt;
-----&gt; Setting up Busser
       Creating BUSSER_ROOT in /opt/busser
       Creating busser binstub
       Plugin serverspec already installed
       Finished setting up &lt;default-ubuntu-1204&gt; (0m2.26s).
-----&gt; Kitchen is finished. (0m19.04s)
</code></pre>

<p>After running <code>kitchen setup</code>, next run <code>kitchen verify</code> to run your test
suite.</p>

<pre><code>$ kitchen verify
-----&gt; Starting Kitchen (v1.0.0.beta.2)
-----&gt; Verifying &lt;default-centos-64&gt;
       Removing /opt/busser/suites/serverspec
       Uploading /opt/busser/suites/serverspec/localhost/webserver_spec.rb (mode=0644)
       Uploading /opt/busser/suites/serverspec/spec_helper.rb (mode=0644)
-----&gt; Running serverspec test suite
       /opt/chef/embedded/bin/ruby -I/opt/busser/suites/serverspec -S /opt/chef/embedded/bin/rspec /opt/busser/suites/serverspec/localhost/webserver_spec.rb
       .

       Finished in 0.00954 seconds
       1 example, 0 failures
       Finished verifying &lt;default-centos-64&gt; (0m1.98s).
-----&gt; Verifying &lt;default-ubuntu-1204&gt;
       Removing /opt/busser/suites/serverspec
Uploading /opt/busser/suites/serverspec/localhost/webserver_spec.rb (mode=0644)
Uploading /opt/busser/suites/serverspec/spec_helper.rb (mode=0644)
-----&gt; Running serverspec test suite
/opt/chef/embedded/bin/ruby -I/opt/busser/suites/serverspec -S /opt/chef/embedded/bin/rspec /opt/busser/suites/serverspec/localhost/webserver_spec.rb
.

Finished in 0.01468 seconds
1 example, 0 failures
       Finished verifying &lt;default-ubuntu-1204&gt; (0m1.90s).
-----&gt; Kitchen is finished. (0m7.68s)
</code></pre>

<p>Finally run <code>kitchen list</code> to display the results of your test run.</p>

<pre><code>$ kitchen list
Instance             Driver   Provisioner  Last Action
default-centos-64    Vagrant  Chef Solo    Verified
default-ubuntu-1204  Vagrant  Chef Solo    Verified
</code></pre>

<p>If Test Kitchen displays the <code>Last Action</code> as <code>Verified</code>, all the tests passed.</p>

<h1 id="iteration-17---completing-the-webserver-test-suite">Iteration #17 - Completing the webserver test suite</h1>

<p>Now let’s dive in and encode all the rest of the tests from
<a href="http://misheska.com/blog/2013/06/16/getting-started-writing-chef-cookbooks-the-berkshelf-way/">Part 1</a>.</p>

<p>While we used the <code>command</code> resource to encode our first test, this isn’t
the optimal way to encode this test as a serverspec.  </p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mischa Taylor</span></span>

      








  


<time datetime="2013-08-06T12:46:00-07:00" pubdate data-updated="true">Aug 6<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/chef/'>chef</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://misheska.com/blog/2013/08/06/getting-started-writing-chef-cookbooks-the-berkshelf-way-part3/" data-via="" data-counturl="http://misheska.com/blog/2013/08/06/getting-started-writing-chef-cookbooks-the-berkshelf-way-part3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/07/28/windows-server-2012-automated-install-settings/" title="Previous Post: Windows Server 2012 Automated Install Settings">&laquo; Windows Server 2012 Automated Install Settings</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/08/06/getting-started-writing-chef-cookbooks-the-berkshelf-way-part3/">Getting Started Writing Chef Cookbooks the Berkshelf Way, Part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/28/windows-server-2012-automated-install-settings/">Windows Server 2012 Automated Install Settings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/27/windows-8-automated-install-settings/">Windows 8 Automated Install Settings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/26/windows-7-automated-install-settings/">Windows 7 Automated Install Settings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/25/windows-server-2008-r2-automated-install-settings/">Windows Server 2008 R2 automated install settings</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/misheska">@misheska</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'misheska',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Mischa Taylor -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
